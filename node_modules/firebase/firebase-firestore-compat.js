!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Cf,Df){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Cf);function n(t){const n=[];let r=0;for(let s=0;s<t.length;s++){let e=t.charCodeAt(s);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++s)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let c=0;c<n.length;c+=3){var i=n[c],o=c+1<n.length,a=o?n[c+1]:0,h=c+2<n.length,u=h?n[c+2]:0;let e=(15&a)<<2|u>>6,t=63&u;h||(t=64,o||(e=64)),s.push(r[i>>2],r[(3&i)<<4|a>>4],r[e],r[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var s,i,o=e[n++];o<128?t[r++]=String.fromCharCode(o):191<o&&o<224?(s=e[n++],t[r++]=String.fromCharCode((31&o)<<6|63&s)):239<o&&o<365?(i=((7&o)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(s=e[n++],i=e[n++],t[r++]=String.fromCharCode((15&o)<<12|(63&s)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let h=0;h<e.length;){var s=n[e.charAt(h++)],i=h<e.length?n[e.charAt(h)]:0;++h;var o=h<e.length?n[e.charAt(h)]:64;++h;var a=h<e.length?n[e.charAt(h)]:64;if(++h,null==s||null==i||null==o||null==a)throw Error();r.push(s<<2|i>>4),64!==o&&(r.push(i<<4&240|o>>2),64!==a&&r.push(o<<6&192|a))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},o=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};function f(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class a extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,a.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,i.prototype.create)}}class i{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},s=`${this.service}/${e}`,i=this.errors[e],i=i?(r=n,i.replace(h,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",i=`${this.serviceName}: ${i} (${s}).`;return new a(s,i,n)}}const h=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class u{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Rl=l=l||{})[Rl.DEBUG=0]="DEBUG",Rl[Rl.VERBOSE=1]="VERBOSE",Rl[Rl.INFO=2]="INFO",Rl[Rl.WARN=3]="WARN",Rl[Rl.ERROR=4]="ERROR",Rl[Rl.SILENT=5]="SILENT";const c={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},d=l.INFO,g={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},p=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=g[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var y,v="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},w={},I=v||self;function b(){}function T(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function E(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var S="closure_uid_"+(1e9*Math.random()>>>0),_=0;function A(e,t,n){return e.call.apply(e.bind,arguments)}function x(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function N(e,t,n){return(N=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?A:x).apply(null,arguments)}function C(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function D(e,i){function t(){}t.prototype=i.prototype,e.Z=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Vb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function k(){this.s=this.s,this.o=this.o}var O={};k.prototype.s=!1,k.prototype.na=function(){var e,t;!this.s&&(this.s=!0,this.M(),0)&&(t=this,e=Object.prototype.hasOwnProperty.call(t,S)&&t[S]||(t[S]=++_),delete O[e])},k.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const R=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},L=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){var r=e.length,s="string"==typeof e?e.split(""):e;for(let i=0;i<r;i++)i in s&&t.call(n,s[i],i,e)};function M(){return Array.prototype.concat.apply([],arguments)}function P(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function F(e){return/^[\s\xa0]*$/.test(e)}var V,U=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function q(e,t){return-1!=e.indexOf(t)}function B(e,t){return e<t?-1:t<e?1:0}e:{var j=I.navigator;if(j){j=j.userAgent;if(j){V=j;break e}}V=""}function K(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function G(e){const t={};for(const n in e)t[n]=e[n];return t}var $="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Q(t){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(let e=0;e<$.length;e++)n=$[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function z(e){return z[" "](e),e}z[" "]=b;var H,W=q(V,"Opera"),Y=q(V,"Trident")||q(V,"MSIE"),X=q(V,"Edge"),J=X||Y,Z=q(V,"Gecko")&&!(q(V.toLowerCase(),"webkit")&&!q(V,"Edge"))&&!(q(V,"Trident")||q(V,"MSIE"))&&!q(V,"Edge"),ee=q(V.toLowerCase(),"webkit")&&!q(V,"Edge");function te(){var e=I.document;return e?e.documentMode:void 0}e:{var ne="",re=(re=V,Z?/rv:([^\);]+)(\)|;)/.exec(re):X?/Edge\/([\d\.]+)/.exec(re):Y?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(re):ee?/WebKit\/(\S+)/.exec(re):W?/(?:Version)[ \/]?(\S+)/.exec(re):void 0);if(re&&(ne=re?re[1]:""),Y){re=te();if(null!=re&&re>parseFloat(ne)){H=String(re);break e}}H=ne}var se={};function ie(){return e=function(){let e=0;var t=U(String(H)).split("."),n=U("9").split("."),r=Math.max(t.length,n.length);for(let o=0;0==e&&o<r;o++)for(var s=t[o]||"",i=n[o]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(e=B(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||B(0==s[2].length,0==i[2].length)||B(s[2],i[2]),s=s[3],i=i[3],0==e););return 0<=e},t=se,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=e(9);var e,t}var oe=I.document&&Y&&(te()||parseInt(H,10))||void 0,ae=function(){if(!I.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{I.addEventListener("test",b,t),I.removeEventListener("test",b,t)}catch(e){}return e}();function he(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}function ue(e,t){if(he.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Z){e:{try{z(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ce[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&ue.Z.h.call(this)}}he.prototype.h=function(){this.defaultPrevented=!0},D(ue,he);var ce={2:"touch",3:"pen",4:"mouse"};ue.prototype.h=function(){ue.Z.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var le="closure_listenable_"+(1e6*Math.random()|0),de=0;function fe(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ia=s,this.key=++de,this.ca=this.fa=!1}function ge(e){e.ca=!0,e.listener=null,e.proxy=null,e.src=null,e.ia=null}function me(e){this.src=e,this.g={},this.h=0}function pe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=R(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(ge(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function ye(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ca&&i.listener==t&&i.capture==!!n&&i.ia==r)return s}return-1}me.prototype.add=function(e,t,n,r,s){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var o=ye(e,t,r,s);return-1<o?(t=e[o],n||(t.fa=!1)):((t=new fe(t,this.src,i,!!r,s)).fa=n,e.push(t)),t};var ve="closure_lm_"+(1e6*Math.random()|0),we={};function Ie(e,t,n,r,s){if(r&&r.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var o=0;o<n.length;o++)e(t,n[o],r,s,i);return null}r=xe(r);return t&&t[le]?t.O(n,r,E(s)?!!s.capture:!!s,i):be(t,n,r,!0,s,i)}(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)Ie(e,t[i],n,r,s);return null}return n=xe(n),e&&e[le]?e.N(t,n,E(r)?!!r.capture:!!r,s):be(e,t,n,!1,r,s)}function be(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var o,a=E(s)?!!s.capture:!!s,h=_e(e);if(h||(e[ve]=h=new me(e)),(n=h.add(t,n,r,a,i)).proxy)return n;if(o=Se,r=function e(t){return o.call(e.src,e.listener,t)},(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=!ae?a:s)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(Ee(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Te(e){var t,n,r;"number"!=typeof e&&e&&!e.ca&&((t=e.src)&&t[le]?pe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Ee(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=_e(t))?(pe(n,e),0==n.h&&(n.src=null,t[ve]=null)):ge(e)))}function Ee(e){return e in we?we[e]:we[e]="on"+e}function Se(e,t){var n,r;return e=!!e.ca||(t=new ue(t,this),n=e.listener,r=e.ia||e.src,e.fa&&Te(e),n.call(r,t))}function _e(e){return(e=e[ve])instanceof me?e:null}var Ae="__closure_events_fn_"+(1e9*Math.random()>>>0);function xe(t){return"function"==typeof t?t:(t[Ae]||(t[Ae]=function(e){return t.handleEvent(e)}),t[Ae])}function Ne(){k.call(this),this.i=new me(this),(this.P=this).I=null}function Ce(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new he(t,e):t instanceof he?t.target=t.target||e:(o=t,Q(t=new he(r,e),o)),o=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],o=De(i,r,!0,t)&&o;if(o=De(i=t.g=e,r,!0,t)&&o,o=De(i,r,!1,t)&&o,n)for(s=0;s<n.length;s++)o=De(i=t.g=n[s],r,!1,t)&&o}function De(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var o,a,h=t[i];h&&!h.ca&&h.capture==n&&(o=h.listener,a=h.ia||h.src,h.fa&&pe(e.i,h),s=!1!==o.call(a,r)&&s)}return s&&!r.defaultPrevented}D(Ne,k),Ne.prototype[le]=!0,Ne.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var o=0;o<n.length;o++)e(t,n[o],r,s,i);else s=E(s)?!!s.capture:!!s,r=xe(r),t&&t[le]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=ye(o=t.g[n],r,s,i))&&(ge(o[r]),Array.prototype.splice.call(o,r,1),0==o.length&&(delete t.g[n],t.h--))):(t=t&&_e(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?ye(n,r,s,i):t)?n[t]:null)&&Te(r))}(this,e,t,n,r)},Ne.prototype.M=function(){if(Ne.Z.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ge(n[r]);delete t.g[e],t.h--}}this.I=null},Ne.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Ne.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var ke=I.JSON.stringify;var Oe,Re=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Le,e=>e.reset());class Le{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Me(e,t){var n;Oe||(n=I.Promise.resolve(void 0),Oe=function(){n.then(Ve)}),Pe||(Oe(),Pe=!0),Fe.add(e,t)}var Pe=!1,Fe=new class{constructor(){this.h=this.g=null}add(e,t){const n=Re.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Ve(){for(var e;e=function(){var e=Fe;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){I.setTimeout(()=>{throw e},0)}(e)}var t=Re;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Pe=!1}function Ue(e,t){Ne.call(this),this.h=e||1,this.g=t||I,this.j=N(this.kb,this),this.l=Date.now()}function qe(e){e.da=!1,e.S&&(e.g.clearTimeout(e.S),e.S=null)}function Be(e,t,n){if("function"==typeof e)n&&(e=N(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=N(e.handleEvent,e)}return 2147483647<Number(t)?-1:I.setTimeout(e,t||0)}D(Ue,Ne),(y=Ue.prototype).da=!1,y.S=null,y.kb=function(){var e;this.da&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-e):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Ce(this,"tick"),this.da&&(qe(this),this.start())))},y.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},y.M=function(){Ue.Z.M.call(this),qe(this),delete this.g};class je extends k{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Be(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(I.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ke(e){k.call(this),this.h=e,this.g={}}D(Ke,k);var Ge=[];function $e(e,t,n,r){Array.isArray(n)||(n&&(Ge[0]=n.toString()),n=Ge);for(var s=0;s<n.length;s++){var i=Ie(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function Qe(e){K(e.g,function(e,t){this.g.hasOwnProperty(t)&&Te(e)},e),e.g={}}function ze(){this.g=!0}function He(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return ke(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ke.prototype.M=function(){Ke.Z.M.call(this),Qe(this)},Ke.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ze.prototype.Aa=function(){this.g=!1},ze.prototype.info=function(){};var We={},Ye=null;function Xe(){return Ye=Ye||new Ne}function Je(e){he.call(this,We.Ma,e)}function Ze(){var e=Xe();Ce(e,new Je(e))}function et(e,t){he.call(this,We.STAT_EVENT,e),this.stat=t}function tt(e){var t=Xe();Ce(t,new et(t,e))}function nt(e,t){he.call(this,We.Na,e),this.size=t}function rt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return I.setTimeout(function(){e()},t)}We.Ma="serverreachability",D(Je,he),We.STAT_EVENT="statevent",D(et,he),We.Na="timingevent",D(nt,he);var st={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},it={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function ot(){}function at(e){return e.h||(e.h=e.i())}function ht(){}ot.prototype.h=null;v={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ut(){he.call(this,"d")}function ct(){he.call(this,"c")}function lt(){}function dt(e,t,n,r){this.l=e,this.j=t,this.m=n,this.X=r||1,this.V=new Ke(this),this.P=mt,this.W=new Ue(e=J?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ft}function ft(){this.i=null,this.g="",this.h=!1}D(ut,he),D(ct,he),D(lt,ot),lt.prototype.g=function(){return new XMLHttpRequest},lt.prototype.i=function(){return{}};var gt=new lt,mt=45e3,pt={},yt={};function vt(e,t,n){e.K=1,e.v=qt(Lt(t)),e.s=n,e.U=!0,wt(e,null)}function wt(e,t){e.F=Date.now(),Tt(e),e.A=Lt(e.v);var o,a,h,u,c,l,n=e.A,r=e.X;Array.isArray(r)||(r=[String(r)]),Zt(n.h,"t",r),e.C=0,n=e.l.H,e.h=new ft,e.g=er(e.l,n?t:null,!e.s),0<e.O&&(e.L=new je(N(e.Ia,e,e.g),e.O)),$e(e.V,e.g,"readystatechange",e.gb),t=e.H?G(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.s,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Ze(),o=e.j,a=e.u,h=e.A,u=e.m,c=e.X,l=e.s,o.info(function(){if(o.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+u+") [attempt "+c+"]: "+a+"\n"+h+"\n"+e})}function It(e){return e.g&&("GET"==e.u&&2!=e.K&&e.l.Ba)}function bt(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if(s=(o=n,h=a=void 0,a=(i=e).C,-1==(h=o.indexOf("\n",a))?yt:(a=Number(o.substring(a,h)),isNaN(a)?pt:(h+=1)+a>o.length?yt:(o=o.substr(h,a),i.C=h+a,o))),s==yt){4==t&&(e.o=4,tt(14),r=!1),He(e.j,e.m,null,"[Incomplete Response]");break}if(s==pt){e.o=4,tt(15),He(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}He(e.j,e.m,s,null),xt(e,s)}var i,o,a,h;It(e)&&s!=yt&&s!=pt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,tt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.aa&&(e.aa=!0,(t=e.l).g==e&&t.$&&!t.L&&(t.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Qn(t),t.L=!0,tt(11))):(He(e.j,e.m,n,"[Invalid Chunked Response]"),At(e),_t(e))}function Tt(e){e.Y=Date.now()+e.P,Et(e,e.P)}function Et(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=rt(N(e.eb,e),t)}function St(e){e.B&&(I.clearTimeout(e.B),e.B=null)}function _t(e){0==e.l.G||e.I||Wn(e.l,e)}function At(e){St(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,qe(e.W),Qe(e.V),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function xt(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||an(n.i,e)))if(n.I=e.N,!e.J&&an(n.i,e)&&3==n.G){try{var r=n.Ca.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;Hn(n),Fn(n)}$n(n),tt(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=rt(N(n.ab,n),6e3));if(on(n.i)<=1&&n.ka){try{n.ka()}catch(e){}n.ka=void 0}}else Xn(n,11)}else if(!e.J&&n.g!=e||Hn(n),!F(t))for(s=n.Ca.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var o=i[3];null!=o&&(n.ma=o,n.h.info("VER="+n.ma));var a=i[4];null!=a&&(n.za=a,n.h.info("SVER="+n.za));var h,u,c,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=e.g;m&&(!(h=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(u=r.i).g&&(q(h,"spdy")||q(h,"quic")||q(h,"h2"))&&(u.j=u.l,u.g=new Set,u.h&&(hn(u,u.h),u.h=null)),!r.D||(c=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=c,Ut(r.F,r.D,c))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-e.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=e;(r=n).oa=Zn(r,r.H?r.la:null,r.W),g.J?(un(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(St(d),Tt(d)),r.g=g):Gn(r),0<n.l.length&&qn(n)}else"stop"!=i[0]&&"close"!=i[0]||Xn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Xn(n,7):Pn(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Ze()}catch(e){}}function Nt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(T(e)||"string"==typeof e)L(e,t,void 0);else{if(e.T&&"function"==typeof e.T)var n=e.T();else if(e.R&&"function"==typeof e.R)n=void 0;else if(T(e)||"string"==typeof e)for(var n=[],r=e.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,e)n[r++]=s;for(var s=(r=function(e){if(e.R&&"function"==typeof e.R)return e.R();if("string"==typeof e)return e.split("");if(T(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e)).length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}}function Ct(e,t){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof Ct)for(n=e.T(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function Dt(e){if(e.i!=e.g.length){for(var t=0,n=0;t<e.g.length;){var r=e.g[t];kt(e.h,r)&&(e.g[n++]=r),t++}e.g.length=n}if(e.i!=e.g.length){for(var s={},n=t=0;t<e.g.length;)kt(s,r=e.g[t])||(s[e.g[n++]=r]=1),t++;e.g.length=n}}function kt(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(y=dt.prototype).setTimeout=function(e){this.P=e},y.gb=function(e){e=e.target;const t=this.L;t&&3==kn(e)?t.l():this.Ia(e)},y.Ia=function(e){try{if(e==this.g)e:{var t=kn(this.g),n=this.g.Da();this.g.ba();if(!(t<3)&&(3!=t||J||this.g&&(this.h.h||this.g.ga()||On(this.g)))){this.I||4!=t||7==n||Ze(),St(this);var r=this.g.ba();this.N=r;t:if(It(this)){var s=On(this.g);e="";var i=s.length,o=4==kn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){At(this),_t(this);var a="";break t}this.h.i=new I.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:o&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,a=this.h.g}else a=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){t:{if(this.g){var h,u=this.g;if((h=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!F(h)){var c=h;break t}}c=null}if(!(r=c)){this.i=!1,this.o=3,tt(12),At(this),_t(this);break e}He(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,xt(this,r)}this.U?(bt(this,t,a),J&&this.i&&3==t&&($e(this.V,this.W,"tick",this.fb),this.W.start())):(He(this.j,this.m,a,null),xt(this,a)),4==t&&At(this),this.i&&!this.I&&(4==t?Wn(this.l,this):(this.i=!1,Tt(this)))}else 400==r&&0<a.indexOf("Unknown SID")?(this.o=3,tt(12)):(this.o=0,tt(13)),At(this),_t(this)}}}catch(e){}var l,d,f,g,m,p,y},y.fb=function(){var e,t;this.g&&(e=kn(this.g),t=this.g.ga(),this.C<t.length&&(St(this),bt(this,e,t),this.i&&4!=e&&Tt(this)))},y.cancel=function(){this.I=!0,At(this)},y.eb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(Ze(),tt(17)),At(this),this.o=2,_t(this)):Et(this,this.Y-n)},(y=Ct.prototype).R=function(){Dt(this);for(var e=[],t=0;t<this.g.length;t++)e.push(this.h[this.g[t]]);return e},y.T=function(){return Dt(this),this.g.concat()},y.get=function(e,t){return kt(this.h,e)?this.h[e]:t},y.set=function(e,t){kt(this.h,e)||(this.i++,this.g.push(e)),this.h[e]=t},y.forEach=function(e,t){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);e.call(t,i,s,this)}};var Ot=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Rt(e,t){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,e instanceof Rt?(this.g=void 0!==t?t:e.g,Mt(this,e.j),this.s=e.s,Pt(this,e.i),Ft(this,e.m),this.l=e.l,t=e.h,(n=new Wt).i=t.i,t.g&&(n.g=new Ct(t.g),n.h=t.h),Vt(this,n),this.o=e.o):e&&(n=String(e).match(Ot))?(this.g=!!t,Mt(this,n[1]||"",!0),this.s=Bt(n[2]||""),Pt(this,n[3]||"",!0),Ft(this,n[4]),this.l=Bt(n[5]||"",!0),Vt(this,n[6]||"",!0),this.o=Bt(n[7]||"")):(this.g=!!t,this.h=new Wt(null,this.g))}function Lt(e){return new Rt(e)}function Mt(e,t,n){e.j=n?Bt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Pt(e,t,n){e.i=n?Bt(t,!0):t}function Ft(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Vt(e,t,n){var r,s;t instanceof Wt?(e.h=t,r=e.h,(s=e.g)&&!r.j&&(Yt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Xt(this,t),Zt(this,n,e))},r)),r.j=s):(n||(t=jt(t,zt)),e.h=new Wt(t,e.g))}function Ut(e,t,n){e.h.set(t,n)}function qt(e){return Ut(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Bt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function jt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Kt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Kt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Rt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(jt(t,Gt,!0),":");var n=this.i;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(jt(t,Gt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&e.push("/"),e.push(jt(n,"/"==n.charAt(0)?Qt:$t,!0))),(n=this.h.toString())&&e.push("?",n),(n=this.o)&&e.push("#",jt(n,Ht)),e.join("")};var Gt=/[#\/\?@]/g,$t=/[#\?:]/g,Qt=/[#\?]/g,zt=/[#\?@]/g,Ht=/#/g;function Wt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Yt(n){n.g||(n.g=new Ct,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,s=e[n].indexOf("="),i=null;0<=s?(r=e[n].substring(0,s),i=e[n].substring(s+1)):r=e[n],t(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Xt(e,t){Yt(e),t=en(e,t),kt(e.g.h,t)&&(e.i=null,e.h-=e.g.get(t).length,kt((e=e.g).h,t)&&(delete e.h[t],e.i--,e.g.length>2*e.i&&Dt(e)))}function Jt(e,t){return Yt(e),t=en(e,t),kt(e.g.h,t)}function Zt(e,t,n){Xt(e,t),0<n.length&&(e.i=null,e.g.set(en(e,t),P(n)),e.h+=n.length)}function en(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(y=Wt.prototype).add=function(e,t){Yt(this),this.i=null,e=en(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},y.forEach=function(n,r){Yt(this),this.g.forEach(function(e,t){L(e,function(e){n.call(r,e,t,this)},this)},this)},y.T=function(){Yt(this);for(var e=this.g.R(),t=this.g.T(),n=[],r=0;r<t.length;r++)for(var s=e[r],i=0;i<s.length;i++)n.push(t[r]);return n},y.R=function(e){Yt(this);var t=[];if("string"==typeof e)Jt(this,e)&&(t=M(t,this.g.get(en(this,e))));else{e=this.g.R();for(var n=0;n<e.length;n++)t=M(t,e[n])}return t},y.set=function(e,t){return Yt(this),this.i=null,Jt(this,e=en(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},y.get=function(e,t){return e&&0<(e=this.R(e)).length?String(e[0]):t},y.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var e=[],t=this.g.T(),n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var o=s;""!==r[i]&&(o+="="+encodeURIComponent(String(r[i]))),e.push(o)}return this.i=e.join("&")};var tn=class{constructor(e,t){this.h=e,this.g=t}};function nn(e){this.l=e||10,e=I.PerformanceNavigationTiming?0<(e=I.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(I.g&&I.g.Ea&&I.g.Ea()&&I.g.Ea().Zb),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var rn;function sn(e){return e.h||e.g&&e.g.size>=e.j}function on(e){return e.h?1:e.g?e.g.size:0}function an(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function hn(e,t){e.g?e.g.add(t):e.h=t}function un(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function cn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return P(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function ln(){}function dn(){this.g=new ln}function fn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function gn(e){this.l=e.$b||null,this.j=e.ib||!1}function mn(e,t){Ne.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=pn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}nn.prototype.cancel=function(){if(this.i=cn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},ln.prototype.stringify=function(e){return I.JSON.stringify(e,void 0)},ln.prototype.parse=function(e){return I.JSON.parse(e,void 0)},D(gn,ot),gn.prototype.g=function(){return new mn(this.l,this.j)},gn.prototype.i=(rn={},function(){return rn}),D(mn,Ne);var pn=0;function yn(e){e.j.read().then(e.Sa.bind(e)).catch(e.ha.bind(e))}function vn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,wn(e)}function wn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(y=mn.prototype).open=function(e,t){if(this.readyState!=pn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,wn(this)},y.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||I).fetch(new Request(this.B,t)).then(this.Va.bind(this),this.ha.bind(this))},y.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,vn(this)),this.readyState=pn},y.Va=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,wn(this)),this.g&&(this.readyState=3,wn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==I.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;yn(this)}else e.text().then(this.Ua.bind(this),this.ha.bind(this))},y.Sa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?vn:wn)(this),3==this.readyState&&yn(this))},y.Ua=function(e){this.g&&(this.response=this.responseText=e,vn(this))},y.Ta=function(e){this.g&&(this.response=e,vn(this))},y.ha=function(){this.g&&vn(this)},y.setRequestHeader=function(e,t){this.v.append(e,t)},y.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},y.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(mn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var In=I.JSON.parse;function bn(e){Ne.call(this),this.headers=new Ct,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Tn,this.K=this.L=!1}D(bn,Ne);var Tn="",En=/^https?$/i,Sn=["POST","PUT"];function _n(e){return"content-type"==e.toLowerCase()}function An(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,xn(e),Cn(e)}function xn(e){e.D||(e.D=!0,Ce(e,"complete"),Ce(e,"error"))}function Nn(e){if(e.h&&void 0!==w&&(!e.C[1]||4!=kn(e)||2!=e.ba()))if(e.v&&4==kn(e))Be(e.Fa,0,e);else if(Ce(e,"readystatechange"),4==kn(e)){e.h=!1;try{var t,n,r,s,i=e.ba();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break e;default:o=!1}if((t=o)||((n=0===i)&&(!(s=String(e.H).match(Ot)[1]||null)&&I.self&&I.self.location&&(s=(r=I.self.location.protocol).substr(0,r.length-1)),n=!En.test(s?s.toLowerCase():"")),t=n),t)Ce(e,"complete"),Ce(e,"success");else{e.m=6;try{var a=2<kn(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.ba()+"]",xn(e)}}finally{Cn(e)}}}function Cn(e,t){if(e.g){Dn(e);const n=e.g,r=e.C[0]?b:null;e.g=null,e.C=null,t||Ce(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Dn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(I.clearTimeout(e.A),e.A=null)}function kn(e){return e.g?e.g.readyState:0}function On(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case Tn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Rn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=function(e){let n="";return K(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Ut(e,t,n))}function Ln(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Mn(e){this.za=0,this.l=[],this.h=new ze,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Ln("failFast",!1,e),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Ln("baseRetryDelayMs",5e3,e),this.$a=Ln("retryDelaySeedMs",1e4,e),this.Ya=Ln("forwardChannelMaxRetries",2,e),this.ra=Ln("forwardChannelRequestTimeoutMs",2e4,e),this.qa=e&&e.xmlHttpFactory||void 0,this.Ba=e&&e.Yb||!1,this.K=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.J="",this.i=new nn(e&&e.concurrentRequestLimit),this.Ca=new dn,this.ja=e&&e.fastHandshake||!1,this.Ra=e&&e.Wb||!1,e&&e.Aa&&this.h.Aa(),e&&e.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&e&&e.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!e||!1!==e.Xb}function Pn(e){var t,n;Vn(e),3==e.G&&(t=e.V++,Ut(n=Lt(e.F),"SID",e.J),Ut(n,"RID",t),Ut(n,"TYPE","terminate"),jn(e,n),(t=new dt(e,e.h,t,void 0)).K=2,t.v=qt(Lt(n)),n=!1,!(n=I.navigator&&I.navigator.sendBeacon?I.navigator.sendBeacon(t.v.toString(),""):n)&&I.Image&&((new Image).src=t.v,n=!0),n||(t.g=er(t.l,null),t.g.ea(t.v)),t.F=Date.now(),Tt(t)),Jn(e)}function Fn(e){e.g&&(Qn(e),e.g.cancel(),e.g=null)}function Vn(e){Fn(e),e.u&&(I.clearTimeout(e.u),e.u=null),Hn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&I.clearTimeout(e.m),e.m=null)}function Un(e,t){e.l.push(new tn(e.Za++,t)),3==e.G&&qn(e)}function qn(e){sn(e.i)||e.m||(e.m=!0,Me(e.Ha,e),e.C=0)}function Bn(e,t){var n=t?t.m:e.V++,r=Lt(e.F);Ut(r,"SID",e.J),Ut(r,"RID",n),Ut(r,"AID",e.U),jn(e,r),e.o&&e.s&&Rn(r,e.o,e.s),n=new dt(e,e.h,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.l=t.D.concat(e.l)),t=Kn(e,n,1e3),n.setTimeout(Math.round(.5*e.ra)+Math.round(.5*e.ra*Math.random())),hn(e.i,n),vt(n,r,t)}function jn(e,n){e.j&&Nt({},function(e,t){Ut(n,t,e)})}function Kn(e,t,r){r=Math.min(e.l.length,r);var s=e.j?N(e.j.Oa,e.j,e):null;e:{var i=e.l;let n=-1;for(;;){const h=["count="+r];-1==n?0<r?(n=i[0].h,h.push("ofs="+n)):n=0:h.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var o=i[t].h,a=i[t].g;if((o-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(e,r,t){const s=t||"";try{Nt(e,function(e,t){let n=e;E(e)&&(n=ke(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(a,h,"req"+o+"_")}catch(e){s&&s(a)}}if(e){s=h.join("&");break e}}}return e=e.l.splice(0,r),t.D=e,s}function Gn(e){e.g||e.u||(e.Y=1,Me(e.Ga,e),e.A=0)}function $n(e){return!(e.g||e.u||3<=e.A)&&(e.Y++,e.u=rt(N(e.Ga,e),Yn(e,e.A)),e.A++,1)}function Qn(e){null!=e.B&&(I.clearTimeout(e.B),e.B=null)}function zn(e){e.g=new dt(e,e.h,"rpc",e.Y),null===e.o&&(e.g.H=e.s),e.g.O=0;var t=Lt(e.oa);Ut(t,"RID","rpc"),Ut(t,"SID",e.J),Ut(t,"CI",e.N?"0":"1"),Ut(t,"AID",e.U),jn(e,t),Ut(t,"TYPE","xmlhttp"),e.o&&e.s&&Rn(t,e.o,e.s),e.K&&e.g.setTimeout(e.K);var n=e.g;e=e.la,n.K=1,n.v=qt(Lt(t)),n.s=null,n.U=!0,wt(n,e)}function Hn(e){null!=e.v&&(I.clearTimeout(e.v),e.v=null)}function Wn(e,t){var n,r,s,i=null;if(e.g==t){Hn(e),Qn(e),e.g=null;var o=2}else{if(!an(e.i,t))return;i=t.D,un(e.i,t),o=1}if(e.I=t.N,0!=e.G)if(t.i)1==o?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Ce(o=Xe(),new nt(o,i)),qn(e)):Gn(e);else if(3==(n=t.o)||0==n&&0<e.I||(1!=o||(s=t,on((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=rt(N(r.Ha,r,s),Yn(r,r.C)),r.C++,0))))&&(2!=o||!$n(e)))switch(i&&0<i.length&&(t=e.i,t.i=t.i.concat(i)),n){case 1:Xn(e,5);break;case 4:Xn(e,10);break;case 3:Xn(e,6);break;default:Xn(e,2)}}function Yn(e,t){let n=e.Pa+Math.floor(Math.random()*e.$a);return e.j||(n*=2),n*t}function Xn(e,t){var n,r;e.h.info("Error code "+t),2==t?(n=null,e.j&&(n=null),r=N(e.jb,e),n||(n=new Rt("//www.google.com/images/cleardot.gif"),I.location&&"http"==I.location.protocol||Mt(n,"https"),qt(n)),function(e,t){var n=new ze;if(I.Image){const r=new Image;r.onload=C(fn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=C(fn,n,r,"TestLoadImage: error",!1,t),r.onabort=C(fn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=C(fn,n,r,"TestLoadImage: timeout",!1,t),I.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):tt(2),e.G=0,e.j&&e.j.va(t),Jn(e),Vn(e)}function Jn(e){e.G=0,e.I=-1,e.j&&(0==cn(e.i).length&&0==e.l.length||(e.i.i.length=0,P(e.l),e.l.length=0),e.j.ua())}function Zn(e,t,n){let r=(a=n)instanceof Rt?Lt(a):new Rt(a,void 0);var s,i,o,a,h;return""!=r.i?(t&&Pt(r,t+"."+r.i),Ft(r,r.m)):(h=I.location,r=(s=h.protocol,i=t?t+"."+h.hostname:h.hostname,o=+h.port,a=n,h=new Rt(null,void 0),s&&Mt(h,s),i&&Pt(h,i),o&&Ft(h,o),a&&(h.l=a),h)),e.aa&&K(e.aa,function(e,t){Ut(r,t,e)}),t=e.D,n=e.sa,t&&n&&Ut(r,t,n),Ut(r,"VER",e.ma),jn(e,r),r}function er(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ba&&!e.qa?new bn(new gn({ib:!0})):new bn(e.qa)).L=e.H,t}function tr(){}function nr(){if(Y&&!(10<=Number(oe)))throw Error("Environmental error: no available transport.")}function rr(e,t){Ne.call(this),this.g=new Mn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.P=e,(e=t&&t.httpHeadersOverwriteParam)&&!F(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!F(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new or(this)}function sr(e){ut.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function ir(){ct.call(this),this.status=1}function or(e){this.g=e}(y=bn.prototype).ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||gt).g(),this.C=this.u?at(this.u):at(gt),this.g.onreadystatechange=N(this.Fa,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void An(this,e)}e=n||"";const s=new Ct(this.headers);r&&Nt(r,function(e,t){s.set(t,e)}),r=function(t){e:{var n=_n,r=t.length,s="string"==typeof t?t.split(""):t;for(let e=0;e<r;e++)if(e in s&&n.call(void 0,s[e],e,t)){n=e;break e}n=-1}return n<0?null:"string"==typeof t?t.charAt(n):t[n]}(s.T()),n=I.FormData&&e instanceof I.FormData,0<=R(Sn,t)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(e,t){this.g.setRequestHeader(t,e)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Dn(this),0<this.B&&((this.K=(i=this.g,Y&&ie()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=N(this.pa,this)):this.A=Be(this.pa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){An(this,e)}var i},y.pa=function(){void 0!==w&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Ce(this,"timeout"),this.abort(8))},y.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Ce(this,"complete"),Ce(this,"abort"),Cn(this))},y.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Cn(this,!0)),bn.Z.M.call(this)},y.Fa=function(){this.s||(this.F||this.v||this.l?Nn(this):this.cb())},y.cb=function(){Nn(this)},y.ba=function(){try{return 2<kn(this)?this.g.status:-1}catch(e){return-1}},y.ga=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},y.Qa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),In(t)}},y.Da=function(){return this.m},y.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(y=Mn.prototype).ma=8,y.G=1,y.hb=function(e){try{this.h.info("Origin Trials invoked: "+e)}catch(e){}},y.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const i=new dt(this,this.h,t,void 0);let e=this.s;if(this.P&&(e?(e=G(e),Q(e,this.P)):e=this.P),null===this.o&&(i.H=e),this.ja)e:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.l.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Kn(this,i,n),Ut(r=Lt(this.F),"RID",t),Ut(r,"CVER",22),this.D&&Ut(r,"X-HTTP-Session-Id",this.D),jn(this,r),this.o&&e&&Rn(r,this.o,e),hn(this.i,i),this.Ra&&Ut(r,"TYPE","init"),this.ja?(Ut(r,"$req",n),Ut(r,"SID","null"),i.$=!0,vt(i,r,null)):vt(i,r,n),this.G=2}}else 3==this.G&&(t?Bn(this,t):0==this.l.length||sn(this.i)||Bn(this))},y.Ga=function(){var e;this.u=null,zn(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(e=2*this.O,this.h.info("BP detection timer enabled: "+e),this.B=rt(N(this.bb,this),e))},y.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,tt(10),Fn(this),zn(this))},y.ab=function(){null!=this.v&&(this.v=null,Fn(this),$n(this),tt(19))},y.jb=function(e){e?(this.h.info("Successfully pinged google.com"),tt(2)):(this.h.info("Failed to ping google.com"),tt(1))},(y=tr.prototype).xa=function(){},y.wa=function(){},y.va=function(){},y.ua=function(){},y.Oa=function(){},nr.prototype.g=function(e,t){return new rr(e,t)},D(rr,Ne),rr.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;e.Wa&&(e.h.info("Origin Trials enabled."),Me(N(e.hb,e,t))),tt(0),e.W=t,e.aa=n||{},e.N=e.X,e.F=Zn(e,null,e.W),qn(e)},rr.prototype.close=function(){Pn(this.g)},rr.prototype.u=function(e){var t;"string"==typeof e?((t={}).__data__=e,Un(this.g,t)):this.v?((t={}).__data__=ke(e),Un(this.g,t)):Un(this.g,e)},rr.prototype.M=function(){this.g.j=null,delete this.j,Pn(this.g),delete this.g,rr.Z.M.call(this)},D(sr,ut),D(ir,ct),D(or,tr),or.prototype.xa=function(){Ce(this.g,"a")},or.prototype.wa=function(e){Ce(this.g,new sr(e))},or.prototype.va=function(e){Ce(this.g,new ir)},or.prototype.ua=function(){Ce(this.g,"b")},nr.prototype.createWebChannel=nr.prototype.g,rr.prototype.send=rr.prototype.u,rr.prototype.open=rr.prototype.m,st.NO_ERROR=0,st.TIMEOUT=8,st.HTTP_ERROR=6,it.COMPLETE="complete",(ht.EventType=v).OPEN="a",v.CLOSE="b",v.ERROR="c",v.MESSAGE="d",Ne.prototype.listen=Ne.prototype.N,bn.prototype.listenOnce=bn.prototype.O,bn.prototype.getLastError=bn.prototype.La,bn.prototype.getLastErrorCode=bn.prototype.Da,bn.prototype.getStatus=bn.prototype.ba,bn.prototype.getResponseJson=bn.prototype.Qa,bn.prototype.getResponseText=bn.prototype.ga,bn.prototype.send=bn.prototype.ea;var ar,hr=Xe,ur=st,cr=it,lr=We,dr=10,fr=11,gr=gn,mr=ht,pr=bn;const yr="@firebase/firestore";class vr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}vr.UNAUTHENTICATED=new vr(null),vr.GOOGLE_CREDENTIALS=new vr("google-credentials-uid"),vr.FIRST_PARTY=new vr("first-party-uid"),vr.MOCK_USER=new vr("mock-user");let wr="9.6.7";const Ir=new class{constructor(e){this.name=e,this._logLevel=d,this._logHandler=p,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?c[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function br(){return Ir.logLevel}function Tr(e,...t){var n;Ir.logLevel<=l.DEBUG&&(n=t.map(_r),Ir.debug(`Firestore (${wr}): ${e}`,...n))}function Er(e,...t){var n;Ir.logLevel<=l.ERROR&&(n=t.map(_r),Ir.error(`Firestore (${wr}): ${e}`,...n))}function Sr(e,...t){var n;Ir.logLevel<=l.WARN&&(n=t.map(_r),Ir.warn(`Firestore (${wr}): ${e}`,...n))}function _r(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Ar(e="Unexpected state"){var t=`FIRESTORE (${wr}) INTERNAL ASSERTION FAILED: `+e;throw Er(t),new Error(t)}function xr(e){e||Ar()}const Nr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Cr extends a{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Dr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class kr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Or{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(vr.UNAUTHENTICATED))}shutdown(){}}class Rr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Lr{constructor(e){this.t=e,this.currentUser=vr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Dr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Dr,t.enqueueRetryable(()=>s(this.currentUser))};const o=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},a=e=>{Tr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(e=>a(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?a(e):(Tr("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Dr))},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Tr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(xr("string"==typeof e.accessToken),new kr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return xr(null===e||"string"==typeof e),new vr(e)}}class Mr{constructor(e,t,n){this.type="FirstParty",this.user=vr.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);var r=e.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Pr{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new Mr(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable(()=>t(vr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Fr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Vr{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(t,n){const r=e=>{null!=e.error&&Tr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.p;return this.p=e.token,Tr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const s=e=>{Tr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.g.getImmediate({optional:!0}))?s(e):Tr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(xr("string"==typeof e.token),this.p=e.token,new Fr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Ur{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.I(e),this.T=e=>t.writeSequenceNumber(e))}I(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.T&&this.T(e),e}}Ur.A=-1;class qr{static R(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function Br(e,t){return e<t?-1:t<e?1:0}function jr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function Kr(e){return e+"\0"}class Gr{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Cr(Nr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Cr(Nr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Cr(Nr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Cr(Nr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Gr.fromMillis(Date.now())}static fromDate(e){return Gr.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Gr(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Br(this.nanoseconds,e.nanoseconds):Br(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class $r{constructor(e){this.timestamp=e}static fromTimestamp(e){return new $r(e)}static min(){return new $r(new Gr(0,0))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Qr(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function zr(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Hr(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Wr{constructor(e,t,n){void 0===t?t=0:t>e.length&&Ar(),void 0===n?n=e.length-t:n>e.length-t&&Ar(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Wr.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Wr?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Yr extends Wr{construct(e,t,n){return new Yr(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new Yr(t)}static emptyPath(){return new Yr([])}}const Xr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Jr extends Wr{construct(e,t,n){return new Jr(e,t,n)}static isValidIdentifier(e){return Xr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!Jr.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Jr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Cr(Nr.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Cr(Nr.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Cr(Nr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new Cr(Nr.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Jr(t)}static emptyPath(){return new Jr([])}}class Zr{constructor(e){(this.fields=e).sort(Jr.comparator)}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return jr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class es{constructor(e){this.binaryString=e}static fromBase64String(e){var t=atob(e);return new es(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new es(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Br(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}es.EMPTY_BYTE_STRING=new es("");const ts=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ns(t){if(xr(!!t),"string"!=typeof t)return{seconds:rs(t.seconds),nanos:rs(t.nanos)};{let e=0;var n=ts.exec(t);xr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function rs(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ss(e){return"string"==typeof e?es.fromBase64String(e):es.fromUint8Array(e)}function is(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function os(e){var t=ns(e.mapValue.fields.__local_write_time__.timestampValue);return new Gr(t.seconds,t.nanos)}class as{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class hs{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new hs("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof hs&&e.projectId===this.projectId&&e.database===this.database}}function us(e){return null==e}function cs(e){return 0===e&&1/e==-1/0}function ls(e){return"number"==typeof e&&Number.isInteger(e)&&!cs(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}class ds{constructor(e){this.path=e}static fromPath(e){return new ds(Yr.fromString(e))}static fromName(e){return new ds(Yr.fromString(e).popFirst(5))}static empty(){return new ds(Yr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Yr.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Yr.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new ds(new Yr(e.slice()))}}const fs={mapValue:{fields:{__type__:{stringValue:"__max___"}}}};function gs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?is(e)?4:10:Ar()}function ms(r,s){if(r===s)return!0;var e,t,n=gs(r);if(n!==gs(s))return!1;switch(n){case 0:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return os(r).isEqual(os(s));case 3:return function(e){if("string"==typeof r.timestampValue&&"string"==typeof e.timestampValue&&r.timestampValue.length===e.timestampValue.length)return r.timestampValue===e.timestampValue;var t=ns(r.timestampValue),n=ns(e.timestampValue);return t.seconds===n.seconds&&t.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return t=s,ss(r.bytesValue).isEqual(ss(t.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return e=s,rs((t=r).geoPointValue.latitude)===rs(e.geoPointValue.latitude)&&rs(t.geoPointValue.longitude)===rs(e.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return rs(e.integerValue)===rs(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=rs(e.doubleValue),r=rs(t.doubleValue);return n===r?cs(n)===cs(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return jr(r.arrayValue.values||[],s.arrayValue.values||[],ms);case 10:return function(e){const t=e.mapValue.fields||{},n=s.mapValue.fields||{};if(Qr(t)!==Qr(n))return!1;for(const e in t)if(t.hasOwnProperty(e)&&(void 0===n[e]||!ms(t[e],n[e])))return!1;return!0}(r);default:return Ar()}}function ps(e,t){return void 0!==(e.values||[]).find(e=>ms(e,t))}function ys(e,t){if(e===t)return 0;var n,r,s,i,o=gs(e),a=gs(t);if(o!==a)return Br(o,a);switch(o){case 0:return 0;case 1:return Br(e.booleanValue,t.booleanValue);case 2:return r=t,s=rs(e.integerValue||e.doubleValue),i=rs(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return vs(e.timestampValue,t.timestampValue);case 4:return vs(os(e),os(t));case 5:return Br(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ss(e),r=ss(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=Br(n[s],r[s]);if(0!==t)return t}return Br(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(i=Br(rs(n.latitude),rs(r.latitude)))?i:Br(rs(n.longitude),rs(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=ys(n[s],r[s]);if(t)return t}return Br(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let a=0;a<r.length&&a<i.length;++a){const t=Br(r[a],i[a]);if(0!==t)return t;var o=ys(n[r[a]],s[i[a]]);if(0!==o)return o}return Br(r.length,i.length)}(e.mapValue,t.mapValue);default:throw Ar()}}function vs(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Br(e,t);var n=ns(e),r=ns(t),s=Br(n.seconds,r.seconds);return 0!==s?s:Br(n.nanos,r.nanos)}function ws(e){return function i(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=ns(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?ss(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,ds.fromName(t).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=i(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${i(e.fields[s])}`;return n+"}"}(e.mapValue):Ar();var t}(e)}function Is(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function bs(e){return e&&"integerValue"in e}function Ts(e){return!!e&&"arrayValue"in e}function Es(e){return e&&"nullValue"in e}function Ss(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function _s(e){return e&&"mapValue"in e}function As(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return zr(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=As(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=As(t.arrayValue.values[e]);return r}return Object.assign({},t)}class xs{constructor(e){this.value=e}static empty(){return new xs({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!_s(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=As(t)}setAll(e){let n=Jr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=As(e):s.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(e){const t=this.field(e.popLast());_s(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ms(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];_s(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){zr(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new xs(As(this.value))}}class Ns{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new Ns(e,0,$r.min(),$r.min(),xs.empty(),0)}static newFoundDocument(e,t,n){return new Ns(e,1,t,$r.min(),n,0)}static newNoDocument(e,t){return new Ns(e,2,t,$r.min(),xs.empty(),0)}static newUnknownDocument(e,t){return new Ns(e,3,t,$r.min(),xs.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=xs.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=xs.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ns&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ns(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Cs{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}Cs.UNKNOWN_ID=-1;class Ds{constructor(e,t){this.fieldPath=e,this.kind=t}}class ks{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new ks(0,Os.min())}}class Os{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Os($r.min(),ds.empty(),-1)}}class Rs{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.P=null}}function Ls(e,t=null,n=[],r=[],s=null,i=null,o=null){return new Rs(e,t,n,r,s,i,o)}function Ms(e){const t=e;if(null===t.P){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>{return(t=e).field.canonicalString()+t.op.toString()+ws(t.value);var t}).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),us(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>ws(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>ws(e)).join(",")),t.P=e}return t.P}function Ps(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let o=0;o<e.orderBy.length;o++)if(n=e.orderBy[o],r=t.orderBy[o],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r,s,i;if(e.filters.length!==t.filters.length)return!1;for(let a=0;a<e.filters.length;a++)if(s=e.filters[a],i=t.filters[a],s.op!==i.op||!s.field.isEqual(i.field)||!ms(s.value,i.value))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ys(e.startAt,t.startAt)&&Ys(e.endAt,t.endAt)}function Fs(e){return ds.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class Vs extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.v(e,t,n):new Us(e,t,n):"array-contains"===t?new Ks(e,n):"in"===t?new Gs(e,n):"not-in"===t?new $s(e,n):"array-contains-any"===t?new Qs(e,n):new Vs(e,t,n)}static v(e,t,n){return new("in"===t?qs:Bs)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.V(ys(t,this.value)):null!==t&&gs(this.value)===gs(t)&&this.V(ys(t,this.value))}V(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Ar()}}S(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class Us extends Vs{constructor(e,t,n){super(e,t,n),this.key=ds.fromName(n.referenceValue)}matches(e){var t=ds.comparator(e.key,this.key);return this.V(t)}}class qs extends Vs{constructor(e,t){super(e,"in",t),this.keys=js(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class Bs extends Vs{constructor(e,t){super(e,"not-in",t),this.keys=js(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function js(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>ds.fromName(e.referenceValue))}class Ks extends Vs{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Ts(t)&&ps(t.arrayValue,this.value)}}class Gs extends Vs{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&ps(this.value.arrayValue,t)}}class $s extends Vs{constructor(e,t){super(e,"not-in",t)}matches(e){if(ps(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!ps(this.value.arrayValue,t)}}class Qs extends Vs{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ts(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>ps(this.value.arrayValue,e))}}class zs{constructor(e,t){this.position=e,this.inclusive=t}}class Hs{constructor(e,t="asc"){this.field=e,this.dir=t}}function Ws(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?ds.comparator(ds.fromName(o.referenceValue),n.key):ys(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Ys(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!ms(e.position[n],t.position[n]))return!1;return!0}class Xs{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.D=null,this.C=null,this.startAt,this.endAt}}function Js(e,t,n,r,s,i,o,a){return new Xs(e,t,n,r,s,i,o,a)}function Zs(e){return new Xs(e)}function ei(e){return!us(e.limit)&&"F"===e.limitType}function ti(e){return!us(e.limit)&&"L"===e.limitType}function ni(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function ri(e){for(const t of e.filters)if(t.S())return t.field;return null}function si(e){return null!==e.collectionGroup}function ii(t){const n=t;if(null===n.D){n.D=[];const t=ri(n),e=ni(n);if(null!==t&&null===e)t.isKeyField()||n.D.push(new Hs(t)),n.D.push(new Hs(Jr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.D.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.D.push(new Hs(Jr.keyField(),t))}}}return n.D}function oi(e){const t=e;if(!t.C)if("F"===t.limitType)t.C=Ls(t.path,t.collectionGroup,ii(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of ii(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Hs(s.field,t))}var n=t.endAt?new zs(t.endAt.position,!t.endAt.inclusive):null,r=t.startAt?new zs(t.startAt.position,!t.startAt.inclusive):null;t.C=Ls(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.C}function ai(e,t,n){return new Xs(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function hi(e,t){return Ps(oi(e),oi(t))&&e.limitType===t.limitType}function ui(e){return`${Ms(oi(e))}|lt:${e.limitType}`}function ci(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>{return`${(t=e).field.canonicalString()} ${t.op} ${ws(t.value)}`;var t}).join(", ")}]`),us(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>ws(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>ws(e)).join(",")),`Target(${t})`}(oi(e))}; limitType=${e.limitType})`}function li(n,e){return e.isFoundDocument()&&(s=n,o=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(o):ds.isDocumentKey(s.path)?s.path.isEqual(o):s.path.isImmediateParentOf(o))&&function(e){for(const t of n.explicitOrderBy)if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(t=e.startAt,r=Ws(t,ii(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(t=e.endAt,r=Ws(t,ii(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,o}function di(s){return(e,t)=>{let n=!1;for(const r of ii(s)){const s=function(e,s,t){var n=e.field.isKeyField()?ds.comparator(s.key,t.key):function(e,t){var n=s.data.field(e),r=t.data.field(e);return null!==n&&null!==r?ys(n,r):Ar()}(e.field,t);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return Ar()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function fi(e,t){if(e.N){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:cs(t)?"-0":t}}function gi(e){return{integerValue:""+e}}function mi(e,t){return ls(t)?gi(t):fi(e,t)}class pi{constructor(){this._=void 0}}function yi(e,t){return e instanceof Ei?bs(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class vi extends pi{}class wi extends pi{constructor(e){super(),this.elements=e}}function Ii(e,t){const n=_i(t);for(const t of e.elements)n.some(e=>ms(e,t))||n.push(t);return{arrayValue:{values:n}}}class bi extends pi{constructor(e){super(),this.elements=e}}function Ti(e,t){let n=_i(t);for(const t of e.elements)n=n.filter(e=>!ms(e,t));return{arrayValue:{values:n}}}class Ei extends pi{constructor(e,t){super(),this.O=e,this.k=t}}function Si(e){return rs(e.integerValue||e.doubleValue)}function _i(e){return Ts(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Ai{constructor(e,t){this.field=e,this.transform=t}}class xi{constructor(e,t){this.version=e,this.transformResults=t}}class Ni{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Ni}static exists(e){return new Ni(void 0,e)}static updateTime(e){return new Ni(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Ci(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Di{}function ki(e,t,n){e instanceof Mi?function(e,t,n){const r=e.value.clone(),s=Vi(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Pi?function(e,t,n){if(!Ci(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=Vi(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Fi(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function Oi(e,t,n){e instanceof Mi?function(e,t,n){if(Ci(e.precondition,t)){const r=e.value.clone(),s=Ui(e.fieldTransforms,n,t);r.setAll(s),t.convertToFoundDocument(Li(t),r).setHasLocalMutations()}}(e,t,n):e instanceof Pi?function(e,t,n){if(Ci(e.precondition,t)){const r=Ui(e.fieldTransforms,n,t),s=t.data;s.setAll(Fi(e)),s.setAll(r),t.convertToFoundDocument(Li(t),s).setHasLocalMutations()}}(e,t,n):(t=t,Ci(e.precondition,t)&&t.convertToNoDocument($r.min()))}function Ri(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&jr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof wi&&t instanceof wi||e instanceof bi&&t instanceof bi?jr(e.elements,t.elements,ms):e instanceof Ei&&t instanceof Ei?ms(e.k,t.k):e instanceof vi&&t instanceof vi)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}function Li(e){return e.isFoundDocument()?e.version:$r.min()}class Mi extends Di{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Pi extends Di{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Fi(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function Vi(e,t,n){const r=new Map;xr(e.length===n.length);for(let c=0;c<n.length;c++){var s=e[c],i=s.transform,o=t.data.field(s.field);r.set(s.field,(a=i,h=o,u=n[c],a instanceof wi?Ii(a,h):a instanceof bi?Ti(a,h):u))}var a,h,u;return r}function Ui(e,t,n){const r=new Map;for(const u of e){const e=u.transform,c=n.data.field(u.field);r.set(u.field,(s=e,i=c,o=t,h=a=void 0,s instanceof vi?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:o.seconds,nanos:o.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof wi?Ii(s,i):s instanceof bi?Ti(s,i):(a=yi(s=s,i),h=Si(a)+Si(s.k),bs(a)&&bs(s.k)?gi(h):fi(s.O,h))))}var s,i,o,a,h;return r}class qi extends Di{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}}class Bi extends Di{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}}class ji{constructor(e){this.count=e}}function Ki(e){switch(e){default:return Ar(),0;case Nr.CANCELLED:case Nr.UNKNOWN:case Nr.DEADLINE_EXCEEDED:case Nr.RESOURCE_EXHAUSTED:case Nr.INTERNAL:case Nr.UNAVAILABLE:case Nr.UNAUTHENTICATED:return;case Nr.INVALID_ARGUMENT:case Nr.NOT_FOUND:case Nr.ALREADY_EXISTS:case Nr.PERMISSION_DENIED:case Nr.FAILED_PRECONDITION:case Nr.ABORTED:case Nr.OUT_OF_RANGE:case Nr.UNIMPLEMENTED:case Nr.DATA_LOSS:return 1}}function Gi(e){if(void 0===e)return Er("GRPC error has no .code"),Nr.UNKNOWN;switch(e){case ar.OK:return Nr.OK;case ar.CANCELLED:return Nr.CANCELLED;case ar.UNKNOWN:return Nr.UNKNOWN;case ar.DEADLINE_EXCEEDED:return Nr.DEADLINE_EXCEEDED;case ar.RESOURCE_EXHAUSTED:return Nr.RESOURCE_EXHAUSTED;case ar.INTERNAL:return Nr.INTERNAL;case ar.UNAVAILABLE:return Nr.UNAVAILABLE;case ar.UNAUTHENTICATED:return Nr.UNAUTHENTICATED;case ar.INVALID_ARGUMENT:return Nr.INVALID_ARGUMENT;case ar.NOT_FOUND:return Nr.NOT_FOUND;case ar.ALREADY_EXISTS:return Nr.ALREADY_EXISTS;case ar.PERMISSION_DENIED:return Nr.PERMISSION_DENIED;case ar.FAILED_PRECONDITION:return Nr.FAILED_PRECONDITION;case ar.ABORTED:return Nr.ABORTED;case ar.OUT_OF_RANGE:return Nr.OUT_OF_RANGE;case ar.UNIMPLEMENTED:return Nr.UNIMPLEMENTED;case ar.DATA_LOSS:return Nr.DATA_LOSS;default:return Ar()}}(it=ar=ar||{})[it.OK=0]="OK",it[it.CANCELLED=1]="CANCELLED",it[it.UNKNOWN=2]="UNKNOWN",it[it.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",it[it.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",it[it.NOT_FOUND=5]="NOT_FOUND",it[it.ALREADY_EXISTS=6]="ALREADY_EXISTS",it[it.PERMISSION_DENIED=7]="PERMISSION_DENIED",it[it.UNAUTHENTICATED=16]="UNAUTHENTICATED",it[it.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",it[it.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",it[it.ABORTED=10]="ABORTED",it[it.OUT_OF_RANGE=11]="OUT_OF_RANGE",it[it.UNIMPLEMENTED=12]="UNIMPLEMENTED",it[it.INTERNAL=13]="INTERNAL",it[it.UNAVAILABLE=14]="UNAVAILABLE",it[it.DATA_LOSS=15]="DATA_LOSS";class $i{constructor(e,t){this.comparator=e,this.root=t||zi.EMPTY}insert(e,t){return new $i(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,zi.BLACK,null,null))}remove(e){return new $i(this.comparator,this.root.remove(e,this.comparator).copy(null,null,zi.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Qi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Qi(this.root,e,this.comparator,!1)}getReverseIterator(){return new Qi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Qi(this.root,e,this.comparator,!0)}}class Qi{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class zi{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:zi.RED,this.left=null!=r?r:zi.EMPTY,this.right=null!=s?s:zi.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new zi(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return zi.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return zi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,zi.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,zi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ar();if(this.right.isRed())throw Ar();var e=this.left.check();if(e!==this.right.check())throw Ar();return e+(this.isRed()?0:1)}}zi.EMPTY=null,zi.RED=!0,zi.BLACK=!1,zi.EMPTY=new class{constructor(){this.size=0}get key(){throw Ar()}get value(){throw Ar()}get color(){throw Ar()}get left(){throw Ar()}get right(){throw Ar()}copy(e,t,n,r,s){return this}insert(e,t,n){return new zi(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Hi{constructor(e){this.comparator=e,this.data=new $i(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Wi(this.data.getIterator())}getIteratorFrom(e){return new Wi(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof Hi))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new Hi(this.comparator);return t.data=e,t}}class Wi{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Yi(e){return e.hasNext()?e.getNext():void 0}const Xi=new $i(ds.comparator);const Ji=new $i(ds.comparator);const Zi=new $i(ds.comparator),eo=new Hi(ds.comparator);function to(...e){let t=eo;for(const n of e)t=t.add(n);return t}const no=new Hi(Br);class ro{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,so.createSynthesizedTargetChangeForCurrentChange(e,t)),new ro($r.min(),n,no,Xi,to())}}class so{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new so(es.EMPTY_BYTE_STRING,t,to(),to(),to())}}class io{constructor(e,t,n,r){this.M=e,this.removedTargetIds=t,this.key=n,this.$=r}}class oo{constructor(e,t){this.targetId=e,this.F=t}}class ao{constructor(e,t,n=es.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ho{constructor(){this.B=0,this.L=lo(),this.U=es.EMPTY_BYTE_STRING,this.q=!1,this.K=!0}get current(){return this.q}get resumeToken(){return this.U}get G(){return 0!==this.B}get j(){return this.K}W(e){0<e.approximateByteSize()&&(this.K=!0,this.U=e)}H(){let n=to(),r=to(),s=to();return this.L.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:Ar()}}),new so(this.U,this.q,n,r,s)}J(){this.K=!1,this.L=lo()}Y(e,t){this.K=!0,this.L=this.L.insert(e,t)}X(e){this.K=!0,this.L=this.L.remove(e)}Z(){this.B+=1}tt(){--this.B}et(){this.K=!0,this.q=!0}}class uo{constructor(e){this.nt=e,this.st=new Map,this.it=Xi,this.rt=co(),this.ot=new Hi(Br)}ct(e){for(const t of e.M)e.$&&e.$.isFoundDocument()?this.ut(t,e.$):this.at(t,e.key,e.$);for(const n of e.removedTargetIds)this.at(n,e.key,e.$)}ht(n){this.forEachTarget(n,e=>{const t=this.lt(e);switch(n.state){case 0:this.ft(e)&&t.W(n.resumeToken);break;case 1:t.tt(),t.G||t.J(),t.W(n.resumeToken);break;case 2:t.tt(),t.G||this.removeTarget(e);break;case 3:this.ft(e)&&(t.et(),t.W(n.resumeToken));break;case 4:this.ft(e)&&(this.dt(e),t.W(n.resumeToken));break;default:Ar()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.st.forEach((e,t)=>{this.ft(t)&&n(t)})}_t(e){const t=e.targetId,n=e.F.count,r=this.wt(t);if(r){const e=r.target;if(Fs(e))if(0===n){const n=new ds(e.path);this.at(t,n,Ns.newNoDocument(n,$r.min()))}else xr(1===n);else this.gt(t)!==n&&(this.dt(t),this.ot=this.ot.add(t))}}yt(r){const s=new Map;this.st.forEach((e,t)=>{var n=this.wt(t);if(n){if(e.current&&Fs(n.target)){const s=new ds(n.target.path);null!==this.it.get(s)||this.It(t,s)||this.at(t,s,Ns.newNoDocument(s,r))}e.j&&(s.set(t,e.H()),e.J())}});let i=to();this.rt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.wt(e);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(e))}),this.it.forEach((e,t)=>t.setReadTime(r));var e=new ro(r,s,this.ot,this.it,i);return this.it=Xi,this.rt=co(),this.ot=new Hi(Br),e}ut(e,t){var n;this.ft(e)&&(n=this.It(e,t.key)?2:0,this.lt(e).Y(t.key,n),this.it=this.it.insert(t.key,t),this.rt=this.rt.insert(t.key,this.Et(t.key).add(e)))}at(e,t,n){if(this.ft(e)){const r=this.lt(e);this.It(e,t)?r.Y(t,1):r.X(t),this.rt=this.rt.insert(t,this.Et(t).delete(e)),n&&(this.it=this.it.insert(t,n))}}removeTarget(e){this.st.delete(e)}gt(e){var t=this.lt(e).H();return this.nt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Z(e){this.lt(e).Z()}lt(e){let t=this.st.get(e);return t||(t=new ho,this.st.set(e,t)),t}Et(e){let t=this.rt.get(e);return t||(t=new Hi(Br),this.rt=this.rt.insert(e,t)),t}ft(e){var t=null!==this.wt(e);return t||Tr("WatchChangeAggregator","Detected inactive target",e),t}wt(e){var t=this.st.get(e);return t&&t.G?null:this.nt.Tt(e)}dt(t){this.st.set(t,new ho),this.nt.getRemoteKeysForTarget(t).forEach(e=>{this.at(t,e,null)})}It(e,t){return this.nt.getRemoteKeysForTarget(e).has(t)}}function co(){return new $i(ds.comparator)}function lo(){return new $i(ds.comparator)}const fo={asc:"ASCENDING",desc:"DESCENDING"},go={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class mo{constructor(e,t){this.databaseId=e,this.N=t}}function po(e,t){return e.N?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function yo(e,t){return e.N?t.toBase64():t.toUint8Array()}function vo(e){return xr(!!e),$r.fromTimestamp((t=ns(e),new Gr(t.seconds,t.nanos)));var t}function wo(e,t){return e=e,new Yr(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Io(e){var t=Yr.fromString(e);return xr(Vo(t)),t}function bo(e,t){return wo(e.databaseId,t.path)}function To(e,t){const n=Io(t);if(n.get(1)!==e.databaseId.projectId)throw new Cr(Nr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Cr(Nr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ds(Ao(n))}function Eo(e,t){return wo(e.databaseId,t)}function So(e){var t=Io(e);return 4===t.length?Yr.emptyPath():Ao(t)}function _o(e){return new Yr(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ao(e){return xr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function xo(e,t,n){return{name:bo(e,t),fields:n.value.mapValue.fields}}function No(e,t,n){const r=To(e,t.name),s=vo(t.updateTime),i=new xs({mapValue:{fields:t.fields}}),o=Ns.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Co(e,t){let n;if(t instanceof Mi)n={update:xo(e,t.key,t.value)};else if(t instanceof qi)n={delete:bo(e,t.key)};else if(t instanceof Pi)n={update:xo(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Bi))return Ar();n={verify:bo(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof vi)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof wi)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof bi)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof Ei)return{fieldPath:e.field.canonicalString(),increment:t.k};throw Ar()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,po(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:Ar()),n;var r}function Do(t,n){const e=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?Ni.updateTime(vo(s.updateTime)):void 0!==s.exists?Ni.exists(s.exists):Ni.none():Ni.none(),r=n.updateTransforms?n.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)xr("REQUEST_TIME"===t.setToServerValue),n=new vi;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new wi(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new bi(e)}else"increment"in t?n=new Ei(e,t.increment):Ar();var r=Jr.fromServerFormat(t.fieldPath);return new Ai(r,n)}(t,e)):[];var s;if(n.update){n.update.name;var i=To(t,n.update.name),o=new xs({mapValue:{fields:n.update.fields}});if(n.updateMask){const t=function(){const e=n.updateMask.fieldPaths||[];return new Zr(e.map(e=>Jr.fromServerFormat(e)))}();return new Pi(i,o,t,e,r)}return new Mi(i,o,e,r)}if(n.delete){const r=To(t,n.delete);return new qi(r,e)}if(n.verify){const r=To(t,n.verify);return new Bi(r,e)}return Ar()}function ko(e,t){return{documents:[Eo(e,t.path)]}}function Oo(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Eo(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Eo(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length){var t=e.map(e=>function(e){if("=="===e.op){if(Ss(e.value))return{unaryFilter:{field:Lo(e.field),op:"IS_NAN"}};if(Es(e.value))return{unaryFilter:{field:Lo(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ss(e.value))return{unaryFilter:{field:Lo(e.field),op:"IS_NOT_NAN"}};if(Es(e.value))return{unaryFilter:{field:Lo(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Lo(e.field),op:(t=e.op,go[t]),value:e.value}};var t}(e));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:Lo(e.field),direction:(e=e.dir,fo[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=t.limit,e.N||us(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(s=t.startAt).inclusive,values:s.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function Ro(e){let t=So(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){xr(1===r);const g=n.from[0];g.allDescendants?s=g.collectionId:t=t.child(g.collectionId)}let i=[];n.where&&(i=function t(e){return e?void 0!==e.unaryFilter?[Fo(e)]:void 0!==e.fieldFilter?[Po(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(e=>t(e)).reduce((e,t)=>e.concat(t)):Ar():[]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map(e=>function(e){return new Hs(Mo(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let a=null;var h,u,c,l;n.limit&&(a=(e=n.limit,us(h="object"==typeof e?e.value:e)?null:h));let d=null;n.startAt&&(d=(u=n.startAt,l=!!u.before,c=u.values||[],new zs(c,l)));let f=null;return n.endAt&&(f=(u=n.endAt,c=!u.before,l=u.values||[],new zs(l,c))),Js(t,s,o,i,a,"F",d,f)}function Lo(e){return{fieldPath:e.canonicalString()}}function Mo(e){return Jr.fromServerFormat(e.fieldPath)}function Po(e){return Vs.create(Mo(e.fieldFilter.field),function(){switch(e.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ar()}}(),e.fieldFilter.value)}function Fo(e){switch(e.unaryFilter.op){case"IS_NAN":var t=Mo(e.unaryFilter.field);return Vs.create(t,"==",{doubleValue:NaN});case"IS_NULL":t=Mo(e.unaryFilter.field);return Vs.create(t,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=Mo(e.unaryFilter.field);return Vs.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=Mo(e.unaryFilter.field);return Vs.create(n,"!=",{nullValue:"NULL_VALUE"});default:return Ar()}}function Vo(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function Uo(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=qo(t)),t=function(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const r=e.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return qo(t)}function qo(e){return e+""}function Bo(t){const n=t.length;if(xr(2<=n),2===n)return xr(""===t.charAt(0)&&""===t.charAt(1)),Yr.emptyPath();const r=n-2,s=[];let i="";for(let o=0;o<n;){const n=t.indexOf("",o);switch((n<0||n>r)&&Ar(),t.charAt(n+1)){case"":const r=t.substring(o,n);let e;0===i.length?e=r:(i+=r,e=i,i=""),s.push(e);break;case"":i+=t.substring(o,n),i+="\0";break;case"":i+=t.substring(o,n+1);break;default:Ar()}o=n+2}return new Yr(s)}class jo{constructor(e,t){this.seconds=e,this.nanoseconds=t}}class Ko{constructor(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n}}Ko.store="owner",Ko.key="owner";class Go{constructor(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}}Go.store="mutationQueues",Go.keyPath="userId";class $o{constructor(e,t,n,r,s){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}$o.store="mutations",$o.keyPath="batchId",$o.userMutationsIndex="userMutationsIndex",$o.userMutationsKeyPath=["userId","batchId"];class Qo{constructor(){}static prefixForUser(e){return[e]}static prefixForPath(e,t){return[e,Uo(t)]}static key(e,t,n){return[e,Uo(t),n]}}Qo.store="documentMutations",Qo.PLACEHOLDER=new Qo;class zo{constructor(e,t){this.path=e,this.readTime=t}}class Ho{constructor(e,t){this.path=e,this.version=t}}class Wo{constructor(e,t,n,r,s,i){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}Wo.store="remoteDocuments",Wo.readTimeIndex="readTimeIndex",Wo.readTimeIndexPath="readTime",Wo.collectionReadTimeIndex="collectionReadTimeIndex",Wo.collectionReadTimeIndexPath=["parentPath","readTime"];class Yo{constructor(e){this.byteSize=e}}Yo.store="remoteDocumentGlobal",Yo.key="remoteDocumentGlobalKey";class Xo{constructor(e,t,n,r,s,i,o){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}Xo.store="targets",Xo.keyPath="targetId",Xo.queryTargetsIndexName="queryTargetsIndex",Xo.queryTargetsKeyPath=["canonicalId","targetId"];class Jo{constructor(e,t,n){this.targetId=e,this.path=t,this.sequenceNumber=n}}Jo.store="targetDocuments",Jo.keyPath=["targetId","path"],Jo.documentTargetsIndex="documentTargetsIndex",Jo.documentTargetsKeyPath=["path","targetId"];class Zo{constructor(e,t,n,r){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}Zo.key="targetGlobalKey",Zo.store="targetGlobal";class ea{constructor(e,t){this.collectionId=e,this.parent=t}}ea.store="collectionParents",ea.keyPath=["collectionId","parent"];class ta{constructor(e,t,n,r){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=r}}ta.store="clientMetadata",ta.keyPath="clientId";class na{constructor(e,t,n){this.bundleId=e,this.createTime=t,this.version=n}}na.store="bundles",na.keyPath="bundleId";class ra{constructor(e,t,n){this.name=e,this.readTime=t,this.bundledQuery=n}}ra.store="namedQueries",ra.keyPath="name";class sa{constructor(e,t,n){this.indexId=e,this.collectionGroup=t,this.fields=n}}sa.store="indexConfiguration",sa.keyPath="indexId",sa.collectionGroupIndex="collectionGroupIndex",sa.collectionGroupIndexPath="collectionGroup";class ia{constructor(e,t,n,r,s,i){this.indexId=e,this.uid=t,this.sequenceNumber=n,this.readTime=r,this.documentKey=s,this.largestBatchId=i}}ia.store="indexState",ia.keyPath=["indexId","uid"],ia.sequenceNumberIndex="sequenceNumberIndex",ia.sequenceNumberIndexPath=["uid","sequenceNumber"];class oa{constructor(e,t,n,r,s){this.indexId=e,this.uid=t,this.arrayValue=n,this.directionalValue=r,this.documentKey=s}}oa.store="indexEntries",oa.keyPath=["indexId","uid","arrayValue","directionalValue","documentKey"],oa.documentKeyIndex="documentKeyIndex",oa.documentKeyIndexPath=["indexId","uid","documentKey"];class aa{constructor(e,t,n,r,s,i){this.userId=e,this.collectionPath=t,this.documentId=n,this.collectionGroup=r,this.largestBatchId=s,this.overlayMutation=i}}aa.store="documentOverlays",aa.keyPath=["userId","collectionPath","documentId"],aa.collectionPathOverlayIndex="collectionPathOverlayIndex",aa.collectionPathOverlayIndexPath=["userId","collectionPath","largestBatchId"],aa.collectionGroupOverlayIndex="collectionGroupOverlayIndex",aa.collectionGroupOverlayIndexPath=["userId","collectionGroup","largestBatchId"];const ha=[Go.store,$o.store,Qo.store,Wo.store,Xo.store,Ko.store,Zo.store,Jo.store,ta.store,Yo.store,ea.store,na.store,ra.store],ua=[...ha,aa.store],ca=[...ua,sa.store,ia.store,oa.store],la="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class da{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}class fa{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&Ar(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new fa((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof fa?t:fa.resolve(t)}catch(e){return fa.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):fa.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):fa.reject(t)}static resolve(n){return new fa((e,t)=>{e(n)})}static reject(n){return new fa((e,t)=>{t(n)})}static waitFor(e){return new fa((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=fa.resolve(!1);for(const n of e)t=t.next(e=>e?fa.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}}class ga{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.At=new Dr,this.transaction.oncomplete=()=>{this.At.resolve()},this.transaction.onabort=()=>{e.error?this.At.reject(new ya(n,e.error)):this.At.resolve()},this.transaction.onerror=e=>{var t=Ta(e.target.error);this.At.reject(new ya(n,t))}}static open(e,t,n,r){try{return new ga(t,e.transaction(r,n))}catch(e){throw new ya(t,e)}}get Rt(){return this.At.promise}abort(e){e&&this.At.reject(e),this.aborted||(Tr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}Pt(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new wa(t)}}class ma{constructor(e,t,n){this.name=e,this.version=t,this.bt=n,12.2===ma.vt(f())&&Er("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Tr("SimpleDb","Removing database:",e),Ia(window.indexedDB.deleteDatabase(e)).toPromise()}static Vt(){if("object"!=typeof indexedDB)return!1;if(ma.St())return!0;const e=f(),t=ma.vt(e),n=0<t&&t<10,r=ma.Dt(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static St(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.Ct)}static Nt(e,t){return e.store(t)}static vt(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Dt(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async xt(i){return this.db||(Tr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{var t=e.target.result;n(t)},s.onblocked=()=>{r(new ya(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new Cr(Nr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new Cr(Nr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new ya(i,t))},s.onupgradeneeded=e=>{Tr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.bt.kt(t,s.transaction,e.oldVersion,this.version).next(()=>{Tr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.Ot&&(this.db.onversionchange=e=>this.Ot(e)),this.db}Mt(t){this.Ot=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.xt(e);const t=ga.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.Pt(),e)).catch(e=>(t.abort(e),fa.reject(e))).toPromise();return i.catch(()=>{}),await t.Rt,i}catch(e){const t="FirebaseError"!==e.name&&i<3;if(Tr("SimpleDb","Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class pa{constructor(e){this.$t=e,this.Ft=!1,this.Bt=null}get isDone(){return this.Ft}get Lt(){return this.Bt}set cursor(e){this.$t=e}done(){this.Ft=!0}Ut(e){this.Bt=e}delete(){return Ia(this.$t.delete())}}class ya extends Cr{constructor(e,t){super(Nr.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function va(e){return"IndexedDbTransactionError"===e.name}class wa{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Tr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Tr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),Ia(n)}add(e){return Tr("SimpleDb","ADD",this.store.name,e,e),Ia(this.store.add(e))}get(t){return Ia(this.store.get(t)).next(e=>(Tr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Tr("SimpleDb","DELETE",this.store.name,e),Ia(this.store.delete(e))}count(){return Tr("SimpleDb","COUNT",this.store.name),Ia(this.store.count())}qt(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.Kt(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new fa((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}Gt(e,t){Tr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.jt=!1;var r=this.cursor(n);return this.Kt(r,(e,t,n)=>n.delete())}Qt(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.Kt(r,t)}Wt(s){const e=this.cursor({});return new fa((n,r)=>{e.onerror=e=>{var t=Ta(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?s(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}Kt(e,i){const o=[];return new fa((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new pa(t),r=i(t.primaryKey,t.value,n);if(r instanceof fa){const e=r.catch(e=>(n.done(),fa.reject(e)));o.push(e)}n.isDone?s():null===n.Lt?t.continue():t.continue(n.Lt)}else s()}}).next(()=>fa.waitFor(o))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.jt?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Ia(e){return new fa((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=Ta(e.target.error);r(t)}})}let ba=!1;function Ta(e){const t=ma.vt(f());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Cr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ba||(ba=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ea extends da{constructor(e,t){super(),this.zt=e,this.currentSequenceNumber=t}}function Sa(e,t){var n=e;return ma.Nt(n.zt,t)}class _a{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(e.key)&&ki(s,e,n[r])}}applyToLocalView(e){for(const t of this.baseMutations)t.key.isEqual(e.key)&&Oi(t,e,this.localWriteTime);for(const n of this.mutations)n.key.isEqual(e.key)&&Oi(n,e,this.localWriteTime)}applyToLocalDocumentSet(r){this.mutations.forEach(e=>{const t=r.get(e.key),n=t;this.applyToLocalView(n),t.isValidDocument()||n.convertToNoDocument($r.min())})}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),to())}isEqual(e){return this.batchId===e.batchId&&jr(this.mutations,e.mutations,(e,t)=>Ri(e,t))&&jr(this.baseMutations,e.baseMutations,(e,t)=>Ri(e,t))}}class Aa{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){xr(e.mutations.length===n.length);let r=Zi;var s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Aa(e,t,n,r)}}class xa{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Na{constructor(e,t,n,r,s=$r.min(),i=$r.min(),o=es.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new Na(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Na(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Na(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Ca{constructor(e){this.Ht=e}}function Da(e,t){let n;if(t.document)n=No(e.Ht,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=ds.fromSegments(t.noDocument.path),r=Ma(t.noDocument.readTime);n=Ns.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Ar();{const e=ds.fromSegments(t.unknownDocument.path),s=Ma(t.unknownDocument.version);n=Ns.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime(Ra(t.readTime)),n}function ka(e,t){var n,r=Oa(t.readTime),s=t.key.path.popLast().toArray();if(t.isFoundDocument()){var i={name:bo(n=e.Ht,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:po(n,e.version.toTimestamp())},o=t.hasCommittedMutations;return new Wo(null,null,i,o,r,s)}if(t.isNoDocument()){const a=t.key.path.toArray(),h=La(t.version),u=t.hasCommittedMutations;return new Wo(null,new zo(a,h),null,u,r,s)}if(t.isUnknownDocument()){const a=t.key.path.toArray(),c=La(t.version);return new Wo(new Ho(a,c),null,null,!0,r,s)}return Ar()}function Oa(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Ra(e){var t=new Gr(e[0],e[1]);return $r.fromTimestamp(t)}function La(e){var t=e.toTimestamp();return new jo(t.seconds,t.nanoseconds)}function Ma(e){var t=new Gr(e.seconds,e.nanoseconds);return $r.fromTimestamp(t)}function Pa(t,e){const n=(e.baseMutations||[]).map(e=>Do(t.Ht,e));for(let i=0;i<e.mutations.length-1;++i){const n=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const r=e.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map(e=>Do(t.Ht,e)),s=Gr.fromMillis(e.localWriteTimeMs);return new _a(e.batchId,s,n,r)}function Fa(e){var t,n=Ma(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Ma(e.lastLimboFreeSnapshotVersion):$r.min();let s;return s=void 0!==e.query.documents?(xr(1===(t=e.query).documents.length),oi(Zs(So(t.documents[0])))):oi(Ro(e.query)),new Na(s,e.targetId,0,e.lastListenSequenceNumber,n,r,es.fromBase64String(e.resumeToken))}function Va(e,t){var n=La(t.snapshotVersion),r=La(t.lastLimboFreeSnapshotVersion),s=(Fs(t.target)?ko:Oo)(e.Ht,t.target),i=t.resumeToken.toBase64();return new Xo(t.targetId,Ms(t.target),n,i,t.sequenceNumber,r,s)}function Ua(e){var t=Ro({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?ai(t,t.limit,"L"):t}function qa(e,t){return new xa(t.largestBatchId,Do(e.Ht,t.overlayMutation))}function Ba(e,t){var n=t.path.lastSegment();return[e,Uo(t.path.popLast()),n]}class ja{getBundleMetadata(e,t){return Ka(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:Ma(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return Ka(e).put({bundleId:(n=t).id,createTime:La(vo(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Ga(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:Ua(t.bundledQuery),readTime:Ma(t.readTime)};var t})}saveNamedQuery(e,t){return Ga(e).put({name:(t=t).name,readTime:La(vo(t.readTime)),bundledQuery:t.bundledQuery})}}function Ka(e){return Sa(e,na.store)}function Ga(e){return Sa(e,ra.store)}class $a{constructor(e,t){this.O=e,this.userId=t}static Jt(e,t){var n=t.uid||"";return new $a(e,n)}getOverlay(e,t){return Qa(e).get(Ba(this.userId,t)).next(e=>e?qa(this.O,e):null)}saveOverlays(n,r,e){const s=[];return e.forEach(e=>{var t=new xa(r,e);s.push(this.Yt(n,t))}),fa.waitFor(s)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(Uo(e.getCollectionPath())));const s=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);s.push(Qa(n).Gt(aa.collectionPathOverlayIndex,t))}),fa.waitFor(s)}getOverlaysForCollection(e,t,n){const r=new Map,s=Uo(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Qa(e).qt(aa.collectionPathOverlayIndex,i).next(e=>{for(const t of e){const e=qa(this.O,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=new Map;let o;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Qa(e).Qt({index:aa.collectionGroupOverlayIndex,range:r},(e,t,n)=>{const r=qa(this.O,t);i.size<s||r.largestBatchId===o?(i.set(r.getKey(),r),o=r.largestBatchId):n.done()}).next(()=>i)}Yt(e,t){return Qa(e).put(function(e,t,n){var[,r,s]=Ba(t,n.mutation.key);return new aa(t,r,s,n.mutation.key.getCollectionGroup(),n.largestBatchId,Co(e.Ht,n.mutation))}(this.O,this.userId,t))}}function Qa(e){return Sa(e,aa.store)}class za{constructor(){}Xt(e,t){this.Zt(e,t),t.te()}Zt(e,t){var n,r;"nullValue"in e?this.ee(t,5):"booleanValue"in e?(this.ee(t,10),t.ne(e.booleanValue?1:0)):"integerValue"in e?(this.ee(t,15),t.ne(rs(e.integerValue))):"doubleValue"in e?(n=rs(e.doubleValue),isNaN(n)?this.ee(t,13):(this.ee(t,15),cs(n)?t.ne(0):t.ne(n))):"timestampValue"in e?(r=e.timestampValue,this.ee(t,20),"string"==typeof r?t.se(r):(t.se(`${r.seconds||""}`),t.ne(r.nanos||0))):"stringValue"in e?(this.ie(e.stringValue,t),this.re(t)):"bytesValue"in e?(this.ee(t,30),t.oe(ss(e.bytesValue)),this.re(t)):"referenceValue"in e?this.ce(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.ee(t,45),t.ne(r.latitude||0),t.ne(r.longitude||0)):"mapValue"in e?ms(e,fs)?this.ee(t,Number.MAX_SAFE_INTEGER):(this.ue(e.mapValue,t),this.re(t)):"arrayValue"in e?(this.ae(e.arrayValue,t),this.re(t)):Ar()}ie(e,t){this.ee(t,25),this.he(e,t)}he(e,t){t.se(e)}ue(e,t){var n=e.fields||{};this.ee(t,55);for(const e of Object.keys(n))this.ie(e,t),this.Zt(n[e],t)}ae(e,t){var n=e.values||[];this.ee(t,50);for(const e of n)this.Zt(e,t)}ce(e,t){this.ee(t,37),ds.fromName(e).path.forEach(e=>{this.ee(t,60),this.he(e,t)})}ee(e,t){e.ne(t)}re(e){e.ne(2)}}function Ha(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}za.le=new za;class Wa{constructor(){this.buffer=new Uint8Array(1024),this.position=0}fe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.de(n.value),n=t.next();this._e()}we(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.me(n.value),n=t.next();this.ge()}ye(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.de(e);else if(e<2048)this.de(960|e>>>6),this.de(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.de(480|e>>>12),this.de(128|63&e>>>6),this.de(128|63&e);else{const e=t.codePointAt(0);this.de(240|e>>>18),this.de(128|63&e>>>12),this.de(128|63&e>>>6),this.de(128|63&e)}}this._e()}pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.me(e);else if(e<2048)this.me(960|e>>>6),this.me(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.me(480|e>>>12),this.me(128|63&e>>>6),this.me(128|63&e);else{const e=t.codePointAt(0);this.me(240|e>>>18),this.me(128|63&e>>>12),this.me(128|63&e>>>6),this.me(128|63&e)}}this.ge()}Ie(e){var t=this.Ee(e),n=Ha(t);this.Te(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Ae(e){var t=this.Ee(e),n=Ha(t);this.Te(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Re(){this.Pe(255),this.Pe(255)}be(){this.ve(255),this.ve(255)}reset(){this.position=0}seed(e){this.Te(e.length),this.buffer.set(e,this.position),this.position+=e.length}Ve(){return this.buffer.slice(0,this.position)}Ee(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}de(e){var t=255&e;0==t?(this.Pe(0),this.Pe(255)):255==t?(this.Pe(255),this.Pe(0)):this.Pe(t)}me(e){var t=255&e;0==t?(this.ve(0),this.ve(255)):255==t?(this.ve(255),this.ve(0)):this.ve(e)}_e(){this.Pe(0),this.Pe(1)}ge(){this.ve(0),this.ve(1)}Pe(e){this.Te(1),this.buffer[this.position++]=e}ve(e){this.Te(1),this.buffer[this.position++]=~e}Te(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class Ya{constructor(e){this.Se=e}oe(e){this.Se.fe(e)}se(e){this.Se.ye(e)}ne(e){this.Se.Ie(e)}te(){this.Se.Re()}}class Xa{constructor(e){this.Se=e}oe(e){this.Se.we(e)}se(e){this.Se.pe(e)}ne(e){this.Se.Ae(e)}te(){this.Se.be()}}class Ja{constructor(){this.Se=new Wa,this.De=new Ya(this.Se),this.Ce=new Xa(this.Se)}seed(e){this.Se.seed(e)}Ne(e){return 0===e?this.De:this.Ce}Ve(){return this.Se.Ve()}reset(){this.Se.reset()}}class Za{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}}function eh(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=ds.comparator(e.documentKey,t.documentKey),0!==n?n:(n=th(e.arrayValue,t.arrayValue),0!==n?n:th(e.directionalValue,t.directionalValue)))}function th(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class nh{constructor(){this.xe=new rh}addToCollectionParentIndex(e,t){return this.xe.add(t),fa.resolve()}getCollectionParents(e,t){return fa.resolve(this.xe.getEntries(t))}addFieldIndex(e,t){return fa.resolve()}deleteFieldIndex(e,t){return fa.resolve()}getDocumentsMatchingTarget(e,t,n){return fa.resolve(to())}getFieldIndex(e,t){return fa.resolve(null)}getFieldIndexes(e,t){return fa.resolve([])}getNextCollectionGroupToUpdate(e){return fa.resolve(null)}updateCollectionGroup(e,t,n){return fa.resolve()}updateIndexEntries(e,t){return fa.resolve()}}class rh{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Hi(Yr.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Hi(Yr.comparator)).toArray()}}class sh{constructor(e){this.user=e,this.ke=new rh,this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.ke.has(t))return fa.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.ke.add(t)});r={collectionId:n,parent:Uo(r)};return ih(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[Kr(n),""],!1,!0);return ih(e).qt(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Bo(t.parent))}return r})}addFieldIndex(e,t){const n=ah(e),r=(t=t,new sa(t.indexId,t.collectionGroup,t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])));return delete r.indexId,n.add(r).next()}deleteFieldIndex(e,t){const n=ah(e),r=hh(e),s=oh(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,t,n){return fa.resolve(to())}getFieldIndex(e,t){return fa.resolve(null)}Oe(e,t){const n=new Ja;for(const s of e.fields.filter(e=>2!==e.kind)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.Ne(s.kind);za.le.Xt(e,r)}return n.Ve()}Me(e){const t=new Ja;return za.le.Xt(e,t.Ne(0)),t.Ve()}getFieldIndexes(e,t){const n=ah(e),r=hh(e);return(t?n.qt(sa.collectionGroupIndex,IDBKeyRange.bound(t,t)):n.qt()).next(e=>{const i=[];return fa.forEach(e,s=>r.get([s.indexId,this.uid]).next(e=>{var t,n,r;i.push((t=s,n=(e=e)?new ks(e.sequenceNumber,new Os(Ma(e.readTime),new ds(Bo(e.documentKey)),e.largestBatchId)):ks.empty(),r=t.fields.map(([e,t])=>new Ds(Jr.fromServerFormat(e),t)),new Cs(t.indexId,t.collectionGroup,r,n)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>e.indexState.sequenceNumber-t.indexState.sequenceNumber),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=ah(e),i=hh(e);return this.$e(e).next(t=>s.qt(sa.collectionGroupIndex,IDBKeyRange.bound(n,n)).next(e=>fa.forEach(e,e=>i.put(function(e,t,n,r){return new ia(e,t.uid||"",n,La(r.readTime),Uo(r.documentKey.path),r.largestBatchId)}(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return fa.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?fa.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),fa.forEach(e,n=>this.Fe(s,t,n).next(e=>{var t=this.Be(r,n);return e.isEqual(t)?fa.resolve():this.Le(s,r,e,t)}))))})}Ue(e,t,n){return oh(e).put(new oa(n.indexId,this.uid,n.arrayValue,n.directionalValue,Uo(t.key.path)))}qe(e,t,n){return oh(e).delete([n.indexId,this.uid,n.arrayValue,n.directionalValue,Uo(t.key.path)])}Fe(e,n,r){const t=oh(e);let s=new Hi(eh);return t.Qt({index:oa.documentKeyIndex,range:IDBKeyRange.only([r.indexId,this.uid,Uo(n.path)])},(e,t)=>{s=s.add(new Za(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}Be(e,t){let n=new Hi(eh);var r=this.Oe(t,e);if(null==r)return n;const s=t.fields.find(e=>2===e.kind);if(null!=s){var i=e.data.field(s.fieldPath);if(Ts(i))for(const s of i.arrayValue.values||[])n=n.add(new Za(t.indexId,e.key,this.Me(s),r))}else n=n.add(new Za(t.indexId,e.key,new Uint8Array,r));return n}Le(t,n,u,e){Tr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const r=[];return function(e,n,r,s){var i=u.getIterator(),o=e.getIterator();let a=Yi(i),h=Yi(o);for(;a||h;){let e=!1,t=!1;if(a&&h){const r=n(a,h);r<0?t=!0:0<r&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(h),h=Yi(o)):t?(s(a),a=Yi(i)):(a=Yi(i),h=Yi(o))}}(e,eh,e=>{r.push(this.Ue(t,n,e))},e=>{r.push(this.qe(t,n,e))}),fa.waitFor(r)}$e(e){let r=1;return hh(e).Qt({index:ia.sequenceNumberIndex,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}}function ih(e){return Sa(e,ea.store)}function oh(e){return Sa(e,oa.store)}function ah(e){return Sa(e,sa.store)}function hh(e){return Sa(e,ia.store)}const uh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ch{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new ch(e,ch.DEFAULT_COLLECTION_PERCENTILE,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function lh(e,t,n){const r=e.store($o.store),s=e.store(Qo.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const h=r.Qt({range:o},(e,t,n)=>(a++,n.delete()));i.push(h.next(()=>{xr(1===a)}));const u=[];for(const e of n.mutations){const r=Qo.key(t,e.key.path,n.batchId);i.push(s.delete(r)),u.push(e.key)}return fa.waitFor(i).next(()=>u)}function dh(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Ar();t=e.noDocument}return JSON.stringify(t).length}ch.DEFAULT_COLLECTION_PERCENTILE=10,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ch.DEFAULT=new ch(41943040,ch.DEFAULT_COLLECTION_PERCENTILE,ch.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ch.DISABLED=new ch(-1,0,0);class fh{constructor(e,t,n,r){this.userId=e,this.O=t,this.indexManager=n,this.referenceDelegate=r,this.Ke={}}static Jt(e,t,n,r){xr(""!==e.uid);var s=e.isAuthenticated()?e.uid:"";return new fh(s,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return mh(e).Qt({index:$o.userMutationsIndex,range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(c,l,d,f){const g=ph(c),m=mh(c);return m.add({}).next(e=>{xr("number"==typeof e);const t=new _a(e,l,d,f),n=(s=this.O,i=this.userId,o=t,a=o.baseMutations.map(e=>Co(s.Ht,e)),h=o.mutations.map(e=>Co(s.Ht,e)),new $o(i,o.batchId,o.localWriteTime.toMillis(),a,h)),r=[];var s,i,o,a,h;let u=new Hi((e,t)=>Br(e.canonicalString(),t.canonicalString()));for(const c of f){const l=Qo.key(this.userId,c.key.path,e);u=u.add(c.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Qo.PLACEHOLDER))}return u.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(c,e))}),c.addOnCommittedListener(()=>{this.Ke[e]=t.keys()}),fa.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return mh(e).get(t).next(e=>e?(xr(e.userId===this.userId),Pa(this.O,e)):null)}Ge(e,n){return this.Ke[n]?fa.resolve(this.Ke[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.Ke[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return mh(e).Qt({index:$o.userMutationsIndex,range:n},(e,t,n)=>{t.userId===this.userId&&(xr(t.batchId>=r),s=Pa(this.O,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return mh(e).Qt({index:$o.userMutationsIndex,range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return mh(e).qt($o.userMutationsIndex,t).next(e=>e.map(e=>Pa(this.O,e)))}getAllMutationBatchesAffectingDocumentKey(o,a){const e=Qo.prefixForPath(this.userId,a.path),t=IDBKeyRange.lowerBound(e),h=[];return ph(o).Qt({range:t},(e,t,n)=>{var[r,s,i]=e,s=Bo(s);if(r===this.userId&&a.path.isEqual(s))return mh(o).get(i).next(e=>{if(!e)throw Ar();xr(e.userId===this.userId),h.push(Pa(this.O,e))});n.done()}).next(()=>h)}getAllMutationBatchesAffectingDocumentKeys(t,e){let a=new Hi(Br);const n=[];return e.forEach(o=>{var e=Qo.prefixForPath(this.userId,o.path),e=IDBKeyRange.lowerBound(e),e=ph(t).Qt({range:e},(e,t,n)=>{var[r,s,i]=e,s=Bo(s);r===this.userId&&o.path.isEqual(s)?a=a.add(i):n.done()});n.push(e)}),fa.waitFor(n).next(()=>this.je(t,a))}getAllMutationBatchesAffectingQuery(e,t){const o=t.path,a=o.length+1,n=Qo.prefixForPath(this.userId,o),r=IDBKeyRange.lowerBound(n);let h=new Hi(Br);return ph(e).Qt({range:r},(e,t,n)=>{var[r,s,i]=e,s=Bo(s);r===this.userId&&o.isPrefixOf(s)?s.length===a&&(h=h.add(i)):n.done()}).next(()=>this.je(e,h))}je(t,e){const n=[],r=[];return e.forEach(e=>{r.push(mh(t).get(e).next(e=>{if(null===e)throw Ar();xr(e.userId===this.userId),n.push(Pa(this.O,e))}))}),fa.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return lh(t.zt,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Qe(n.batchId)}),fa.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Qe(e){delete this.Ke[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return fa.resolve();const t=IDBKeyRange.lowerBound(Qo.prefixForUser(this.userId)),r=[];return ph(n).Qt({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Bo(e[1]);r.push(t)}else n.done()}).next(()=>{xr(0===r.length)})})}containsKey(e,t){return gh(e,this.userId,t)}We(e){return yh(e).get(this.userId).next(e=>e||new Go(this.userId,-1,""))}}function gh(e,i,t){const n=Qo.prefixForPath(i,t.path),o=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return ph(e).Qt({range:r,jt:!0},(e,t,n)=>{var[r,s]=e;r===i&&s===o&&(a=!0),n.done()}).next(()=>a)}function mh(e){return Sa(e,$o.store)}function ph(e){return Sa(e,Qo.store)}function yh(e){return Sa(e,Go.store)}class vh{constructor(e){this.ze=e}next(){return this.ze+=2,this.ze}static He(){return new vh(0)}static Je(){return new vh(-1)}}class wh{constructor(e,t){this.referenceDelegate=e,this.O=t}allocateTargetId(n){return this.Ye(n).next(e=>{const t=new vh(e.highestTargetId);return e.highestTargetId=t.next(),this.Xe(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Ye(e).next(e=>$r.fromTimestamp(new Gr(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Ye(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Ye(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Xe(t,e)))}addTargetData(t,n){return this.Ze(t,n).next(()=>this.Ye(t).next(e=>(e.targetCount+=1,this.tn(n,e),this.Xe(t,e))))}updateTargetData(e,t){return this.Ze(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Ih(t).delete(e.targetId)).next(()=>this.Ye(t)).next(e=>(xr(0<e.targetCount),--e.targetCount,this.Xe(t,e)))}removeTargets(r,s,i){let o=0;const a=[];return Ih(r).Qt((e,t)=>{var n=Fa(t);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(o++,a.push(this.removeTargetData(r,n)))}).next(()=>fa.waitFor(a)).next(()=>o)}forEachTarget(e,r){return Ih(e).Qt((e,t)=>{var n=Fa(t);r(n)})}Ye(e){return bh(e).get(Zo.key).next(e=>(xr(null!==e),e))}Xe(e,t){return bh(e).put(Zo.key,t)}Ze(e,t){return Ih(e).put(Va(this.O,t))}tn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Ye(e).next(e=>e.targetCount)}getTargetData(e,s){var t=Ms(s),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return Ih(e).Qt({range:t,index:Xo.queryTargetsIndexName},(e,t,n)=>{var r=Fa(t);Ps(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const s=[],i=Th(n);return e.forEach(e=>{var t=Uo(e.path);s.push(i.put(new Jo(r,t))),s.push(this.referenceDelegate.addReference(n,r,e))}),fa.waitFor(s)}removeMatchingKeys(n,e,r){const s=Th(n);return fa.forEach(e,e=>{var t=Uo(e.path);return fa.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Th(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Th(e);let s=to();return r.Qt({range:n,jt:!0},(e,t,n)=>{var r=Bo(e[1]),r=new ds(r);s=s.add(r)}).next(()=>s)}containsKey(e,t){var n=Uo(t.path),n=IDBKeyRange.bound([n],[Kr(n)],!1,!0);let r=0;return Th(e).Qt({index:Jo.documentTargetsIndex,jt:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}Tt(e,t){return Ih(e).get(t).next(e=>e?Fa(e):null)}}function Ih(e){return Sa(e,Xo.store)}function bh(e){return Sa(e,Zo.store)}function Th(e){return Sa(e,Jo.store)}async function Eh(e){if(e.code!==Nr.FAILED_PRECONDITION||e.message!==la)throw e;Tr("LocalStore","Unexpectedly lost primary lease")}function Sh([e,t],[n,r]){var s=Br(e,n);return 0===s?Br(t,r):s}class _h{constructor(e){this.en=e,this.buffer=new Hi(Sh),this.nn=0}sn(){return++this.nn}rn(e){var t=[e,this.sn()];if(this.buffer.size<this.en)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Sh(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Ah{constructor(e,t){this.garbageCollector=e,this.asyncQueue=t,this.on=!1,this.cn=null}start(e){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.un(e)}stop(){this.cn&&(this.cn.cancel(),this.cn=null)}get started(){return null!==this.cn}un(e){var t=this.on?3e5:6e4;Tr("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.cn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.cn=null,this.on=!0;try{await e.collectGarbage(this.garbageCollector)}catch(e){va(e)?Tr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await Eh(e)}await this.un(e)})}}class xh{constructor(e,t){this.an=e,this.params=t}calculateTargetCount(e,t){return this.an.hn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return fa.resolve(Ur.A);const n=new _h(t);return this.an.forEachTarget(e,e=>n.rn(e.sequenceNumber)).next(()=>this.an.ln(e,e=>n.rn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.an.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.an.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Tr("LruGarbageCollector","Garbage collection skipped; disabled"),fa.resolve(uh)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Tr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),uh):this.fn(t,n))}getCacheSize(e){return this.an.getCacheSize(e)}fn(t,n){let r,s,i,o,a,h,u;const c=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(Tr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,o=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,a=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,h=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(u=Date.now(),br()<=l.DEBUG&&Tr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-c}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${i} targets in `+(h-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-h)+"ms\n"+`Total Duration: ${u-c}ms`),fa.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class Nh{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new xh(e,t))}hn(e){const n=this.dn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}dn(e){let t=0;return this.ln(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}ln(e,n){return this._n(e,(e,t)=>n(t))}addReference(e,t,n){return Ch(e,n)}removeReference(e,t,n){return Ch(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Ch(e,t)}wn(t,n){let r=!1;return yh(t).Wt(e=>gh(t,e,n).next(e=>(e&&(r=!0),fa.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let o=0;return this._n(n,(t,e)=>{if(e<=r){const r=this.wn(n,t).next(e=>{if(!e)return o++,s.getEntry(n,t).next(()=>(s.removeEntry(t,$r.min()),Th(n).delete([0,Uo(t.path)])))});i.push(r)}}).next(()=>fa.waitFor(i)).next(()=>s.apply(n)).next(()=>o)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Ch(e,t)}_n(e,r){const t=Th(e);let s,i=Ur.A;return t.Qt({index:Jo.documentTargetsIndex},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==Ur.A&&r(new ds(Bo(s)),i),i=n,s=t):i=Ur.A}).next(()=>{i!==Ur.A&&r(new ds(Bo(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Ch(e,t){return Th(e).put((t=t,e=e.currentSequenceNumber,new Jo(0,Uo(t.path),e)))}class Dh{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={}}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){const e=this.mapKeyFn(t),r=this.inner[e];if(void 0!==r){for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n])}else this.inner[e]=[[t,n]]}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1}forEach(r){zr(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return Hr(this.inner)}}class kh{constructor(){this.changes=new Dh(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ns.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?fa.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Oh{constructor(e){this.O=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Mh(e).put(Ph(t),n)}removeEntry(e,t){const n=Mh(e),r=Ph(t);return n.delete(r)}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.mn(t,e)))}getEntry(e,t){return Mh(e).get(Ph(t)).next(e=>this.gn(t,e))}yn(e,t){return Mh(e).get(Ph(t)).next(e=>({document:this.gn(t,e),size:dh(e)}))}getEntries(e,t){let r=Xi;return this.pn(e,t,(e,t)=>{var n=this.gn(e,t);r=r.insert(e,n)}).next(()=>r)}In(e,t){let r=Xi,s=new $i(ds.comparator);return this.pn(e,t,(e,t)=>{var n=this.gn(e,t);r=r.insert(e,n),s=s.insert(e,dh(t))}).next(()=>({documents:r,En:s}))}pn(e,t,s){if(t.isEmpty())return fa.resolve();const n=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),i=t.getIterator();let o=i.getNext();return Mh(e).Qt({range:n},(e,t,n)=>{for(var r=ds.fromSegments(e);o&&ds.comparator(o,r)<0;)s(o,null),o=i.getNext();o&&o.isEqual(r)&&(s(o,t),o=i.hasNext()?i.getNext():null),o?n.Ut(o.path.toArray()):n.done()}).next(()=>{for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})}getAll(e,s,t){let i=Xi;const o=s.length+1,n={};if(t.isEqual($r.min())){const e=s.toArray();n.range=IDBKeyRange.lowerBound(e)}else{const e=s.toArray(),i=Oa(t);n.range=IDBKeyRange.lowerBound([e,i],!0),n.index=Wo.collectionReadTimeIndex}return Mh(e).Qt(n,(e,t,n)=>{var r;e.length===o&&(r=this.gn(ds.fromSegments(e),t),s.isPrefixOf(r.key.path)?i=i.insert(r.key,r):n.done())}).next(()=>i)}newChangeBuffer(e){return new Rh(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Lh(e).get(Yo.key).next(e=>(xr(!!e),e))}mn(e,t){return Lh(e).put(Yo.key,t)}gn(e,t){if(t){const e=Da(this.O,t);if(!e.isNoDocument()||!e.version.isEqual($r.min()))return e}return Ns.newInvalidDocument(e)}}class Rh extends kh{constructor(e,t){super(),this.Tn=e,this.trackRemovals=t,this.An=new Dh(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const o=[];let a=0,h=new Hi((e,t)=>Br(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.An.get(e);if(t.isValidDocument()){var r=ka(this.Tn.O,t);h=h.add(e.path.popLast());var s=dh(r);a+=s-n,o.push(this.Tn.addEntry(i,e,r))}else if(a-=n,this.trackRemovals){const a=ka(this.Tn.O,t.convertToNoDocument($r.min()));o.push(this.Tn.addEntry(i,e,a))}else o.push(this.Tn.removeEntry(i,e))}),h.forEach(e=>{o.push(this.Tn.indexManager.addToCollectionParentIndex(i,e))}),o.push(this.Tn.updateMetadata(i,a)),fa.waitFor(o)}getFromCache(e,t){return this.Tn.yn(e,t).next(e=>(this.An.set(t,e.size),e.document))}getAllFromCache(e,t){return this.Tn.In(e,t).next(({documents:e,En:t})=>(t.forEach((e,t)=>{this.An.set(e,t)}),e))}}function Lh(e){return Sa(e,Yo.store)}function Mh(e){return Sa(e,Wo.store)}function Ph(e){return e.path.toArray()}class Fh{constructor(e){this.O=e}kt(t,n,e,r){const s=new ga("createOrUpgrade",n);var i;e<1&&1<=r&&(t.createObjectStore(Ko.store),(i=t).createObjectStore(Go.store,{keyPath:Go.keyPath}),i.createObjectStore($o.store,{keyPath:$o.keyPath,autoIncrement:!0}).createIndex($o.userMutationsIndex,$o.userMutationsKeyPath,{unique:!0}),i.createObjectStore(Qo.store),Vh(t),t.createObjectStore(Wo.store));let o=fa.resolve();return e<3&&3<=r&&(0!==e&&((i=t).deleteObjectStore(Jo.store),i.deleteObjectStore(Xo.store),i.deleteObjectStore(Zo.store),Vh(t)),o=o.next(()=>function(){const e=s.store(Zo.store),t=new Zo(0,0,$r.min().toTimestamp(),0);return e.put(Zo.key,t)}())),e<4&&4<=r&&(0!==e&&(o=o.next(()=>function(r,s){return s.store($o.store).qt().next(e=>{r.deleteObjectStore($o.store),r.createObjectStore($o.store,{keyPath:$o.keyPath,autoIncrement:!0}).createIndex($o.userMutationsIndex,$o.userMutationsKeyPath,{unique:!0});const t=s.store($o.store),n=e.map(e=>t.put(e));return fa.waitFor(n)})}(t,s))),o=o.next(()=>{t.createObjectStore(ta.store,{keyPath:ta.keyPath})})),e<5&&5<=r&&(o=o.next(()=>this.Rn(s))),e<6&&6<=r&&(o=o.next(()=>(t.createObjectStore(Yo.store),this.Pn(s)))),e<7&&7<=r&&(o=o.next(()=>this.bn(s))),e<8&&8<=r&&(o=o.next(()=>this.vn(t,s))),e<9&&9<=r&&(o=o.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges"),function(){const e=n.objectStore(Wo.store);e.createIndex(Wo.readTimeIndex,Wo.readTimeIndexPath,{unique:!1}),e.createIndex(Wo.collectionReadTimeIndex,Wo.collectionReadTimeIndexPath,{unique:!1})}()})),e<10&&10<=r&&(o=o.next(()=>this.Vn(s))),e<11&&11<=r&&(o=o.next(()=>{t.createObjectStore(na.store,{keyPath:na.keyPath}),t.createObjectStore(ra.store,{keyPath:ra.keyPath})})),e<12&&12<=r&&(o=o.next(()=>{!function(){const e=t.createObjectStore(aa.store,{keyPath:aa.keyPath});e.createIndex(aa.collectionPathOverlayIndex,aa.collectionPathOverlayIndexPath,{unique:!1}),e.createIndex(aa.collectionGroupOverlayIndex,aa.collectionGroupOverlayIndexPath,{unique:!1})}()})),e<13&&13<=r&&(o=o.next(()=>{var e;(e=t).createObjectStore(sa.store,{keyPath:sa.keyPath,autoIncrement:!0}).createIndex(sa.collectionGroupIndex,sa.collectionGroupIndexPath,{unique:!1}),e.createObjectStore(ia.store,{keyPath:ia.keyPath}).createIndex(ia.sequenceNumberIndex,ia.sequenceNumberIndexPath,{unique:!1}),e.createObjectStore(oa.store,{keyPath:oa.keyPath}).createIndex(oa.documentKeyIndex,oa.documentKeyIndexPath,{unique:!1})})),o}Pn(t){let n=0;return t.store(Wo.store).Qt((e,t)=>{n+=dh(t)}).next(()=>{var e=new Yo(n);return t.store(Yo.store).put(Yo.key,e)})}Rn(r){const e=r.store(Go.store),t=r.store($o.store);return e.qt().next(e=>fa.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.qt($o.userMutationsIndex,e).next(e=>fa.forEach(e,e=>{xr(e.userId===n.userId);var t=Pa(this.O,e);return lh(r,n.userId,t).next(()=>{})}))}))}bn(e){const o=e.store(Jo.store),t=e.store(Wo.store);return e.store(Zo.store).get(Zo.key).next(s=>{const i=[];return t.Qt((e,t)=>{const n=new Yr(e),r=[0,Uo(n)];i.push(o.get(r).next(e=>e?fa.resolve():(e=>o.put(new Jo(0,Uo(e),s.highestListenSequenceNumber)))(n)))}).next(()=>fa.waitFor(i))})}vn(e,t){e.createObjectStore(ea.store,{keyPath:ea.keyPath});const n=t.store(ea.store),r=new rh,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Uo(r)})}};return t.store(Wo.store).Qt({jt:!0},(e,t)=>{const n=new Yr(e);return s(n.popLast())}).next(()=>t.store(Qo.store).Qt({jt:!0},([,e],t)=>{const n=Bo(e);return s(n.popLast())}))}Vn(e){const r=e.store(Xo.store);return r.Qt((e,t)=>{var n=Fa(t),n=Va(this.O,n);return r.put(n)})}}function Vh(e){e.createObjectStore(Jo.store,{keyPath:Jo.keyPath}).createIndex(Jo.documentTargetsIndex,Jo.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(Xo.store,{keyPath:Xo.keyPath}).createIndex(Xo.queryTargetsIndexName,Xo.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(Zo.store)}const Uh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class qh{constructor(e,t,n,r,s,i,o,a,h,u,c=12){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Sn=s,this.window=i,this.document=o,this.Dn=h,this.Cn=u,this.schemaVersion=c,this.Nn=null,this.xn=!1,this.isPrimary=!1,this.networkEnabled=!0,this.kn=null,this.inForeground=!1,this.On=null,this.Mn=null,this.$n=Number.NEGATIVE_INFINITY,this.Fn=e=>Promise.resolve(),!qh.Vt())throw new Cr(Nr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Nh(this,r),this.Bn=t+"main",this.O=new Ca(a),this.Ln=new ma(this.Bn,this.schemaVersion,new Fh(this.O)),this.Un=new wh(this.referenceDelegate,this.O),this.qn=(a=this.O,new Oh(a)),this.Kn=new ja,this.window&&this.window.localStorage?this.Gn=this.window.localStorage:(this.Gn=null,!1===u&&Er("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.jn().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Cr(Nr.FAILED_PRECONDITION,Uh);return this.Qn(),this.Wn(),this.zn(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Un.getHighestSequenceNumber(e))}).then(e=>{this.Nn=new Ur(e,this.Dn)}).then(()=>{this.xn=!0}).catch(e=>(this.Ln&&this.Ln.close(),Promise.reject(e)))}Hn(t){return this.Fn=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ln.Mt(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Sn.enqueueAndForget(async()=>{this.started&&await this.jn()}))}jn(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>jh(t).put(new ta(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.Jn(t).next(e=>{e||(this.isPrimary=!1,this.Sn.enqueueRetryable(()=>this.Fn(!1)))})}).next(()=>this.Yn(t)).next(e=>this.isPrimary&&!e?this.Xn(t).next(()=>!1):!!e&&this.Zn(t).next(()=>!0))).catch(e=>{if(va(e))return Tr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Tr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Sn.enqueueRetryable(()=>this.Fn(e)),this.isPrimary=e})}Jn(e){return Bh(e).get(Ko.key).next(e=>fa.resolve(this.ts(e)))}es(e){return jh(e).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.ss(this.$n,18e5)){this.$n=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=Sa(e,ta.store);return r.qt().next(e=>{const t=this.rs(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return fa.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Gn)for(const t of e)this.Gn.removeItem(this.os(t.clientId))}}zn(){this.Mn=this.Sn.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.jn().then(()=>this.ns()).then(()=>this.zn()))}ts(e){return!!e&&e.ownerId===this.clientId}Yn(t){return this.Cn?fa.resolve(!0):Bh(t).get(Ko.key).next(e=>{if(null!==e&&this.ss(e.leaseTimestampMs,5e3)&&!this.cs(e.ownerId)){if(this.ts(e)&&this.networkEnabled)return!0;if(!this.ts(e)){if(!e.allowTabSynchronization)throw new Cr(Nr.FAILED_PRECONDITION,Uh);return!1}}return!(!this.networkEnabled||!this.inForeground)||jh(t).qt().next(e=>void 0===this.rs(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Tr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.xn=!1,this.us(),this.Mn&&(this.Mn.cancel(),this.Mn=null),this.hs(),this.ls(),await this.Ln.runTransaction("shutdown","readwrite",[Ko.store,ta.store],e=>{const t=new Ea(e,Ur.A);return this.Xn(t).next(()=>this.es(t))}),this.Ln.close(),this.fs()}rs(e,t){return e.filter(e=>this.ss(e.updateTimeMs,t)&&!this.cs(e.clientId))}ds(){return this.runTransaction("getActiveClients","readonly",e=>jh(e).qt().next(e=>this.rs(e,18e5).map(e=>e.clientId)))}get started(){return this.xn}getMutationQueue(e,t){return fh.Jt(e,this.O,t,this.referenceDelegate)}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getIndexManager(e){return new sh(e)}getDocumentOverlayCache(e){return $a.Jt(this.O,e)}getBundleCache(){return this.Kn}runTransaction(t,n,r){Tr("IndexedDbPersistence","Starting transaction:",t);var e,s="readonly"===n?"readonly":"readwrite",e=13===(e=this.schemaVersion)?ca:12===e?ua:11===e?ha:void Ar();let i;return this.Ln.runTransaction(t,s,e,e=>(i=new Ea(e,this.Nn?this.Nn.next():Ur.A),"readwrite-primary"===n?this.Jn(i).next(e=>!!e||this.Yn(i)).next(e=>{if(!e)throw Er(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Sn.enqueueRetryable(()=>this.Fn(!1)),new Cr(Nr.FAILED_PRECONDITION,la);return r(i)}).next(e=>this.Zn(i).next(()=>e)):this._s(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}_s(e){return Bh(e).get(Ko.key).next(e=>{if(null!==e&&this.ss(e.leaseTimestampMs,5e3)&&!this.cs(e.ownerId)&&!this.ts(e)&&!(this.Cn||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Cr(Nr.FAILED_PRECONDITION,Uh)})}Zn(e){var t=new Ko(this.clientId,this.allowTabSynchronization,Date.now());return Bh(e).put(Ko.key,t)}static Vt(){return ma.Vt()}Xn(e){const t=Bh(e);return t.get(Ko.key).next(e=>this.ts(e)?(Tr("IndexedDbPersistence","Releasing primary lease."),t.delete(Ko.key)):fa.resolve())}ss(e,t){var n=Date.now();return!(e<n-t||n<e&&(Er(`Detected an update time that is in the future: ${e} > ${n}`),1))}Qn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.On=()=>{this.Sn.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.jn()))},this.document.addEventListener("visibilitychange",this.On),this.inForeground="visible"===this.document.visibilityState)}hs(){this.On&&(this.document.removeEventListener("visibilitychange",this.On),this.On=null)}Wn(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.kn=()=>{this.us(),s()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Sn.enterRestrictedMode(!0),this.Sn.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.kn))}ls(){this.kn&&(this.window.removeEventListener("pagehide",this.kn),this.kn=null)}cs(e){var t;try{var n=null!==(null===(t=this.Gn)||void 0===t?void 0:t.getItem(this.os(e)));return Tr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Er("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}us(){if(this.Gn)try{this.Gn.setItem(this.os(this.clientId),String(Date.now()))}catch(e){Er("Failed to set zombie client id.",e)}}fs(){if(this.Gn)try{this.Gn.removeItem(this.os(this.clientId))}catch(e){}}os(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Bh(e){return Sa(e,Ko.store)}function jh(e){return Sa(e,ta.store)}function Kh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Gh{constructor(e,t){this.progress=e,this.ws=t}}class $h{constructor(e,t,n){this.qn=e,this.gs=t,this.indexManager=n}ys(t,n){return this.gs.getAllMutationBatchesAffectingDocumentKey(t,n).next(e=>this.ps(t,n,e))}ps(e,t,n){return this.qn.getEntry(e,t).next(e=>{for(const t of n)t.applyToLocalView(e);return e})}Is(e,n){e.forEach((e,t)=>{for(const e of n)e.applyToLocalView(t)})}Es(t,e){return this.qn.getEntries(t,e).next(e=>this.Ts(t,e).next(()=>e))}Ts(e,t){return this.gs.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>this.Is(t,e))}As(e,t,n){return r=t,ds.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.Rs(e,t.path):si(t)?this.Ps(e,t,n):this.bs(e,t,n);var r}Rs(e,t){return this.ys(e,new ds(t)).next(e=>{let t=Ji;return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}Ps(r,s,i){const o=s.collectionGroup;let a=Ji;return this.indexManager.getCollectionParents(r,o).next(e=>fa.forEach(e,e=>{var t,n=(t=s,e=e.child(o),new Xs(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.bs(r,n,i).next(e=>{e.forEach((e,t)=>{a=a.insert(e,t)})})}).next(()=>a))}bs(t,n,e){let s;return this.qn.getAll(t,n.path,e).next(e=>(s=e,this.gs.getAllMutationBatchesAffectingQuery(t,n))).next(t=>{for(const r of t)for(const t of r.mutations){var n=t.key;let e=s.get(n);null==e&&(e=Ns.newInvalidDocument(n),s=s.insert(n,e)),Oi(t,e,r.localWriteTime),e.isFoundDocument()||(s=s.remove(n))}}).next(()=>(s.forEach((e,t)=>{li(n,t)||(s=s.remove(e))}),s))}}class Qh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.vs=n,this.Vs=r}static Ss(e,t){let n=to(),r=to();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Qh(e,t.fromCache,n,r)}}class zh{Ds(e){this.Cs=e}As(t,r,s,i){return 0===(e=r).filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())||s.isEqual($r.min())?this.Ns(t,r):this.Cs.Es(t,i).next(e=>{const n=this.xs(r,e);return(ei(r)||ti(r))&&this.ks(r.limitType,n,i,s)?this.Ns(t,r):(br()<=l.DEBUG&&Tr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),ci(r)),this.Cs.As(t,r,s).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t)))});var e}xs(n,e){let r=new Hi(di(n));return e.forEach((e,t)=>{li(n,t)&&(r=r.add(t))}),r}ks(e,t,n,r){if(n.size!==t.size)return!0;const s="F"===e?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Ns(e,t){return br()<=l.DEBUG&&Tr("QueryEngine","Using full collection scan to execute query:",ci(t)),this.Cs.As(e,t,$r.min())}}class Hh{constructor(e,t,n,r){this.persistence=e,this.Os=t,this.O=r,this.Ms=new $i(Br),this.$s=new Dh(e=>Ms(e),Ps),this.Fs=$r.min(),this.Bs=e.getRemoteDocumentCache(),this.Un=e.getTargetCache(),this.Kn=e.getBundleCache(),this.Ls(n)}Ls(e){this.indexManager=this.persistence.getIndexManager(e),this.gs=this.persistence.getMutationQueue(e,this.indexManager),this.Us=new $h(this.Bs,this.gs,this.indexManager),this.Bs.setIndexManager(this.indexManager),this.Os.Ds(this.Us)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Ms))}}function Wh(e,t,n,r){return new Hh(e,t,n,r)}async function Yh(e,t){const o=e;return o.persistence.runTransaction("Handle user change","readonly",s=>{let i;return o.gs.getAllMutationBatches(s).next(e=>(i=e,o.Ls(t),o.gs.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=to();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return o.Us.Es(s,r).next(e=>({qs:e,removedBatchIds:t,addedBatchIds:n}))})})}function Xh(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Un.getLastRemoteSnapshotVersion(e))}function Jh(e,u){const c=e,l=u.snapshotVersion;let d=c.Ms;return c.persistence.runTransaction("Apply remote event","readwrite-primary",a=>{const e=c.Bs.newChangeBuffer({trackRemovals:!0});d=c.Ms;const h=[];u.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){h.push(c.Un.removeMatchingKeys(a,t.removedDocuments,n).next(()=>c.Un.addMatchingKeys(a,t.addedDocuments,n)));let e=r.withSequenceNumber(a.currentSequenceNumber);var s,i,o;u.targetMismatches.has(n)?e=e.withResumeToken(es.EMPTY_BYTE_STRING,$r.min()).withLastLimboFreeSnapshotVersion($r.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,o=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<o.addedDocuments.size+o.modifiedDocuments.size+o.removedDocuments.size)||h.push(c.Un.updateTargetData(a,e))}});let t=Xi;if(u.documentUpdates.forEach(e=>{u.resolvedLimboDocuments.has(e)&&h.push(c.persistence.referenceDelegate.updateLimboDocument(a,e))}),h.push(Zh(a,e,u.documentUpdates).next(e=>{t=e})),!l.isEqual($r.min())){const u=c.Un.getLastRemoteSnapshotVersion(a).next(e=>c.Un.setTargetsMetadata(a,a.currentSequenceNumber,l));h.push(u)}return fa.waitFor(h).next(()=>e.apply(a)).next(()=>c.Us.Ts(a,t)).next(()=>t)}).then(e=>(c.Ms=d,e))}function Zh(e,i,t){let n=to();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=Xi;return t.forEach((e,t)=>{const n=r.get(e);t.isNoDocument()&&t.version.isEqual($r.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):Tr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),s})}function eu(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Un.getTargetData(t,r).next(e=>e?(n=e,fa.resolve(n)):s.Un.allocateTargetId(t).next(e=>(n=new Na(r,e,0,t.currentSequenceNumber),s.Un.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.Ms.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.Ms=s.Ms.insert(e.targetId,e),s.$s.set(r,e.targetId)),e})}async function tu(e,t,n){const r=e,s=r.Ms.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!va(e))throw e;Tr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ms=r.Ms.remove(t),r.$s.delete(s.target)}function nu(e,n,r){const s=e;let i=$r.min(),o=to();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.$s.get(n);return void 0!==s?fa.resolve(r.Ms.get(s)):r.Un.getTargetData(t,n)}(s,t,oi(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Un.getMatchingKeysForTargetId(t,e.targetId).next(e=>{o=e})}).next(()=>s.Os.As(t,n,r?i:$r.min(),r?o:to())).next(e=>({documents:e,Ks:o})))}function ru(e,t){const n=e,r=n.Un,s=n.Ms.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.Tt(e,t).next(e=>e?e.target:null))}function su(e){const n=e;return n.persistence.runTransaction("Get new document changes","readonly",e=>function(e,t,n){const r=e;let s=Xi,i=Oa(n);const o=Mh(t),a=IDBKeyRange.lowerBound(i,!0);return o.Qt({index:Wo.readTimeIndex,range:a},(e,t)=>{var n=Da(r.O,t);s=s.insert(n.key,n),i=t.readTime}).next(()=>({ws:s,readTime:Ra(i)}))}(n.Bs,e,n.Fs)).then(({ws:e,readTime:t})=>(n.Fs=t,e))}class iu{constructor(e){this.O=e,this.Ws=new Map,this.zs=new Map}getBundleMetadata(e,t){return fa.resolve(this.Ws.get(t))}saveBundleMetadata(e,t){return this.Ws.set(t.id,{id:t.id,version:t.version,createTime:vo(t.createTime)}),fa.resolve()}getNamedQuery(e,t){return fa.resolve(this.zs.get(t))}saveNamedQuery(e,t){return this.zs.set(t.name,{name:(t=t).name,query:Ua(t.bundledQuery),readTime:vo(t.readTime)}),fa.resolve()}}class ou{constructor(){this.overlays=new $i(ds.comparator),this.Hs=new Map}getOverlay(e,t){return fa.resolve(this.overlays.get(t))}saveOverlays(t,n,e){return e.forEach(e=>{this.Yt(t,n,e)}),fa.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Hs.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Hs.delete(n)),fa.resolve()}getOverlaysForCollection(e,t,n){const r=new Map,s=t.length+1,i=new ds(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return fa.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new $i((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=new Map,s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=new Map,a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach((e,t)=>o.set(t,e)),!(o.size>=r)););return fa.resolve(o)}Yt(e,t,n){if(null!==n){var r=this.overlays.get(n.key);null!==r&&this.Hs.get(r.largestBatchId).delete(n.key),this.overlays=this.overlays.insert(n.key,new xa(t,n));let e=this.Hs.get(t);void 0===e&&(e=new Set,this.Hs.set(t,e)),e.add(n.key)}}}class au{constructor(){this.Js=new Hi(hu.Ys),this.Xs=new Hi(hu.Zs)}isEmpty(){return this.Js.isEmpty()}addReference(e,t){var n=new hu(e,t);this.Js=this.Js.add(n),this.Xs=this.Xs.add(n)}ti(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.ei(new hu(e,t))}ni(e,t){e.forEach(e=>this.removeReference(e,t))}si(e){const t=new ds(new Yr([])),n=new hu(t,e),r=new hu(t,e+1),s=[];return this.Xs.forEachInRange([n,r],e=>{this.ei(e),s.push(e.key)}),s}ii(){this.Js.forEach(e=>this.ei(e))}ei(e){this.Js=this.Js.delete(e),this.Xs=this.Xs.delete(e)}ri(e){var t=new ds(new Yr([])),n=new hu(t,e),t=new hu(t,e+1);let r=to();return this.Xs.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new hu(e,0),t=this.Js.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class hu{constructor(e,t){this.key=e,this.oi=t}static Ys(e,t){return ds.comparator(e.key,t.key)||Br(e.oi,t.oi)}static Zs(e,t){return Br(e.oi,t.oi)||ds.comparator(e.key,t.key)}}class uu{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.gs=[],this.ci=1,this.ui=new Hi(hu.Ys)}checkEmpty(e){return fa.resolve(0===this.gs.length)}addMutationBatch(e,t,n,r){var s=this.ci;this.ci++,0<this.gs.length&&this.gs[this.gs.length-1];var i=new _a(s,t,n,r);this.gs.push(i);for(const t of r)this.ui=this.ui.add(new hu(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return fa.resolve(i)}lookupMutationBatch(e,t){return fa.resolve(this.ai(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.hi(t+1),n=n<0?0:n;return fa.resolve(this.gs.length>n?this.gs[n]:null)}getHighestUnacknowledgedBatchId(){return fa.resolve(0===this.gs.length?-1:this.ci-1)}getAllMutationBatches(e){return fa.resolve(this.gs.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new hu(t,0),r=new hu(t,Number.POSITIVE_INFINITY),s=[];return this.ui.forEachInRange([n,r],e=>{var t=this.ai(e.oi);s.push(t)}),fa.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new Hi(Br);return t.forEach(e=>{var t=new hu(e,0),n=new hu(e,Number.POSITIVE_INFINITY);this.ui.forEachInRange([t,n],e=>{r=r.add(e.oi)})}),fa.resolve(this.li(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;ds.isDocumentKey(s)||(s=s.child(""));var i=new hu(new ds(s),0);let o=new Hi(Br);return this.ui.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.oi)),!0)},i),fa.resolve(this.li(o))}li(e){const n=[];return e.forEach(e=>{var t=this.ai(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){xr(0===this.fi(r.batchId,"removed")),this.gs.shift();let s=this.ui;return fa.forEach(r.mutations,e=>{var t=new hu(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.ui=s})}Qe(e){}containsKey(e,t){var n=new hu(t,0),n=this.ui.firstAfterOrEqual(n);return fa.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.gs.length,fa.resolve()}fi(e,t){return this.hi(e)}hi(e){return 0===this.gs.length?0:e-this.gs[0].batchId}ai(e){var t=this.hi(e);return t<0||t>=this.gs.length?null:this.gs[t]}}class cu{constructor(e){this.di=e,this.docs=new $i(ds.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.di(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return fa.resolve(n?n.document.mutableCopy():Ns.newInvalidDocument(t))}getEntries(e,t){let n=Xi;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Ns.newInvalidDocument(e))}),fa.resolve(n)}getAll(e,t,n){let r=Xi;const s=new ds(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||s.readTime.compareTo(n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return fa.resolve(r)}_i(e,t){return fa.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new lu(this)}getSize(e){return fa.resolve(this.size)}}class lu extends kh{constructor(e){super(),this.Tn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.Tn.addEntry(n,t)):this.Tn.removeEntry(e)}),fa.waitFor(r)}getFromCache(e,t){return this.Tn.getEntry(e,t)}getAllFromCache(e,t){return this.Tn.getEntries(e,t)}}class du{constructor(e){this.persistence=e,this.wi=new Dh(e=>Ms(e),Ps),this.lastRemoteSnapshotVersion=$r.min(),this.highestTargetId=0,this.mi=0,this.gi=new au,this.targetCount=0,this.yi=vh.He()}forEachTarget(e,n){return this.wi.forEach((e,t)=>n(t)),fa.resolve()}getLastRemoteSnapshotVersion(e){return fa.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return fa.resolve(this.mi)}allocateTargetId(e){return this.highestTargetId=this.yi.next(),fa.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.mi&&(this.mi=t),fa.resolve()}Ze(e){this.wi.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.yi=new vh(t),this.highestTargetId=t),e.sequenceNumber>this.mi&&(this.mi=e.sequenceNumber)}addTargetData(e,t){return this.Ze(t),this.targetCount+=1,fa.resolve()}updateTargetData(e,t){return this.Ze(t),fa.resolve()}removeTargetData(e,t){return this.wi.delete(t.target),this.gi.si(t.targetId),--this.targetCount,fa.resolve()}removeTargets(n,r,s){let i=0;const o=[];return this.wi.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.wi.delete(e),o.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),fa.waitFor(o).next(()=>i)}getTargetCount(e){return fa.resolve(this.targetCount)}getTargetData(e,t){var n=this.wi.get(t)||null;return fa.resolve(n)}addMatchingKeys(e,t,n){return this.gi.ti(t,n),fa.resolve()}removeMatchingKeys(t,e,n){this.gi.ni(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),fa.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.gi.si(t),fa.resolve()}getMatchingKeysForTargetId(e,t){var n=this.gi.ri(t);return fa.resolve(n)}containsKey(e,t){return fa.resolve(this.gi.containsKey(t))}}class fu{constructor(e,t){this.pi={},this.overlays={},this.Nn=new Ur(0),this.xn=!1,this.xn=!0,this.referenceDelegate=e(this),this.Un=new du(this),this.indexManager=new nh,this.qn=(e=e=>this.referenceDelegate.Ii(e),new cu(e)),this.O=new Ca(t),this.Kn=new iu(this.O)}start(){return Promise.resolve()}shutdown(){return this.xn=!1,Promise.resolve()}get started(){return this.xn}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new ou,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.pi[e.toKey()];return n||(n=new uu(t,this.referenceDelegate),this.pi[e.toKey()]=n),n}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getBundleCache(){return this.Kn}runTransaction(e,t,n){Tr("MemoryPersistence","Starting transaction:",e);const r=new gu(this.Nn.next());return this.referenceDelegate.Ei(),n(r).next(e=>this.referenceDelegate.Ti(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ai(t,n){return fa.or(Object.values(this.pi).map(e=>()=>e.containsKey(t,n)))}}class gu extends da{constructor(e){super(),this.currentSequenceNumber=e}}class mu{constructor(e){this.persistence=e,this.Ri=new au,this.Pi=null}static bi(e){return new mu(e)}get vi(){if(this.Pi)return this.Pi;throw Ar()}addReference(e,t,n){return this.Ri.addReference(n,t),this.vi.delete(n.toString()),fa.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.vi.add(n.toString()),fa.resolve()}markPotentiallyOrphaned(e,t){return this.vi.add(t.toString()),fa.resolve()}removeTarget(e,t){this.Ri.si(t.targetId).forEach(e=>this.vi.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.vi.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ei(){this.Pi=new Set}Ti(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return fa.forEach(this.vi,e=>{const t=ds.fromPath(e);return this.Vi(n,t).next(e=>{e||r.removeEntry(t,$r.min())})}).next(()=>(this.Pi=null,r.apply(n)))}updateLimboDocument(e,t){return this.Vi(e,t).next(e=>{e?this.vi.delete(t.toString()):this.vi.add(t.toString())})}Ii(e){return 0}Vi(e,t){return fa.or([()=>fa.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}function pu(e,t){return`firestore_clients_${e}_${t}`}function yu(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function vu(e,t){return`firestore_targets_${e}_${t}`}class wu{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Si(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Cr(r.error.code,r.error.message))),i?new wu(e,t,r.state,s):(Er("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Di(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Iu{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Si(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Cr(n.error.code,n.error.message))),s?new Iu(e,n.state,r):(Er("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Di(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class bu{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Si(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=no;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ls(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new bu(e,s):(Er("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Tu{constructor(e,t){this.clientId=e,this.onlineState=t}static Si(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Tu(t.clientId,t.onlineState):(Er("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Eu{constructor(){this.activeTargetIds=no}Ci(e){this.activeTargetIds=this.activeTargetIds.add(e)}Ni(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Di(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Su{constructor(e,t,n,r,s){this.window=e,this.Sn=t,this.persistenceKey=n,this.xi=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ki=this.Oi.bind(this),this.Mi=new $i(Br),this.started=!1,this.$i=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Fi=pu(this.persistenceKey,this.xi),this.Bi=`firestore_sequence_number_${this.persistenceKey}`,this.Mi=this.Mi.insert(this.xi,new Eu),this.Li=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ui=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.qi=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Ki=`firestore_online_state_${this.persistenceKey}`,this.Gi=`firestore_bundle_loaded_${this.persistenceKey}`,this.window.addEventListener("storage",this.ki)}static Vt(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.ds();for(const n of e)if(n!==this.xi){const e=this.getItem(pu(this.persistenceKey,n));var t;!e||(t=bu.Si(n,e))&&(this.Mi=this.Mi.insert(t.clientId,t))}this.ji();const n=this.storage.getItem(this.Ki);if(n){const e=this.Qi(n);e&&this.Wi(e)}for(const e of this.$i)this.Oi(e);this.$i=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bi,JSON.stringify(e))}getAllActiveQueryTargets(){return this.zi(this.Mi)}isActiveQueryTarget(n){let r=!1;return this.Mi.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Hi(e,"pending")}updateMutationState(e,t,n){this.Hi(e,t,n),this.Ji(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(vu(this.persistenceKey,e)))||(n=Iu.Si(e,n))&&(t=n.state)),this.Yi.Ci(e),this.ji(),t}removeLocalQueryTarget(e){this.Yi.Ni(e),this.ji()}isLocalQueryTarget(e){return this.Yi.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(vu(this.persistenceKey,e))}updateQueryState(e,t,n){this.Xi(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Ji(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Zi(e)}notifyBundleLoaded(){this.tr()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ki),this.removeItem(this.Fi),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Tr("SharedClientState","READ",e,t),t}setItem(e,t){Tr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Tr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}Oi(e){const r=e;r.storageArea===this.storage&&(Tr("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.Fi?this.Sn.enqueueRetryable(async()=>{if(this.started){if(null!==r.key)if(this.Li.test(r.key)){if(null==r.newValue){var e=this.er(r.key);return this.nr(e,null)}e=this.sr(r.key,r.newValue);if(e)return this.nr(e.clientId,e)}else if(this.Ui.test(r.key)){if(null!==r.newValue){var t=this.ir(r.key,r.newValue);if(t)return this.rr(t)}}else if(this.qi.test(r.key)){if(null!==r.newValue){t=this.cr(r.key,r.newValue);if(t)return this.ur(t)}}else if(r.key===this.Ki){if(null!==r.newValue){var n=this.Qi(r.newValue);if(n)return this.Wi(n)}}else if(r.key===this.Bi){n=function(e){let t=Ur.A;if(null!=e)try{var n=JSON.parse(e);xr("number"==typeof n),t=n}catch(e){Er("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(r.newValue);n!==Ur.A&&this.sequenceNumberHandler(n)}else if(r.key===this.Gi)return this.syncEngine.ar()}else this.$i.push(r)}):Er("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Yi(){return this.Mi.get(this.xi)}ji(){this.setItem(this.Fi,this.Yi.Di())}Hi(e,t,n){const r=new wu(this.currentUser,e,t,n),s=yu(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Di())}Ji(e){var t=yu(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Zi(e){var t={clientId:this.xi,onlineState:e};this.storage.setItem(this.Ki,JSON.stringify(t))}Xi(e,t,n){const r=vu(this.persistenceKey,e),s=new Iu(e,t,n);this.setItem(r,s.Di())}tr(){this.setItem(this.Gi,"value-not-used")}er(e){var t=this.Li.exec(e);return t?t[1]:null}sr(e,t){var n=this.er(e);return bu.Si(n,t)}ir(e,t){var n=this.Ui.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return wu.Si(new vr(n),r,t)}cr(e,t){var n=this.qi.exec(e),n=Number(n[1]);return Iu.Si(n,t)}Qi(e){return Tu.Si(e)}async rr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.hr(e.batchId,e.state,e.error);Tr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}ur(e){return this.syncEngine.lr(e.targetId,e.state,e.error)}nr(e,t){const n=t?this.Mi.insert(e,t):this.Mi.remove(e),r=this.zi(this.Mi),s=this.zi(n),i=[],o=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||o.push(e)}),this.syncEngine.dr(i,o).then(()=>{this.Mi=n})}Wi(e){this.Mi.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}zi(e){let n=no;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class _u{constructor(){this._r=new Eu,this.wr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this._r.Ci(e),this.wr[e]||"not-current"}updateQueryState(e,t,n){this.wr[e]=t}removeLocalQueryTarget(e){this._r.Ni(e)}isLocalQueryTarget(e){return this._r.activeTargetIds.has(e)}clearQueryState(e){delete this.wr[e]}getAllActiveQueryTargets(){return this._r.activeTargetIds}isActiveQueryTarget(e){return this._r.activeTargetIds.has(e)}start(){return this._r=new Eu,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(){}}class Au{mr(e){}shutdown(){}}class xu{constructor(){this.gr=()=>this.yr(),this.pr=()=>this.Ir(),this.Er=[],this.Tr()}mr(e){this.Er.push(e)}shutdown(){window.removeEventListener("online",this.gr),window.removeEventListener("offline",this.pr)}Tr(){window.addEventListener("online",this.gr),window.addEventListener("offline",this.pr)}yr(){Tr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Er)e(0)}Ir(){Tr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Er)e(1)}static Vt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Nu={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Cu{constructor(e){this.Ar=e.Ar,this.Rr=e.Rr}Pr(e){this.br=e}vr(e){this.Vr=e}onMessage(e){this.Sr=e}close(){this.Rr()}send(e){this.Ar(e)}Dr(){this.br()}Cr(e){this.Vr(e)}Nr(e){this.Sr(e)}}class Du extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.kr=t+"://"+e.host,this.Or="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Mr(t,e,n,r,s){const i=this.$r(t,e);Tr("RestConnection","Sending: ",i,n);var o={};return this.Fr(o,r,s),this.Br(t,i,o,n).then(e=>(Tr("RestConnection","Received: ",e),e),e=>{throw Sr("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e})}Lr(e,t,n,r,s){return this.Mr(e,t,n,r,s)}Fr(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+wr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}$r(e,t){var n=Nu[e];return`${this.kr}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}Br(a,t,n,r){return new Promise((s,i)=>{const o=new pr;o.listenOnce(cr.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case ur.NO_ERROR:var e=o.getResponseJson();Tr("Connection","XHR received:",JSON.stringify(e)),s(e);break;case ur.TIMEOUT:Tr("Connection",'RPC "'+a+'" timed out'),i(new Cr(Nr.DEADLINE_EXCEEDED,"Request time out"));break;case ur.HTTP_ERROR:var t,n=o.getStatus();if(Tr("Connection",'RPC "'+a+'" failed with status:',n,"response text:",o.getResponseText()),0<n){const a=o.getResponseJson().error;a&&a.status&&a.message?(r=a.status.toLowerCase().replace(/_/g,"-"),t=0<=Object.values(Nr).indexOf(r)?r:Nr.UNKNOWN,i(new Cr(t,a.message))):i(new Cr(Nr.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Cr(Nr.UNAVAILABLE,"Connection failed."));break;default:Ar()}}finally{Tr("Connection",'RPC "'+a+'" completed.')}var r});var e=JSON.stringify(r);o.send(t,"POST",e,n,15)})}Ur(e,t,n){const r=[this.kr,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new nr,i=hr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new gr({})),this.Fr(o.initMessageHeaders,t,n),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(f())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=f().indexOf("Electron/")||function(){const e=f();return 0<=e.indexOf("MSIE ")||0<=e.indexOf("Trident/")}()||0<=f().indexOf("MSAppHost/")||"object"==typeof(a="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==a.id||(o.httpHeadersOverwriteParam="$httpHeaders");var a=r.join("");Tr("Connection","Creating WebChannel: "+a,o);const h=s.createWebChannel(a,o);let u=!1,c=!1;const l=new Cu({Ar:e=>{c?Tr("Connection","Not sending because WebChannel is closed:",e):(u||(Tr("Connection","Opening WebChannel transport."),h.open(),u=!0),Tr("Connection","WebChannel sending:",e),h.send(e))},Rr:()=>h.close()}),d=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return d(h,mr.EventType.OPEN,()=>{c||Tr("Connection","WebChannel transport opened.")}),d(h,mr.EventType.CLOSE,()=>{c||(c=!0,Tr("Connection","WebChannel transport closed"),l.Cr())}),d(h,mr.EventType.ERROR,e=>{c||(c=!0,Sr("Connection","WebChannel transport errored:",e),l.Cr(new Cr(Nr.UNAVAILABLE,"The operation could not be completed")))}),d(h,mr.EventType.MESSAGE,n=>{if(!c){var e=n.data[0];xr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Tr("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){var t=ar[e];if(void 0!==t)return Gi(t)}(n),t=r.message;void 0===e&&(e=Nr.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,l.Cr(new Cr(e,t)),h.close()}else Tr("Connection","WebChannel received:",e),l.Nr(e)}}),d(i,lr.STAT_EVENT,e=>{e.stat===dr?Tr("Connection","Detected buffering proxy"):e.stat===fr&&Tr("Connection","Detected no buffering proxy")}),setTimeout(()=>{l.Dr()},0),l}}function ku(){return"undefined"!=typeof window?window:null}function Ou(){return"undefined"!=typeof document?document:null}function Ru(e){return new mo(e,!0)}class Lu{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Sn=e,this.timerId=t,this.qr=n,this.Kr=r,this.Gr=s,this.jr=0,this.Qr=null,this.Wr=Date.now(),this.reset()}reset(){this.jr=0}zr(){this.jr=this.Gr}Hr(e){this.cancel();var t=Math.floor(this.jr+this.Jr()),n=Math.max(0,Date.now()-this.Wr),r=Math.max(0,t-n);0<r&&Tr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.jr} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Qr=this.Sn.enqueueAfterDelay(this.timerId,r,()=>(this.Wr=Date.now(),e())),this.jr*=this.Kr,this.jr<this.qr&&(this.jr=this.qr),this.jr>this.Gr&&(this.jr=this.Gr)}Yr(){null!==this.Qr&&(this.Qr.skipDelay(),this.Qr=null)}cancel(){null!==this.Qr&&(this.Qr.cancel(),this.Qr=null)}Jr(){return(Math.random()-.5)*this.jr}}class Mu{constructor(e,t,n,r,s,i,o,a){this.Sn=e,this.Xr=n,this.Zr=r,this.eo=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.no=0,this.so=null,this.io=null,this.stream=null,this.ro=new Lu(e,t)}oo(){return 1===this.state||5===this.state||this.co()}co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.uo()}async stop(){this.oo()&&await this.close(0)}ao(){this.state=0,this.ro.reset()}ho(){this.co()&&null===this.so&&(this.so=this.Sn.enqueueAfterDelay(this.Xr,6e4,()=>this.lo()))}fo(e){this._o(),this.stream.send(e)}async lo(){if(this.co())return this.close(0)}_o(){this.so&&(this.so.cancel(),this.so=null)}wo(){this.io&&(this.io.cancel(),this.io=null)}async close(e,t){this._o(),this.wo(),this.ro.cancel(),this.no++,4!==e?this.ro.reset():t&&t.code===Nr.RESOURCE_EXHAUSTED?(Er(t.toString()),Er("Using maximum backoff delay to prevent overloading the backend."),this.ro.zr()):t&&t.code===Nr.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.mo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.vr(t)}mo(){}auth(){this.state=1;const e=this.yo(this.no),n=this.no;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.no===n&&this.po(e,t)},t=>{e(()=>{var e=new Cr(Nr.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Io(e)})})}po(e,t){const n=this.yo(this.no);this.stream=this.Eo(e,t),this.stream.Pr(()=>{n(()=>(this.state=2,this.io=this.Sn.enqueueAfterDelay(this.Zr,1e4,()=>(this.co()&&(this.state=3),Promise.resolve())),this.listener.Pr()))}),this.stream.vr(e=>{n(()=>this.Io(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}uo(){this.state=5,this.ro.Hr(async()=>{this.state=0,this.start()})}Io(e){return Tr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}yo(t){return e=>{this.Sn.enqueueAndForget(()=>this.no===t?e():(Tr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Pu extends Mu{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.O=s}Eo(e,t){return this.eo.Ur("Listen",e,t)}onMessage(e){this.ro.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Ar(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.N?(xr(void 0===f||"string"==typeof f),es.fromBase64String(f||"")):(xr(void 0===f||f instanceof Uint8Array),es.fromUint8Array(f||new Uint8Array))),o=t.targetChange.cause,a=o&&(a=void 0===(f=o).code?Nr.UNKNOWN:Gi(f.code),new Cr(a,f.message||""));n=new ao(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;var h=t.documentChange;h.document,h.document.name,h.document.updateTime;var a=To(e,h.document.name),u=vo(h.document.updateTime),c=new xs({mapValue:{fields:h.document.fields}}),u=Ns.newFoundDocument(a,u,c),c=h.targetIds||[],h=h.removedTargetIds||[];n=new io(c,h,u.key,u)}else if("documentDelete"in t){t.documentDelete;c=t.documentDelete;c.document;h=To(e,c.document),u=c.readTime?vo(c.readTime):$r.min(),u=Ns.newNoDocument(h,u),c=c.removedTargetIds||[];n=new io([],c,u.key,u)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=To(e,l.document),l=l.removedTargetIds||[];n=new io([],l,d,null)}else{if(!("filter"in t))return Ar();{t.filter;const e=t.filter;e.targetId;l=e.count||0,d=new ji(l),l=e.targetId;n=new oo(l,d)}}var a,f;return n}(this.O,e),n=function(e){if(!("targetChange"in e))return $r.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?vo(t.readTime):$r.min()}(e);return this.listener.To(t,n)}Ao(e){const t={};t.database=_o(this.O),t.addTarget=function(e,t){let n;var r=t.target;return n=Fs(r)?{documents:ko(e,r)}:{query:Oo(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=yo(e,t.resumeToken):0<t.snapshotVersion.compareTo($r.min())&&(n.readTime=po(e,t.snapshotVersion.toTimestamp())),n}(this.O,e);var n,r,r=(this.O,n=e,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ar()}}())?null:{"goog-listen-tags":r});r&&(t.labels=r),this.fo(t)}Ro(e){const t={};t.database=_o(this.O),t.removeTarget=e,this.fo(t)}}class Fu extends Mu{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.O=s,this.Po=!1}get bo(){return this.Po}start(){this.Po=!1,this.lastStreamToken=void 0,super.start()}mo(){this.Po&&this.vo([])}Eo(e,t){return this.eo.Ur("Write",e,t)}onMessage(e){if(xr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Po){this.ro.reset();var t=(r=e.writeResults,s=e.commitTime,r&&0<r.length?(xr(void 0!==s),r.map(e=>function(e,t){let n=e.updateTime?vo(e.updateTime):vo(t);return n.isEqual($r.min())&&(n=vo(t)),new xi(n,e.transformResults||[])}(e,s))):[]),n=vo(e.commitTime);return this.listener.Vo(n,t)}var r,s;return xr(!e.writeResults||0===e.writeResults.length),this.Po=!0,this.listener.So()}Do(){const e={};e.database=_o(this.O),this.fo(e)}vo(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>Co(this.O,e))};this.fo(t)}}class Vu extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.eo=n,this.O=r,this.Co=!1}No(){if(this.Co)throw new Cr(Nr.FAILED_PRECONDITION,"The client has already been terminated.")}Mr(n,r,s){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.eo.Mr(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Nr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Cr(Nr.UNKNOWN,e.toString())})}Lr(n,r,s){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.eo.Lr(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Nr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Cr(Nr.UNKNOWN,e.toString())})}terminate(){this.Co=!0}}class Uu{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.xo=0,this.ko=null,this.Oo=!0}Mo(){0===this.xo&&(this.$o("Unknown"),this.ko=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.ko=null,this.Fo("Backend didn't respond within 10 seconds."),this.$o("Offline"),Promise.resolve())))}Bo(e){"Online"===this.state?this.$o("Unknown"):(this.xo++,1<=this.xo&&(this.Lo(),this.Fo(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.$o("Offline")))}set(e){this.Lo(),this.xo=0,"Online"===e&&(this.Oo=!1),this.$o(e)}$o(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}Fo(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Oo?(Er(t),this.Oo=!1):Tr("OnlineStateTracker",t)}Lo(){null!==this.ko&&(this.ko.cancel(),this.ko=null)}}class qu{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Uo=[],this.qo=new Map,this.Ko=new Set,this.Go=[],this.jo=s,this.jo.mr(e=>{n.enqueueAndForget(async()=>{Wu(this)&&(Tr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.Ko.add(4),await ju(t),t.Qo.set("Unknown"),t.Ko.delete(4),await Bu(t)}(this))})}),this.Qo=new Uu(n,r)}}async function Bu(e){if(Wu(e))for(const t of e.Go)await t(!0)}async function ju(e){for(const t of e.Go)await t(!1)}function Ku(e,t){const n=e;n.qo.has(t.targetId)||(n.qo.set(t.targetId,t),Hu(n)?zu(n):sc(n).co()&&$u(n,t))}function Gu(e,t){const n=e,r=sc(n);n.qo.delete(t),r.co()&&Qu(n,t),0===n.qo.size&&(r.co()?r.ho():Wu(n)&&n.Qo.set("Unknown"))}function $u(e,t){e.Wo.Z(t.targetId),sc(e).Ao(t)}function Qu(e,t){e.Wo.Z(t),sc(e).Ro(t)}function zu(t){t.Wo=new uo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Tt:e=>t.qo.get(e)||null}),sc(t).start(),t.Qo.Mo()}function Hu(e){return Wu(e)&&!sc(e).oo()&&0<e.qo.size}function Wu(e){return 0===e.Ko.size}function Yu(e){e.Wo=void 0}async function Xu(e,t,n){if(!va(t))throw t;e.Ko.add(1),await ju(e),e.Qo.set("Offline"),n=n||(()=>Xh(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Tr("RemoteStore","Retrying IndexedDB access"),await n(),e.Ko.delete(1),await Bu(e)})}function Ju(t,n){return n().catch(e=>Xu(t,e,n))}async function Zu(e){const t=e,n=ic(t);let r=0<t.Uo.length?t.Uo[t.Uo.length-1].batchId:-1;for(;Wu(s=t)&&s.Uo.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.gs.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.Uo.length&&n.ho();break}r=e.batchId,function(e,t){e.Uo.push(t);const n=ic(e);n.co()&&n.bo&&n.vo(t.mutations)}(t,e)}catch(e){await Xu(t,e)}var s;ec(t)&&tc(t)}function ec(e){return Wu(e)&&!ic(e).oo()&&0<e.Uo.length}function tc(e){ic(e).start()}async function nc(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Tr("RemoteStore","RemoteStore received new credentials");var r=Wu(n);n.Ko.add(3),await ju(n),r&&n.Qo.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.Ko.delete(3),await Bu(n)}async function rc(e,t){const n=e;t?(n.Ko.delete(2),await Bu(n)):(n.Ko.add(2),await ju(n),n.Qo.set("Unknown"))}function sc(t){return t.zo||(t.zo=function(e,t,n){const r=e;return r.No(),new Pu(t,r.eo,r.authCredentials,r.appCheckCredentials,r.O,n)}(t.datastore,t.asyncQueue,{Pr:(async function(n){n.qo.forEach((e,t)=>{$u(n,e)})}).bind(null,t),vr:(async function(e,t){Yu(e),Hu(e)?(e.Qo.Bo(t),zu(e)):e.Qo.set("Unknown")}).bind(null,t),To:(async function(e,r,t){if(e.Qo.set("Online"),r instanceof ao&&2===r.state&&r.cause)try{await async function(e){var t=r.cause;for(const n of r.targetIds)e.qo.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.qo.delete(n),e.Wo.removeTarget(n))}(e)}catch(t){Tr("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await Xu(e,t)}else if(r instanceof io?e.Wo.ct(r):r instanceof oo?e.Wo._t(r):e.Wo.ht(r),!t.isEqual($r.min()))try{const r=await Xh(e.localStore);0<=t.compareTo(r)&&await function(r,s){const e=r.Wo.yt(s);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=r.qo.get(t);n&&r.qo.set(t,n.withResumeToken(e.resumeToken,s))}}),e.targetMismatches.forEach(e=>{const t=r.qo.get(e);var n;t&&(r.qo.set(e,t.withResumeToken(es.EMPTY_BYTE_STRING,t.snapshotVersion)),Qu(r,e),n=new Na(t.target,e,1,t.sequenceNumber),$u(r,n))}),r.remoteSyncer.applyRemoteEvent(e)}(e,t)}catch(r){Tr("RemoteStore","Failed to raise snapshot:",r),await Xu(e,r)}}).bind(null,t)}),t.Go.push(async e=>{e?(t.zo.ao(),Hu(t)?zu(t):t.Qo.set("Unknown")):(await t.zo.stop(),Yu(t))})),t.zo}function ic(t){return t.Ho||(t.Ho=function(e,t,n){const r=e;return r.No(),new Fu(t,r.eo,r.authCredentials,r.appCheckCredentials,r.O,n)}(t.datastore,t.asyncQueue,{Pr:(async function(e){ic(e).Do()}).bind(null,t),vr:(async function(e,t){t&&ic(e).bo&&await async function(e,t){if(Ki(n=t.code)&&n!==Nr.ABORTED){const n=e.Uo.shift();ic(e).ao(),await Ju(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await Zu(e)}var n}(e,t),ec(e)&&tc(e)}).bind(null,t),So:(async function(e){const t=ic(e);for(const n of e.Uo)t.vo(n.mutations)}).bind(null,t),Vo:(async function(e,t,n){const r=e.Uo.shift(),s=Aa.from(r,t,n);await Ju(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Zu(e)}).bind(null,t)}),t.Go.push(async e=>{e?(t.Ho.ao(),await Zu(t)):(await t.Ho.stop(),0<t.Uo.length&&(Tr("RemoteStore",`Stopping write stream with ${t.Uo.length} pending writes`),t.Uo=[]))})),t.Ho}class oc{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Dr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new oc(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Cr(Nr.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ac(e,t){if(Er("AsyncQueue",`${t}: ${e}`),va(e))return new Cr(Nr.UNAVAILABLE,`${t}: ${e}`);throw e}class hc{constructor(n){this.comparator=n?(e,t)=>n(e,t)||ds.comparator(e.key,t.key):(e,t)=>ds.comparator(e.key,t.key),this.keyedMap=Ji,this.sortedSet=new $i(this.comparator)}static emptySet(e){return new hc(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof hc))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new hc;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class uc{constructor(){this.Jo=new $i(ds.comparator)}track(e){var t=e.doc.key,n=this.Jo.get(t);!n||0!==e.type&&3===n.type?this.Jo=this.Jo.insert(t,e):3===e.type&&1!==n.type?this.Jo=this.Jo.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Jo=this.Jo.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Jo=this.Jo.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Jo=this.Jo.remove(t):1===e.type&&2===n.type?this.Jo=this.Jo.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Jo=this.Jo.insert(t,{type:2,doc:e.doc}):Ar()}Yo(){const n=[];return this.Jo.inorderTraversal((e,t)=>{n.push(t)}),n}}class cc{constructor(e,t,n,r,s,i,o,a){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new cc(e,t,hc.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&hi(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class lc{constructor(){this.Xo=void 0,this.listeners=[]}}class dc{constructor(){this.queries=new Dh(e=>ui(e),hi),this.onlineState="Unknown",this.Zo=new Set}}async function fc(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new lc),s)try{i.Xo=await n.onListen(r)}catch(e){const n=ac(e,`Initialization of query '${ci(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.tc(n.onlineState),!i.Xo||t.ec(i.Xo)&&mc(n)}async function gc(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function mc(e){e.Zo.forEach(e=>{e.next()})}class pc{constructor(e,t,n){this.query=e,this.nc=t,this.sc=!1,this.ic=null,this.onlineState="Unknown",this.options=n||{}}ec(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new cc(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.sc?this.rc(e)&&(this.nc.next(e),t=!0):this.oc(e,this.onlineState)&&(this.cc(e),t=!0),this.ic=e,t}onError(e){this.nc.error(e)}tc(e){this.onlineState=e;let t=!1;return this.ic&&!this.sc&&this.oc(this.ic,e)&&(this.cc(this.ic),t=!0),t}oc(e,t){return!e.fromCache||!(this.options.uc&&"Offline"!==t||e.docs.isEmpty()&&"Offline"!==t)}rc(e){if(0<e.docChanges.length)return!0;var t=this.ic&&this.ic.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}cc(e){e=cc.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.sc=!0,this.nc.next(e)}}class yc{constructor(e,t){this.payload=e,this.byteLength=t}ac(){return"metadata"in this.payload}}class vc{constructor(e){this.O=e}Gs(e){return To(this.O,e)}js(e){return e.metadata.exists?No(this.O,e.document,!1):Ns.newNoDocument(this.Gs(e.metadata.name),this.Qs(e.metadata.readTime))}Qs(e){return vo(e)}}class wc{constructor(e,t,n){this.hc=e,this.localStore=t,this.O=n,this.queries=[],this.documents=[],this.progress=Ic(e)}lc(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;return e.payload.namedQuery?this.queries.push(e.payload.namedQuery):e.payload.documentMetadata?(this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t):e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}fc(e){const t=new Map,n=new vc(this.O);for(const s of e)if(s.metadata.queries){const e=n.Gs(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||to()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=to(),o=Xi;for(const e of n){const n=t.Gs(e.metadata.name);e.document&&(i=i.add(n));const u=t.js(e);u.setReadTime(t.Qs(e.metadata.readTime)),o=o.insert(n,u)}const a=s.Bs.newChangeBuffer({trackRemovals:!0}),h=await eu(s,(r=r,oi(Zs(Yr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>Zh(t,a,o).next(e=>(a.apply(t),e)).next(e=>s.Un.removeMatchingKeysForTargetId(t,h.targetId).next(()=>s.Un.addMatchingKeys(t,i,h.targetId)).next(()=>s.Us.Ts(t,e)).next(()=>e)))}(this.localStore,new vc(this.O),this.documents,this.hc.id),t=this.fc(this.documents);for(const e of this.queries)await async function(e,n,r=to()){const s=await eu(e,oi(Ua(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=vo(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.Kn.saveNamedQuery(e,n);t=s.withResumeToken(es.EMPTY_BYTE_STRING,t);return i.Ms=i.Ms.insert(t.targetId,t),i.Un.updateTargetData(e,t).next(()=>i.Un.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Un.addMatchingKeys(e,r,s.targetId)).next(()=>i.Kn.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",new Gh(Object.assign({},this.progress),e)}}function Ic(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class bc{constructor(e){this.key=e}}class Tc{constructor(e){this.key=e}}class Ec{constructor(e,t){this.query=e,this.dc=t,this._c=null,this.current=!1,this.wc=to(),this.mutatedKeys=to(),this.mc=di(e),this.gc=new hc(this.mc)}get yc(){return this.dc}Ic(e,t){const a=t?t.Ec:new uc,h=(t||this).gc;let u=(t||this).mutatedKeys,c=h,l=!1;const d=ei(this.query)&&h.size===this.query.limit?h.last():null,f=ti(this.query)&&h.size===this.query.limit?h.first():null;if(e.inorderTraversal((e,t)=>{const n=h.get(e),r=li(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let o=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(a.track({type:3,doc:r}),o=!0):this.Tc(n,r)||(a.track({type:2,doc:r}),o=!0,(d&&0<this.mc(r,d)||f&&this.mc(r,f)<0)&&(l=!0)):!n&&r?(a.track({type:0,doc:r}),o=!0):n&&!r&&(a.track({type:1,doc:n}),o=!0,(d||f)&&(l=!0)),o&&(u=r?(c=c.add(r),i?u.add(e):u.delete(e)):(c=c.delete(e),u.delete(e)))}),ei(this.query)||ti(this.query))for(;c.size>this.query.limit;){const e=ei(this.query)?c.last():c.first();c=c.delete(e.key),u=u.delete(e.key),a.track({type:1,doc:e})}return{gc:c,Ec:a,ks:l,mutatedKeys:u}}Tc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.gc;this.gc=e.gc,this.mutatedKeys=e.mutatedKeys;const s=e.Ec.Yo();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ar()}};return n(e)-n(t)}(e.type,t.type)||this.mc(e.doc,t.doc)),this.Ac(n);var i=t?this.Rc():[],o=0===this.wc.size&&this.current?1:0,a=o!==this._c;return this._c=o,0!==s.length||a?{snapshot:new cc(this.query,e.gc,r,s,e.mutatedKeys,0==o,a,!1),Pc:i}:{Pc:i}}tc(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({gc:this.gc,Ec:new uc,mutatedKeys:this.mutatedKeys,ks:!1},!1)):{Pc:[]}}bc(e){return!this.dc.has(e)&&!!this.gc.has(e)&&!this.gc.get(e).hasLocalMutations}Ac(e){e&&(e.addedDocuments.forEach(e=>this.dc=this.dc.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.dc=this.dc.delete(e)),this.current=e.current)}Rc(){if(!this.current)return[];const t=this.wc;this.wc=to(),this.gc.forEach(e=>{this.bc(e.key)&&(this.wc=this.wc.add(e.key))});const n=[];return t.forEach(e=>{this.wc.has(e)||n.push(new Tc(e))}),this.wc.forEach(e=>{t.has(e)||n.push(new bc(e))}),n}vc(e){this.dc=e.Ks,this.wc=to();var t=this.Ic(e.documents);return this.applyChanges(t,!0)}Vc(){return cc.fromInitialDocuments(this.query,this.gc,this.mutatedKeys,0===this._c)}}class Sc{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class _c{constructor(e){this.key=e,this.Sc=!1}}class Ac{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Dc={},this.Cc=new Dh(e=>ui(e),hi),this.Nc=new Map,this.xc=new Set,this.kc=new $i(ds.comparator),this.Oc=new Map,this.Mc=new au,this.$c={},this.Fc=new Map,this.Bc=vh.Je(),this.onlineState="Unknown",this.Lc=void 0}get isPrimaryClient(){return!0===this.Lc}}async function xc(n,e,t,r){n.Uc=(e,i,t)=>async function(e,t,n){let r=t.view.Ic(i);r.ks&&(r=await nu(e.localStore,t.query,!1).then(({documents:e})=>t.view.Ic(e,r)));var s=n&&n.targetChanges.get(t.targetId),s=t.view.applyChanges(r,e.isPrimaryClient,s);return Pc(e,t.targetId,s.Pc),s.snapshot}(n,e,t);const s=await nu(n.localStore,e,!0),i=new Ec(e,s.Ks),o=i.Ic(s.documents),a=so.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState),h=i.applyChanges(o,n.isPrimaryClient,a);Pc(n,t,h.Pc);var u=new Sc(e,t,i);return n.Cc.set(e,u),n.Nc.has(t)?n.Nc.get(t).push(e):n.Nc.set(t,[e]),h.snapshot}async function Nc(e,t,n){const r=Kc(e);try{const e=await function(e,r){const s=e,i=Gr.now(),t=r.reduce((e,t)=>e.add(t.key),to());let o;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>s.Us.Es(n,t).next(e=>{o=e;const t=[];for(const n of r){const r=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=yi(r.transform,e||null);null!=s&&(null==n&&(n=xs.empty()),n.set(r.field,s))}return n||null}(n,o.get(n.key));null!=r&&t.push(new Pi(n.key,r,function r(e){const s=[];return zr(e.fields,(e,t)=>{const n=new Jr([e]);if(_s(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new Zr(s)}(r.value.mapValue),Ni.exists(!0)))}return s.gs.addMutationBatch(n,i,t,r)})).then(e=>(e.applyToLocalDocumentSet(o),{batchId:e.batchId,changes:o}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.$c[e.currentUser.toKey()];r=r||new $i(Br),r=r.insert(t,n),e.$c[e.currentUser.toKey()]=r}(r,e.batchId,n),await Vc(r,e.changes),await Zu(r.remoteStore)}catch(e){const t=ac(e,"Failed to persist write");n.reject(t)}}async function Cc(e,t){const r=e;try{const e=await Jh(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.Oc.get(t);n&&(xr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.Sc=!0:0<e.modifiedDocuments.size?xr(n.Sc):0<e.removedDocuments.size&&(xr(n.Sc),n.Sc=!1))}),await Vc(r,e,t)}catch(e){await Eh(e)}}function Dc(r,s,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.Cc.forEach((e,t)=>{var n=t.view.tc(s);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.tc(n)&&(r=!0)}),r&&mc(t)}(t.eventManager,s),r.length&&t.Dc.To(r),t.onlineState=s,t.isPrimaryClient&&t.sharedClientState.setOnlineState(s)}}async function kc(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Bs.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let o=fa.resolve();return n.forEach(n=>{o=o.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);xr(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),o.next(()=>e.gs.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.gs.performConsistencyCheck(e)).next(()=>s.Us.Es(e,t))})}(n.localStore,t);Rc(n,r,null),Oc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Vc(n,e)}catch(e){await Eh(e)}}function Oc(e,t){(e.Fc.get(t)||[]).forEach(e=>{e.resolve()}),e.Fc.delete(t)}function Rc(e,t,n){const r=e;let s=r.$c[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.$c[r.currentUser.toKey()]=s}}function Lc(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Nc.get(e))t.Cc.delete(r),n&&t.Dc.qc(r,n);t.Nc.delete(e),t.isPrimaryClient&&t.Mc.si(e).forEach(e=>{t.Mc.containsKey(e)||Mc(t,e)})}function Mc(e,t){e.xc.delete(t.path.canonicalString());var n=e.kc.get(t);null!==n&&(Gu(e.remoteStore,n),e.kc=e.kc.remove(t),e.Oc.delete(n),Fc(e))}function Pc(e,t,n){for(const r of n)r instanceof bc?(e.Mc.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.kc.get(n)||e.xc.has(r)||(Tr("SyncEngine","New document in limbo: "+n),e.xc.add(r),Fc(e))}(e,r)):r instanceof Tc?(Tr("SyncEngine","Document no longer in limbo: "+r.key),e.Mc.removeReference(r.key,t),e.Mc.containsKey(r.key)||Mc(e,r.key)):Ar()}function Fc(e){for(;0<e.xc.size&&e.kc.size<e.maxConcurrentLimboResolutions;){var t=e.xc.values().next().value;e.xc.delete(t);var n=new ds(Yr.fromString(t)),t=e.Bc.next();e.Oc.set(t,new _c(n)),e.kc=e.kc.insert(n,t),Ku(e.remoteStore,new Na(oi(Zs(n.path)),t,2,Ur.A))}}async function Vc(e,t,r){const s=e,i=[],o=[],a=[];s.Cc.isEmpty()||(s.Cc.forEach((e,n)=>{a.push(s.Uc(n,t,r).then(e=>{var t;e&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,e.fromCache?"not-current":"current"),i.push(e),t=Qh.Ss(n.targetId,e),o.push(t))}))}),await Promise.all(a),s.Dc.To(i),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>fa.forEach(t,t=>fa.forEach(t.vs,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>fa.forEach(t.Vs,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!va(e))throw e;Tr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.Ms.get(t),n=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(n);r.Ms=r.Ms.insert(t,s)}}}(s.localStore,o))}async function Uc(r,e){const s=r;if(jc(s),Kc(s),!0===e&&!0!==s.Lc){const r=s.sharedClientState.getAllActiveQueryTargets(),e=await qc(s,r.toArray());s.Lc=!0,await rc(s.remoteStore,!0);for(const r of e)Ku(s.remoteStore,r)}else if(!1===e&&!1!==s.Lc){const r=[];let n=Promise.resolve();s.Nc.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Lc(s,t),tu(s.localStore,t,!0))),Gu(s.remoteStore,t)}),await n,await qc(s,r),function(){const n=s;n.Oc.forEach((e,t)=>{Gu(n.remoteStore,t)}),n.Mc.ii(),n.Oc=new Map,n.kc=new $i(ds.comparator)}(),s.Lc=!1,await rc(s.remoteStore,!1)}}async function qc(t,n){const r=t,s=[],i=[];for(const t of n){let e;const c=r.Nc.get(t);if(c&&0!==c.length){e=await eu(r.localStore,oi(c[0]));for(const t of c){const n=r.Cc.get(t),c=(o=r,a=n,u=h=void 0,u=await nu((h=o).localStore,a.query,!0),u=a.view.vc(u),h.isPrimaryClient&&Pc(h,a.targetId,u.Pc),await u);c.snapshot&&i.push(c.snapshot)}}else{const c=await ru(r.localStore,t);e=await eu(r.localStore,c),await xc(r,Bc(c),t,!1)}s.push(e)}var o,a,h,u;return r.Dc.To(i),s}function Bc(e){return Js(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function jc(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Cc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.Oc.get(t);if(r&&r.Sc)return to().add(r.key);{let e=to();const r=n.Nc.get(t);if(!r)return e;for(const t of r){const r=n.Cc.get(t);e=e.unionWith(r.view.yc)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Oc.get(t),i=s&&s.key;if(i){let e=new $i(ds.comparator);e=e.insert(i,Ns.newNoDocument(i,$r.min()));const n=to().add(i),s=new ro($r.min(),new Map,new Hi(Br),e,n);await Cc(r,s),r.kc=r.kc.remove(i),r.Oc.delete(t),Fc(r)}else await tu(r.localStore,t,!1).then(()=>Lc(r,t,n)).catch(Eh)}).bind(null,t),t.Dc.To=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.ec(e)&&(r=!0);s.Xo=e}}r&&mc(n)}).bind(null,t.eventManager),t.Dc.qc=(function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function Kc(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=kc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.gs.lookupMutationBatch(t,r).next(e=>(xr(null!==e),n=e.keys(),s.gs.removeMutationBatch(t,e))).next(()=>s.gs.performConsistencyCheck(t)).next(()=>s.Us.Es(t,n))})}(r.localStore,t);Rc(r,t,n),Oc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Vc(r,e)}catch(n){await Eh(n)}}).bind(null,t),t}class Gc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.O=Ru(e.databaseInfo.databaseId),this.sharedClientState=this.Gc(e),this.persistence=this.jc(e),await this.persistence.start(),this.gcScheduler=this.Qc(e),this.localStore=this.Wc(e)}Qc(e){return null}Wc(e){return Wh(this.persistence,new zh,e.initialUser,this.O)}jc(e){return new fu(mu.bi,this.O)}Gc(e){return new _u}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class $c extends Gc{constructor(e,t,n){super(),this.zc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await async function(e){const t=e;return t.persistence.runTransaction("Synchronize last document change read time","readonly",t=>function(){const e=Mh(t);let r=$r.min();return e.Qt({index:Wo.readTimeIndex,reverse:!0},(e,t,n)=>{t.readTime&&(r=Ra(t.readTime)),n.done()}).next(()=>r)}()).then(e=>{t.Fs=e})}(this.localStore),await this.zc.initialize(this,e),await Kc(this.zc.syncEngine),await Zu(this.zc.remoteStore),await this.persistence.Hn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Wc(e){return Wh(this.persistence,new zh,e.initialUser,this.O)}Qc(e){var t=this.persistence.referenceDelegate.garbageCollector;return new Ah(t,e.asyncQueue)}jc(e){var t=Kh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ch.withCacheSize(this.cacheSizeBytes):ch.DEFAULT;return new qh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,ku(),Ou(),this.O,this.sharedClientState,!!this.forceOwnership)}Gc(e){return new _u}}class Qc extends $c{constructor(e,t){super(e,t,!1),this.zc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.zc.syncEngine;this.sharedClientState instanceof Su&&(this.sharedClientState.syncEngine={hr:(async function(e,t,n,r){var s=e,i=await function(e,n){const r=e,s=r.gs;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Ge(t,n).next(e=>e?r.Us.Es(t,e):fa.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await Zu(s.remoteStore):"acknowledged"===n||"rejected"===n?(Rc(s,t,r||null),Oc(s,t),s.localStore.gs.Qe(t)):Ar(),await Vc(s,i)):Tr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),lr:(async function(e,t,n,r){const s=e;if(s.Lc)Tr("SyncEngine","Ignoring unexpected query state notification.");else if(s.Nc.has(t))switch(n){case"current":case"not-current":{const e=await su(s.localStore),r=ro.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await Vc(s,e,r);break}case"rejected":await tu(s.localStore,t,!0),Lc(s,t,r);break;default:Ar()}}).bind(null,t),dr:(async function(e,t,n){const r=jc(e);if(r.Lc){for(const e of t)if(r.Nc.has(e))Tr("SyncEngine","Adding an already active target "+e);else{const t=await ru(r.localStore,e),n=await eu(r.localStore,t);await xc(r,Bc(t),n.targetId,!1),Ku(r.remoteStore,n)}for(const e of n)r.Nc.has(e)&&await tu(r.localStore,e,!1).then(()=>{Gu(r.remoteStore,e),Lc(r,e)}).catch(Eh)}}).bind(null,t),ds:(function(e){return e.localStore.persistence.ds()}).bind(null,t),ar:(async function(e){const t=e;return su(t.localStore).then(e=>Vc(t,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.Hn(async e=>{await Uc(this.zc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):e||this.gcScheduler.stop())})}Gc(e){var t=ku();if(!Su.Vt(t))throw new Cr(Nr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Kh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Su(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class zc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Dc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Tr("SyncEngine","User change. New user:",t.toKey());const r=await Yh(n.localStore,t);n.currentUser=t,(e=n).Fc.forEach(e=>{e.forEach(e=>{e.reject(new Cr(Nr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Fc.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await Vc(n,r.qs)}}).bind(null,this.syncEngine),await rc(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new dc}createDatastore(e){var t,n,r,s,i=Ru(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new Du(t));return n=e.authCredentials,r=e.appCheckCredentials,s=t,e=i,new Vu(n,r,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Dc(this.syncEngine,e,0),i=new(xu.Vt()?xu:Au),new qu(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new Ac(e,t,n,r,s,i);return o&&(a.Lc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Tr("RemoteStore","RemoteStore shutting down."),t.Ko.add(5),await ju(t),t.jo.shutdown(),t.Qo.set("Unknown")}(this.remoteStore)}}function Hc(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Wc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Hc(this.observer.next,e)}error(e){this.observer.error?this.Hc(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}Jc(){this.muted=!0}Hc(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class Yc{constructor(e,t){this.Yc=e,this.O=t,this.metadata=new Dr,this.buffer=new Uint8Array,this.Xc=new TextDecoder("utf-8"),this.Zc().then(e=>{e&&e.ac()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))},e=>this.metadata.reject(e))}close(){return this.Yc.cancel()}async getMetadata(){return this.metadata.promise}async Kc(){return await this.getMetadata(),this.Zc()}async Zc(){var e=await this.tu();if(null===e)return null;var t=this.Xc.decode(e),n=Number(t);isNaN(n)&&this.eu(`length string (${t}) is not valid number`);t=await this.nu(n);return new yc(JSON.parse(t),e.length+n)}su(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async tu(){for(;this.su()<0&&!await this.iu(););if(0===this.buffer.length)return null;var e=this.su();e<0&&this.eu("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async nu(e){for(;this.buffer.length<e;)await this.iu()&&this.eu("Reached the end of bundle when more is expected.");var t=this.Xc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}eu(e){throw this.Yc.cancel(),new Error(`Invalid bundle format: ${e}`)}async iu(){var e=await this.Yc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Xc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Cr(Nr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=_o(r.O)+"/documents",s={documents:t.map(e=>bo(r.O,e))},i=await r.Lr("BatchGetDocuments",n,s),o=new Map;i.forEach(e=>{const t=(n=r.O,"found"in(e=e)?function(e,t){xr(!!t.found),t.found.name,t.found.updateTime;var n=To(e,t.found.name),r=vo(t.found.updateTime),s=new xs({mapValue:{fields:t.found.fields}});return Ns.newFoundDocument(n,r,s)}(n,e):"missing"in e?function(e,t){xr(!!t.missing),xr(!!t.readTime);var n=To(e,t.missing),r=vo(t.readTime);return Ns.newNoDocument(n,r)}(n,e):Ar());var n;o.set(t.key.toString(),t)});const a=[];return t.forEach(e=>{var t=o.get(e.toString());xr(!!t),a.push(t)}),a}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new qi(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=ds.fromPath(t);this.mutations.push(new Bi(n,this.precondition(n)))}),await async function(e,t){const n=e,r=_o(n.O)+"/documents",s={writes:t.map(e=>Co(n.O,e))};await n.Mr("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Ar();t=$r.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Cr(Nr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?Ni.updateTime(t):Ni.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return Ni.exists(!0);if(t.isEqual($r.min()))throw new Cr(Nr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ni.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Jc{constructor(e,t,n,r){this.asyncQueue=e,this.datastore=t,this.updateFunction=n,this.deferred=r,this.ru=5,this.ro=new Lu(this.asyncQueue,"transaction_retry")}run(){--this.ru,this.ou()}ou(){this.ro.Hr(async()=>{const t=new Xc(this.datastore),e=this.cu(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.uu(e)}))}).catch(e=>{this.uu(e)})})}cu(e){try{var t=this.updateFunction(e);return!us(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}uu(e){0<this.ru&&this.au(e)?(--this.ru,this.asyncQueue.enqueueAndForget(()=>(this.ou(),Promise.resolve()))):this.deferred.reject(e)}au(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||!Ki(t)}}class Zc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=vr.UNAUTHENTICATED,this.clientId=qr.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Tr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Tr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Cr(Nr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Dr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=ac(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function el(e,t){e.asyncQueue.verifyOperationInProgress(),Tr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await Yh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function tl(e,n){e.asyncQueue.verifyOperationInProgress();var t=await nl(e);Tr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>nc(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>nc(n.remoteStore,t)),e.onlineComponents=n}async function nl(e){return e.offlineComponents||(Tr("FirestoreClient","Using default OfflineComponentProvider"),await el(e,new Gc)),e.offlineComponents}async function rl(e){return e.onlineComponents||(Tr("FirestoreClient","Using default OnlineComponentProvider"),await tl(e,new zc)),e.onlineComponents}function sl(e){return nl(e).then(e=>e.persistence)}function il(e){return nl(e).then(e=>e.localStore)}function ol(e){return rl(e).then(e=>e.remoteStore)}function al(e){return rl(e).then(e=>e.syncEngine)}async function hl(e){const t=await rl(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=jc(e);let r,s;const i=n.Cc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Vc();else{const e=await eu(n.localStore,oi(t));n.isPrimaryClient&&Ku(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await xc(n,t,r,"current"===i)}return s}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.Cc.get(t),s=n.Nc.get(r.targetId);if(1<s.length)return n.Nc.set(r.targetId,s.filter(e=>!hi(e,t))),void n.Cc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await tu(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Gu(n.remoteStore,r.targetId),Lc(n,r.targetId)}).catch(Eh)):(Lc(n,r.targetId),await tu(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function ul(e,t,n={}){const r=new Dr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,o){const e=new Wc({next:e=>{r.enqueueAndForget(()=>gc(n,a));var t=e.docs.has(s);!t&&e.fromCache?o.reject(new Cr(Nr.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?o.reject(new Cr(Nr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):o.resolve(e)},error:e=>o.reject(e)}),a=new pc(Zs(s.path),e,{includeMetadataChanges:!0,uc:!0});return fc(n,a)}(await hl(e),e.asyncQueue,t,n,r)),r.promise}function cl(e,t,n={}){const r=new Dr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,s){const i=new Wc({next:e=>{n.enqueueAndForget(()=>gc(t,o)),e.fromCache&&"server"===r.source?s.reject(new Cr(Nr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),o=new pc(e,i,{includeMetadataChanges:!0,uc:!0});return fc(t,o)}(await hl(e),e.asyncQueue,t,n,r)),r.promise}function ll(e,t,n,r){const s=(n=n,t=Ru(t),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(e){if(e instanceof Uint8Array)return Hc(e,void 0);if(e instanceof ArrayBuffer)return Hc(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),t=t,new Yc(n,t));var i;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=vo(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Kn.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),void r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes});r._updateProgress(Ic(s));const o=new wc(s,t.localStore,n.O);let e=await n.Kc();for(;e;){const t=await o.lc(e);t&&r._updateProgress(t),e=await n.Kc()}var i=await o.complete();await Vc(t,i.ws,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Kn.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress)}catch(t){Sr("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t)}}(r,t,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}(await al(e),s,r)})}const dl=new Map;function fl(e,t,n){if(!n)throw new Cr(Nr.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function gl(e,t,n,r){if(!0===t&&!0===r)throw new Cr(Nr.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function ml(e){if(!ds.isDocumentKey(e))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function pl(e){if(ds.isDocumentKey(e))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function yl(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Ar();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function vl(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Cr(Nr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=yl(e);throw new Cr(Nr.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function wl(e,t){if(t<=0)throw new Cr(Nr.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Il{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Cr(Nr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Cr(Nr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,gl("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class bl{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Il({}),this._settingsFrozen=!1,e instanceof hs?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Cr(Nr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new hs(e.options.projectId)}(e))}get app(){if(!this._app)throw new Cr(Nr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Cr(Nr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Il(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Or;switch(e.type){case"gapi":var t=e.client;return xr(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new Pr(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new Cr(Nr.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=dl.get(e);t&&(Tr("ComponentProvider","Removing Datastore"),dl.delete(e),t.terminate())}(this),Promise.resolve()}}function Tl(n,e,t,r={}){var s;const i=(n=vl(n,bl))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Sr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${t}`,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=vr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Cr(Nr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new vr(i)}n._authCredentials=new Rr(new kr(e,t))}}class El{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new _l(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new El(this.firestore,e,this._key)}}class Sl{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Sl(this.firestore,e,this._query)}}class _l extends Sl{constructor(e,t,n){super(e,t,Zs(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new El(this.firestore,null,new ds(e))}withConverter(e){return new _l(this.firestore,e,this._path)}}function Al(e,t,...n){if(e=m(e),fl("collection","path",t),e instanceof bl){var r=Yr.fromString(t,...n);return pl(r),new _l(e,null,r)}if(!(e instanceof El||e instanceof _l))throw new Cr(Nr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Yr.fromString(t,...n));return pl(r),new _l(e.firestore,null,r)}function xl(e,t,...n){if(e=m(e),fl("doc","path",t=1===arguments.length?qr.R():t),e instanceof bl){var r=Yr.fromString(t,...n);return ml(r),new El(e,null,new ds(r))}if(!(e instanceof El||e instanceof _l))throw new Cr(Nr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(Yr.fromString(t,...n));return ml(r),new El(e.firestore,e instanceof _l?e.converter:null,new ds(r))}function Nl(e,t){return e=m(e),t=m(t),(e instanceof El||e instanceof _l)&&(t instanceof El||t instanceof _l)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Cl(e,t){return e=m(e),t=m(t),e instanceof Sl&&t instanceof Sl&&e.firestore===t.firestore&&hi(e._query,t._query)&&e.converter===t.converter}class Dl{constructor(){this.hu=Promise.resolve(),this.lu=[],this.fu=!1,this.du=[],this._u=null,this.wu=!1,this.mu=!1,this.gu=[],this.ro=new Lu(this,"async_queue_retry"),this.yu=()=>{var e=Ou();e&&Tr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.ro.Yr()};const e=Ou();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.yu)}get isShuttingDown(){return this.fu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.fu){this.fu=!0,this.mu=e||!1;const t=Ou();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.yu)}}enqueue(e){if(this.pu(),this.fu)return new Promise(()=>{});const t=new Dr;return this.Iu(()=>this.fu&&this.mu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.lu.push(e),this.Eu()))}async Eu(){if(0!==this.lu.length){try{await this.lu[0](),this.lu.shift(),this.ro.reset()}catch(e){if(!va(e))throw e;Tr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.lu.length&&this.ro.Hr(()=>this.Eu())}}Iu(e){var t=this.hu.then(()=>(this.wu=!0,e().catch(e=>{throw this._u=e,this.wu=!1,Er("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.wu=!1,e))));return this.hu=t}enqueueAfterDelay(e,t,n){this.pu(),-1<this.gu.indexOf(e)&&(t=0);var r=oc.createAndSchedule(this,e,t,n,e=>this.Tu(e));return this.du.push(r),r}pu(){this._u&&Ar()}verifyOperationInProgress(){}async Au(){for(var e;await(e=this.hu),e!==this.hu;);}Ru(e){for(const t of this.du)if(t.timerId===e)return!0;return!1}Pu(t){return this.Au().then(()=>{this.du.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.du)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Au()})}bu(e){this.gu.push(e)}Tu(e){var t=this.du.indexOf(e);this.du.splice(t,1)}}function kl(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class Ol{constructor(){this._progressObserver={},this._taskCompletionResolver=new Dr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var Rl,Ll,Ml;class Pl extends bl{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Dl,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Vl(this),this._firestoreClient.terminate()}}function Fl(e){return e._firestoreClient||Vl(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Vl(e){var t,n,r,s,i,o=e._freezeSettings(),o=(n=e._databaseId,r=(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",s=e._persistenceKey,i=o,new as(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));e._firestoreClient=new Zc(e._authCredentials,e._appCheckCredentials,e._queue,o)}function Ul(e,n,r){const s=new Dr;return e.asyncQueue.enqueue(async()=>{try{await el(e,r),await tl(e,n),s.resolve()}catch(e){if(!("FirebaseError"===(t=e).name?t.code===Nr.FAILED_PRECONDITION||t.code===Nr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)))throw e;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}var t}).then(()=>s.promise)}function ql(e){return function(e){const t=new Dr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;Wu(n.remoteStore)||Tr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.gs.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.Fc.get(e)||[];r.push(t),n.Fc.set(e,r)}catch(e){const n=ac(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await al(e),t)),t.promise}(Fl(e=vl(e,Pl)))}function Bl(e){return(n=Fl(e=vl(e,Pl))).asyncQueue.enqueue(async()=>{const e=await sl(n),t=await ol(n);return e.setNetworkEnabled(!0),function(){const e=t;return e.Ko.delete(0),Bu(e)}()});var n}function jl(e){return(n=Fl(e=vl(e,Pl))).asyncQueue.enqueue(async()=>{const e=await sl(n),t=await ol(n);return e.setNetworkEnabled(!1),async function(){const e=t;e.Ko.add(0),await ju(e),e.Qo.set("Offline")}()});var n}function Kl(t,e){return n=Fl(t=vl(t,Pl)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Kn.getNamedQuery(e,t))}(await il(n),r)).then(e=>e?new Sl(t,null,e.query):null);var n,r}function Gl(e){if(e._initialized||e._terminated)throw new Cr(Nr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class $l{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Cr(Nr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Jr(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Ql{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Ql(es.fromBase64String(e))}catch(e){throw new Cr(Nr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Ql(es.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class zl{constructor(e){this._methodName=e}}class Hl{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Cr(Nr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Cr(Nr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Br(this._lat,e._lat)||Br(this._long,e._long)}}const Wl=/^__.*__$/;class Yl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Pi(e,this.data,this.fieldMask,t,this.fieldTransforms):new Mi(e,this.data,t,this.fieldTransforms)}}class Xl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Pi(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Jl(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Ar()}}class Zl{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.O=n,this.ignoreUndefinedProperties=r,void 0===s&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}Su(e){return new Zl(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.O,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Du(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Su({path:n,Cu:!1});return r.Nu(e),r}xu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Su({path:n,Cu:!1});return r.vu(),r}ku(e){return this.Su({path:void 0,Cu:!0})}Ou(e){return wd(e,this.settings.methodName,this.settings.Mu||!1,this.path,this.settings.$u)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Nu(this.path.get(e))}Nu(e){if(0===e.length)throw this.Ou("Document fields must not be empty");if(Jl(this.Vu)&&Wl.test(e))throw this.Ou('Document fields cannot begin and end with "__"')}}class ed{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.O=n||Ru(e)}Fu(e,t,n,r=!1){return new Zl({Vu:e,methodName:t,$u:n,path:Jr.emptyPath(),Cu:!1,Mu:r},this.databaseId,this.O,this.ignoreUndefinedProperties)}}function td(e){var t=e._freezeSettings(),n=Ru(e._databaseId);return new ed(e._databaseId,!!t.ignoreUndefinedProperties,n)}function nd(e,t,n,r,s,i={}){const o=e.Fu(i.merge||i.mergeFields?2:0,t,n,s);md("Data must be an object, but it was:",o,r);var a=fd(r,o);let h,u;if(i.merge)h=new Zr(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=pd(t,r,n);if(!o.contains(s))throw new Cr(Nr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Id(e,s)||e.push(s)}h=new Zr(e),u=o.fieldTransforms.filter(e=>h.covers(e.field))}else h=null,u=o.fieldTransforms;return new Yl(new xs(a),h,u)}class rd extends zl{_toFieldTransform(e){if(2!==e.Vu)throw 1===e.Vu?e.Ou(`${this._methodName}() can only appear at the top level of your update data`):e.Ou(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof rd}}function sd(e,t,n){return new Zl({Vu:3,$u:t.settings.$u,methodName:e._methodName,Cu:n},t.databaseId,t.O,t.ignoreUndefinedProperties)}class id extends zl{_toFieldTransform(e){return new Ai(e.path,new vi)}isEqual(e){return e instanceof id}}class od extends zl{constructor(e,t){super(e),this.Bu=t}_toFieldTransform(e){const t=sd(this,e,!0),n=this.Bu.map(e=>dd(e,t)),r=new wi(n);return new Ai(e.path,r)}isEqual(e){return this===e}}class ad extends zl{constructor(e,t){super(e),this.Bu=t}_toFieldTransform(e){const t=sd(this,e,!0),n=this.Bu.map(e=>dd(e,t)),r=new bi(n);return new Ai(e.path,r)}isEqual(e){return this===e}}class hd extends zl{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){var t=new Ei(e.O,mi(e.O,this.Lu));return new Ai(e.path,t)}isEqual(e){return this===e}}function ud(e,s,i,t){const o=e.Fu(1,s,i);md("Data must be an object, but it was:",o,t);const a=[],h=xs.empty();zr(t,(e,t)=>{var n=vd(s,e,i);t=m(t);var r=o.xu(n);if(t instanceof rd)a.push(n);else{const e=dd(t,r);null!=e&&(a.push(n),h.set(n,e))}});var n=new Zr(a);return new Xl(h,n,o.fieldTransforms)}function cd(e,t,n,r,s,i){const o=e.Fu(1,t,n),a=[pd(t,r,n)],h=[s];if(i.length%2!=0)throw new Cr(Nr.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)a.push(pd(t,i[f])),h.push(i[f+1]);const u=[],c=xs.empty();for(let g=a.length-1;0<=g;--g)if(!Id(u,a[g])){const t=a[g];var l=m(l=h[g]);const r=o.xu(t);if(l instanceof rd)u.push(t);else{const e=dd(l,r);null!=e&&(u.push(t),c.set(t,e))}}var d=new Zr(u);return new Xl(c,d,o.fieldTransforms)}function ld(e,t,n,r=!1){return dd(n,e.Fu(r?4:3,t))}function dd(i,e){if(gd(i=m(i)))return md("Unsupported field value:",e,i),fd(i,e);if(i instanceof zl)return function(e,t){if(!Jl(t.Vu))throw t.Ou(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Ou(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(i,e),null;if(void 0===i&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),i instanceof Array){if(e.settings.Cu&&4!==e.Vu)throw e.Ou("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const s of i){let e=dd(s,t.ku(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e)}return function(e,t){if(null===(e=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return mi(t.O,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=Gr.fromDate(e);return{timestampValue:po(t.O,n)}}if(e instanceof Gr){n=new Gr(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:po(t.O,n)}}if(e instanceof Hl)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Ql)return{bytesValue:yo(t.O,e._byteString)};if(e instanceof El){const r=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(r))throw t.Ou(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:wo(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Ou(`Unsupported field value: ${yl(e)}`)}(0,e)}function fd(e,r){const s={};return Hr(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):zr(e,(e,t)=>{var n=dd(t,r.Du(e));null!=n&&(s[e]=n)}),{mapValue:{fields:s}}}function gd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Gr||e instanceof Hl||e instanceof Ql||e instanceof El||e instanceof zl)}function md(e,t,n){if(!gd(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=yl(n);throw"an object"===r?t.Ou(e+" a custom object"):t.Ou(e+" "+r)}var s}function pd(e,t,n){if((t=m(t))instanceof $l)return t._internalPath;if("string"==typeof t)return vd(e,t);throw wd("Field path arguments must be of type string or ",e,!1,void 0,n)}const yd=new RegExp("[~\\*/\\[\\]]");function vd(t,n,r){if(0<=n.search(yd))throw wd(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new $l(...n.split("."))._internalPath}catch(e){throw wd(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function wd(e,t,n,r,s){var i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let h="";return(i||o)&&(h+=" (found",i&&(h+=` in field ${r}`),o&&(h+=` in document ${s}`),h+=")"),new Cr(Nr.INVALID_ARGUMENT,a+e+h)}function Id(e,t){return e.some(e=>e.isEqual(t))}class bd{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new El(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Td(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Ed("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Td extends bd{data(){return super.data()}}function Ed(e,t){return"string"==typeof t?vd(e,t):(t instanceof $l?t:t._delegate)._internalPath}class Sd{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class _d extends bd{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new Ad(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Ed("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Ad extends _d{data(e={}){return super.data(e)}}class xd{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Sd(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Ad(this._firestore,this._userDataWriter,e.key,e,new Sd(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Cr(Nr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let t=0;return i._snapshot.docChanges.map(e=>({type:"added",doc:new Ad(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Sd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:t++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Ad(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Sd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ar()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Nd(e,t){return e instanceof _d&&t instanceof _d?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof xd&&t instanceof xd&&e._firestore===t._firestore&&Cl(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Cd(e){if(ti(e)&&0===e.explicitOrderBy.length)throw new Cr(Nr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Dd{}function kd(e,...t){for(const n of t)e=n._apply(e);return e}class Od extends Dd{constructor(e,t,n){super(),this.Uu=e,this.qu=t,this.Ku=n,this.type="where"}_apply(e){var t=td(e.firestore),t=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Cr(Nr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Ud(o,i);const t=[];for(const n of o)t.push(Vd(r,e,n));a={arrayValue:{values:t}}}else a=Vd(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Ud(o,i),a=ld(n,t,o,"in"===i||"not-in"===i);var h=Vs.create(s,i,a);return function(e,t){if(t.S()){const r=ri(e);if(null!==r&&!r.isEqual(t.field))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${t.field.toString()}'`);var n=ni(e);null!==n&&qd(0,t.field,n)}const r=function(e,t){for(const n of e.filters)if(0<=t.indexOf(n.op))return n.op;return null}(e,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new Cr(Nr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Cr(Nr.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}(e,h),h}(e._query,"where",t,e.firestore._databaseId,this.Uu,this.qu,this.Ku);return new Sl(e.firestore,e.converter,(e=e._query,t=e.filters.concat([t]),new Xs(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))}}class Rd extends Dd{constructor(e,t){super(),this.Uu=e,this.Gu=t,this.type="orderBy"}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Cr(Nr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Cr(Nr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Hs(t,n);return n=s,null!==ni(e=e)||null!==(r=ri(e))&&qd(0,r,n.field),s}(e._query,this.Uu,this.Gu);return new Sl(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Xs(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class Ld extends Dd{constructor(e,t,n){super(),this.type=e,this.ju=t,this.Qu=n}_apply(e){return new Sl(e.firestore,e.converter,ai(e._query,this.ju,this.Qu))}}class Md extends Dd{constructor(e,t,n){super(),this.type=e,this.Wu=t,this.zu=n}_apply(e){var t,n=Fd(e,this.type,this.Wu,this.zu);return new Sl(e.firestore,e.converter,(t=e._query,e=n,new Xs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Pd extends Dd{constructor(e,t,n){super(),this.type=e,this.Wu=t,this.zu=n}_apply(e){var t,n=Fd(e,this.type,this.Wu,this.zu);return new Sl(e.firestore,e.converter,(t=e._query,e=n,new Xs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Fd(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof bd)return function(e,t,n,r,s){if(!r)throw new Cr(Nr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of ii(e))if(n.field.isKeyField())i.push(Is(t,r.key));else{const e=r.data.field(n.field);if(is(e))throw new Cr(Nr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new zs(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var s=td(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new Cr(Nr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let h=0;h<s.length;h++){const u=s[h];if(o[h].field.isKeyField()){if("string"!=typeof u)throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!si(e)&&-1!==u.indexOf("/"))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(Yr.fromString(u));if(!ds.isDocumentKey(n))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new ds(n);a.push(Is(t,s))}else{const e=ld(n,r,u);a.push(e)}}return new zs(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}function Vd(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new Cr(Nr.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!si(t)&&-1!==n.indexOf("/"))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(Yr.fromString(n));if(!ds.isDocumentKey(r))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Is(e,new ds(r))}if(n instanceof El)return Is(e,n._key);throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${yl(n)}.`)}function Ud(e,t){if(!Array.isArray(e)||0===e.length)throw new Cr(Nr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new Cr(Nr.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function qd(e,t,n){if(!n.isEqual(t))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Bd{convertValue(e,t="none"){switch(gs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return rs(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ss(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Ar()}}convertObject(e,n){const r={};return zr(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Hl(rs(e.latitude),rs(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){var n=t.mapValue.fields.__previous_value__;return is(n)?e(n):n}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(os(e));default:return null}}convertTimestamp(e){var t=ns(e);return new Gr(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Yr.fromString(e);xr(Vo(n));const r=new hs(n.get(1),n.get(3)),s=new ds(n.popFirst(5));return r.isEqual(t)||Er(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function jd(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class Kd extends Bd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ql(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new El(this.firestore,null,t)}}class Gd{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=td(e)}set(e,t,n){this._verifyNotCommitted();const r=$d(e,this._firestore),s=jd(r.converter,t,n),i=nd(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Ni.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var s=$d(e,this._firestore);let i;return i="string"==typeof(t=m(t))||t instanceof $l?cd(this._dataReader,"WriteBatch.update",s._key,t,n,r):ud(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,Ni.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=$d(e,this._firestore);return this._mutations=this._mutations.concat(new qi(t._key,Ni.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Cr(Nr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function $d(e,t){if((e=m(e)).firestore!==t)throw new Cr(Nr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Qd extends Bd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ql(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new El(this.firestore,null,t)}}function zd(t){t=vl(t,El);const n=vl(t.firestore,Pl),e=Fl(n),r=new Qd(n);return function(e,t){const n=new Dr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.Us.ys(e,t))}(t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Cr(Nr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=ac(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await il(e),t,n)),n.promise}(e,t._key).then(e=>new _d(n,r,t._key,e,new Sd(null!==e&&e.hasLocalMutations,!0),t.converter))}function Hd(t){t=vl(t,Sl);const n=vl(t.firestore,Pl),e=Fl(n),r=new Qd(n);return function(e,t){const n=new Dr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await nu(e,t,!0),i=new Ec(t,s.Ks),o=i.Ic(s.documents),a=i.applyChanges(o,!1);n.resolve(a.snapshot)}catch(e){var r=ac(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await il(e),t,n)),n.promise}(e,t._query).then(e=>new xd(n,r,t,e))}function Wd(e,t,n){e=vl(e,El);var r=vl(e.firestore,Pl),s=jd(e.converter,t,n);return Zd(r,[nd(td(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,Ni.none())])}function Yd(e,t,n,...r){e=vl(e,El);var s=vl(e.firestore,Pl),i=td(s);let o;return o="string"==typeof(t=m(t))||t instanceof $l?cd(i,"updateDoc",e._key,t,n,r):ud(i,"updateDoc",e._key,t),Zd(s,[o.toMutation(e._key,Ni.exists(!0))])}function Xd(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||kl(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(kl(n[s])){const t=n[s];n[s]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[s+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[s+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let o,a,h;if(t instanceof El)a=vl(t.firestore,Pl),h=Zs(t._key.path),o={next:e=>{n[s]&&n[s](ef(a,t,e))},error:n[s+1],complete:n[s+2]};else{const u=vl(t,Sl);a=vl(u.firestore,Pl),h=u._query;const c=new Qd(a);o={next:e=>{n[s]&&n[s](new xd(a,c,u,e))},error:n[s+1],complete:n[s+2]},Cd(t._query)}return function(e,t,n,r){const s=new Wc(r),i=new pc(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>fc(await hl(e),i)),()=>{s.Jc(),e.asyncQueue.enqueueAndForget(async()=>gc(await hl(e),i))}}(Fl(a),h,i,o)}function Jd(e,t){return function(e,t){const n=new Wc(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Zo.add(t),t.next()}(await hl(e),n)),()=>{n.Jc(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Zo.delete(t)}(await hl(e),n))}}(Fl(e=vl(e,Pl)),kl(t)?t:{next:t})}function Zd(e,t){return function(e,t){const n=new Dr;return e.asyncQueue.enqueueAndForget(async()=>Nc(await al(e),t,n)),n.promise}(Fl(e),t)}function ef(e,t,n){var r=n.docs.get(t._key),s=new Qd(e);return new _d(e,s,t._key,r,new Sd(n.hasPendingWrites,n.fromCache),t.converter)}class tf extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=td(e)}get(e){const n=$d(e,this._firestore),r=new Kd(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Ar();const t=e[0];if(t.isFoundDocument())return new bd(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new bd(this._firestore,r,n._key,null,n.converter);throw Ar()})}set(e,t,n){var r=$d(e,this._firestore),s=jd(r.converter,t,n),s=nd(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){var s=$d(e,this._firestore),i="string"==typeof(t=m(t))||t instanceof $l?cd(this._dataReader,"Transaction.update",s._key,t,n,r):ud(this._dataReader,"Transaction.update",s._key,t);return this._transaction.update(s._key,i),this}delete(e){var t=$d(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=$d(e,this._firestore),n=new Qd(this._firestore);return super.get(e).then(e=>new _d(this._firestore,n,t._key,e._document,new Sd(!1,!1),t.converter))}}function nf(t,n){return function(t,n){const r=new Dr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await rl(t).then(e=>e.datastore);new Jc(t.asyncQueue,e,n,r).run()}),r.promise}(Fl(t=vl(t,Pl)),e=>n(new tf(t,e)))}Rl=Df.SDK_VERSION,wr=Rl,Df._registerComponent(new u("firestore",(e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=new Pl(n,new Lr(e.getProvider("auth-internal")),new Vr(e.getProvider("app-check-internal")));return t=Object.assign({useFetchStreams:!0},t),r._setSettings(t),r},"PUBLIC")),Df.registerVersion(yr,"3.4.5",void 0),Df.registerVersion(yr,"3.4.5","esm2017");function rf(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Cr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function sf(){if("undefined"==typeof Uint8Array)throw new Cr("unimplemented","Uint8Arrays are not available in this environment.")}function of(){if("undefined"==typeof atob)throw new Cr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class af{constructor(e){this._delegate=e}static fromBase64String(e){return of(),new af(Ql.fromBase64String(e))}static fromUint8Array(e){return sf(),new af(Ql.fromUint8Array(e))}toBase64(){return of(),this._delegate.toBase64()}toUint8Array(){return sf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function hf(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class uf{enableIndexedDbPersistence(e,t){return function(e,t){Gl(e=vl(e,Pl));var n=Fl(e),r=e._freezeSettings(),s=new zc;return Ul(n,s,new $c(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){Gl(e=vl(e,Pl));var t=Fl(e),n=e._freezeSettings(),r=new zc;return Ul(t,r,new Qc(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Cr(Nr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Dr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!ma.Vt())return Promise.resolve();var t=e+"main";await ma.delete(t)}(Kh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class cf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof hs||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Sr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){Tl(this._delegate,e,t,n)}enableNetwork(){return Bl(this._delegate)}disableNetwork(){return jl(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,gl("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return ql(this._delegate)}onSnapshotsInSync(e){return Jd(this._delegate,e)}get app(){if(!this._appCompat)throw new Cr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Sf(this,Al(this._delegate,e))}catch(e){throw pf(e,"collection()","Firestore.collection()")}}doc(e){try{return new mf(this,xl(this._delegate,e))}catch(e){throw pf(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new bf(this,function(e,t){if(e=vl(e,bl),fl("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Cr(Nr.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Sl(e,null,(t=t,new Xs(Yr.emptyPath(),t)))}(this._delegate,e))}catch(e){throw pf(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return nf(this._delegate,e=>t(new df(this,e)))}batch(){return Fl(this._delegate),new ff(new Gd(this._delegate,e=>Zd(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=Fl(t=vl(t,Pl)),r=new Ol,ll(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Kl(this._delegate,e).then(e=>e?new bf(this,e):null)}}class lf extends Bd{constructor(e){super(),this.firestore=e}convertBytes(e){return new af(new Ql(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return mf.forKey(t,this.firestore,null)}}class df{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new lf(e)}get(e){const t=_f(e);return this._delegate.get(t).then(e=>new wf(this._firestore,new _d(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=_f(e);return n?(rf("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=_f(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=_f(e);return this._delegate.delete(t),this}}class ff{constructor(e){this._delegate=e}set(e,t,n){var r=_f(e);return n?(rf("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=_f(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=_f(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class gf{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new Ad(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new If(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=gf.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let s=r.get(t);return s||(s=new gf(e,new lf(e),t),r.set(t,s)),s}}gf.INSTANCES=new WeakMap;class mf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new lf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Cr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new mf(t,new El(t._delegate,n,new ds(e)))}static forKey(e,t,n){return new mf(t,new El(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Sf(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Sf(this.firestore,Al(this._delegate,e))}catch(e){throw pf(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof El&&Nl(this._delegate,e)}set(e,t){t=rf("DocumentReference.set",t);try{return t?Wd(this._delegate,e,t):Wd(this._delegate,e)}catch(e){throw pf(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Yd(this._delegate,e):Yd(this._delegate,e,t,...n)}catch(e){throw pf(e,"updateDoc()","DocumentReference.update()")}}delete(){return Zd(vl((e=this._delegate).firestore,Pl),[new qi(e._key,Ni.none())]);var e}onSnapshot(...e){var t=yf(e),n=vf(e,e=>new wf(this.firestore,new _d(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Xd(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?zd:"server"===(null==e?void 0:e.source)?function(t){t=vl(t,El);const n=vl(t.firestore,Pl);return ul(Fl(n),t._key,{source:"server"}).then(e=>ef(n,t,e))}:function(t){t=vl(t,El);const n=vl(t.firestore,Pl);return ul(Fl(n),t._key).then(e=>ef(n,t,e))})(this._delegate),t.then(e=>new wf(this.firestore,new _d(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new mf(this.firestore,e?this._delegate.withConverter(gf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function pf(e,t,n){return e.message=e.message.replace(t,n),e}function yf(e){for(const t of e)if("object"==typeof t&&!hf(t))return t;return{}}function vf(e,t){var n;let r;return r=hf(e[0])?e[0]:hf(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class wf{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new mf(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Nd(this._delegate,e._delegate)}}class If extends wf{data(e){var t=this._delegate.data(e);return void 0!==t||Ar(),t}}class bf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new lf(e)}where(e,t,n){try{return new bf(this.firestore,kd(this._delegate,(r=n,s=t,i=Ed("where",e),new Od(i,s,r))))}catch(e){throw pf(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new bf(this.firestore,kd(this._delegate,([n,r="asc"]=[e,t],s=r,i=Ed("orderBy",n),new Rd(i,s))))}catch(e){throw pf(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new bf(this.firestore,kd(this._delegate,(wl("limit",t=e),new Ld("limit",t,"F"))))}catch(e){throw pf(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new bf(this.firestore,kd(this._delegate,(wl("limitToLast",t=e),new Ld("limitToLast",t,"L"))))}catch(e){throw pf(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new bf(this.firestore,kd(this._delegate,function(...e){return new Md("startAt",e,!0)}(...e)))}catch(e){throw pf(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new bf(this.firestore,kd(this._delegate,function(...e){return new Md("startAfter",e,!1)}(...e)))}catch(e){throw pf(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new bf(this.firestore,kd(this._delegate,function(...e){return new Pd("endBefore",e,!1)}(...e)))}catch(e){throw pf(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new bf(this.firestore,kd(this._delegate,function(...e){return new Pd("endAt",e,!0)}(...e)))}catch(e){throw pf(e,"endAt()","Query.endAt()")}}isEqual(e){return Cl(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?Hd:"server"===(null==e?void 0:e.source)?function(t){t=vl(t,Sl);const n=vl(t.firestore,Pl),e=Fl(n),r=new Qd(n);return cl(e,t._query,{source:"server"}).then(e=>new xd(n,r,t,e))}:function(t){t=vl(t,Sl);const n=vl(t.firestore,Pl),e=Fl(n),r=new Qd(n);return Cd(t._query),cl(e,t._query).then(e=>new xd(n,r,t,e))})(this._delegate),t.then(e=>new Ef(this.firestore,new xd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=yf(e),n=vf(e,e=>new Ef(this.firestore,new xd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Xd(this._delegate,t,n)}withConverter(e){return new bf(this.firestore,e?this._delegate.withConverter(gf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Tf{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new If(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Ef{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new bf(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new If(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Tf(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new If(this._firestore,e))})}isEqual(e){return Nd(this._delegate,e._delegate)}}class Sf extends bf{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new mf(this.firestore,e):null}doc(e){try{return void 0===e?new mf(this.firestore,xl(this._delegate)):new mf(this.firestore,xl(this._delegate,e))}catch(e){throw pf(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=vl(e.firestore,Pl),r=xl(e),s=jd(e.converter,t);return Zd(n,[nd(td(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,Ni.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new mf(this.firestore,e))}isEqual(e){return Nl(this._delegate,e._delegate)}withConverter(e){return new Sf(this.firestore,e?this._delegate.withConverter(gf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function _f(e){return vl(e,El)}const Af={Firestore:cf,GeoPoint:Hl,Timestamp:Gr,Blob:af,Transaction:df,WriteBatch:ff,DocumentReference:mf,DocumentSnapshot:wf,Query:bf,QueryDocumentSnapshot:If,QuerySnapshot:Ef,CollectionReference:Sf,FieldPath:class xf{constructor(...e){this._delegate=new $l(...e)}static documentId(){return new xf(Jr.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof $l&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class Nf{constructor(e){this._delegate=e}static serverTimestamp(){const e=new id("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new Nf(e)}static delete(){const e=new rd("deleteField");return e._methodName="FieldValue.delete",new Nf(e)}static arrayUnion(...e){const t=function(...e){return new od("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new Nf(t)}static arrayRemove(...e){const t=function(...e){return new ad("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new Nf(t)}static increment(e){const t=new hd("increment",e);return t._methodName="FieldValue.increment",new Nf(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,Ir.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Ll=t.default,Ml=(e,t)=>new cf(e,t,new uf),Ll.INTERNAL.registerComponent(new u("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return Ml(t,n)},"PUBLIC").setServiceProps(Object.assign({},Af))),Ll.registerVersion("@firebase/firestore-compat","0.1.14")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
